<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Notification Management - Lake Illawong</title>
    <style>
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #f8fafc; 
            line-height: 1.6; 
            color: #334155;
        }
        
        .hidden { display: none !important; }
        
        .container { 
            padding: 20px; 
            max-width: 1000px; 
            margin: 0 auto; 
        }
        
        /* Header */
        .header {
            margin-bottom: 30px;
            text-align: center;
        }
        
        .header h1 {
            color: #1e293b;
            margin-bottom: 8px;
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .header p {
            color: #64748b;
            font-size: 0.95rem;
        }
        
        .save-status {
            margin-top: 12px;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            display: inline-block;
        }
        
        .save-status.success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .save-status.error {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .save-status.loading {
            background: #fef3c7;
            color: #92400e;
        }
        
        /* Section Styling */
        .section {
            margin-bottom: 40px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .section-title {
            color: #1e293b;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .add-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .add-btn:hover {
            background: #2563eb;
        }
        
        .add-btn.green {
            background: #10b981;
        }
        
        .add-btn.green:hover {
            background: #059669;
        }
        
        /* Table Styling */
        .table-container {
            background: white;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .table-header {
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            display: grid;
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }
        
        .table-header.maintenance-header {
            grid-template-columns: 1fr 2fr;
        }
        
        .table-header.zone-header {
            grid-template-columns: 1fr 1.5fr 2fr;
        }
        
        .table-header.inactive-header {
            grid-template-columns: 1.5fr 2.5fr 1fr 1fr 1fr;
        }
        
        .header-cell {
            padding: 12px 16px;
        }
        
        .table-row {
            border-bottom: 1px solid #f1f5f9;
            display: grid;
            align-items: center;
        }
        
        .table-row.maintenance-row {
            grid-template-columns: 1fr 2fr;
        }
        
        .table-row.zone-row {
            grid-template-columns: 1fr 1.5fr 2fr;
        }
        
        .table-row.inactive-row {
            grid-template-columns: 1.5fr 2.5fr 1fr 1fr 1fr;
        }
        
        .table-cell {
            padding: 8px 12px;
            min-height: 20px;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        
        .table-cell.editing {
            border-color: #3b82f6;
            background: white;
            cursor: text;
        }
        
        .table-cell.empty {
            background: #f8fafc;
            color: #9ca3af;
        }
        
        .table-cell:hover:not(.editing) {
            background: #f1f5f9;
        }
        
        .edit-input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #3b82f6;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            font-family: inherit;
        }
        
        .edit-input:focus {
            outline: none;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
        }
        
        .action-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            font-weight: 500;
        }
        
        .action-btn.delete {
            background: #ef4444;
        }
        
        .action-btn:hover {
            opacity: 0.9;
        }
        
        /* Info Text */
        .info-text {
            font-size: 0.8rem;
            color: #64748b;
            margin-top: 8px;
            font-style: italic;
        }
        
        /* Inactive Section */
        .inactive-section {
            margin-top: 40px;
        }
        
        .inactive-table {
            background: #fefce8;
            border: 1px solid #fbbf24;
        }
        
        .inactive-header {
            background: #fef3c7;
            border-bottom: 1px solid #f59e0b;
            color: #92400e;
        }
        
        /* Instructions */
        .instructions {
            margin-top: 30px;
            padding: 16px;
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 8px;
        }
        
        .instructions h4 {
            color: #0c4a6e;
            margin-bottom: 8px;
            font-size: 0.95rem;
            font-weight: 600;
        }
        
        .instructions ul {
            color: #0369a1;
            font-size: 0.85rem;
            padding-left: 16px;
        }
        
        .instructions li {
            margin-bottom: 4px;
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(248, 250, 252, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .loading-content {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üìß Email Notification Management</h1>
            <p>Manage maintenance team and zone representative email lists</p>
            <div id="saveStatus" class="save-status hidden"></div>
        </div>

        <!-- Maintenance Team Section -->
        <div class="section">
            <div class="section-header">
                <h3 class="section-title">üîß Maintenance Team</h3>
                <button class="add-btn" onclick="addMaintenancePerson()">+ Add New Person</button>
            </div>
            
            <div class="table-container">
                <div class="table-header maintenance-header">
                    <div class="header-cell">Name</div>
                    <div class="header-cell">Email Address</div>
                </div>
                <div id="maintenanceTeamList">
                    <!-- Populated dynamically -->
                </div>
            </div>
            
            <p class="info-text">
                ‚ÑπÔ∏è Syncs with MtceTeamEmailList Named Range ‚Ä¢ Remove email to exclude from notifications
            </p>
        </div>

        <!-- Zone Representatives Section -->
        <div class="section">
            <div class="section-header">
                <h3 class="section-title">üèòÔ∏è Zone Representatives</h3>
                <button class="add-btn green" onclick="addZoneRep()">+ Add New Zone Rep</button>
            </div>
            
            <div class="table-container">
                <div class="table-header zone-header">
                    <div class="header-cell">Zone</div>
                    <div class="header-cell">Name</div>
                    <div class="header-cell">Email Address</div>
                </div>
                <div id="zoneRepsList">
                    <!-- Populated dynamically -->
                </div>
            </div>
            
            <p class="info-text">
                ‚ÑπÔ∏è Syncs with ZoneRepsEmailList Named Range (Zone | Name | Email) ‚Ä¢ Remove email to exclude from notifications
            </p>
        </div>

        <!-- Inactive Contacts Section -->
        <div id="inactiveSection" class="section inactive-section hidden">
            <div class="section-header">
                <h3 class="section-title">üìã Inactive Contacts (Reference)</h3>
            </div>
            
            <div class="table-container inactive-table">
                <div class="table-header inactive-header">
                    <div class="header-cell">Name/Zone</div>
                    <div class="header-cell">Email</div>
                    <div class="header-cell">Type</div>
                    <div class="header-cell">Removed</div>
                    <div class="header-cell">Actions</div>
                </div>
                <div id="inactiveContactsList">
                    <!-- Populated dynamically -->
                </div>
            </div>
            
            <p class="info-text">
                üí° Contacts moved here when email removed ‚Ä¢ Click "Restore" to add back to active list
            </p>
        </div>

        <!-- Instructions -->
        <div class="instructions">
            <h4>üí° How to Use</h4>
            <ul>
                <li><strong>Edit:</strong> Click any name or email to edit in place</li>
                <li><strong>Replace person:</strong> Edit Ben's row to become the new person</li>
                <li><strong>Temporary coverage:</strong> Change Ben's email to your email</li>
                <li><strong>Remove from notifications:</strong> Clear the email field</li>
                <li><strong>Add new:</strong> Use the + buttons to add new people</li>
            </ul>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div>Loading email lists...</div>
        </div>
    </div>

    <script>
        // Configuration
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycby7gsG4aokrVFIiEKSx_hNyLMDQHDLRpnA4qQhE7bfy6Gmdvn1NBwtHNCJXcRauTveA/exec';
        
        // Global State
        let maintenanceTeam = [];
        let zoneReps = [];
        let inactiveContacts = [];
        let editingCell = null;
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìß Email Notification Management - Starting...');
            loadEmailLists();
        });
        
        // Load email lists from backend
        async function loadEmailLists() {
            try {
                showLoading(true);
                
                // Load maintenance team
console.log('üìã Loading maintenance team...');
const maintenanceResponse = await makeRequest('getNamedRangeData', { rangeName: 'MtceTeamEmailList' });

// ADD DEBUG HERE:
console.log('üîç RAW maintenance response:', maintenanceResponse);

if (maintenanceResponse.success) {
    console.log('üîç Maintenance data structure:', maintenanceResponse.data);
    maintenanceTeam = maintenanceResponse.data.map((item, index) => ({
        id: index + 1,
        name: item.name || '',
        email: item.email || ''
    }));
    console.log('‚úÖ Maintenance team loaded:', maintenanceTeam.length, 'people');
}

// Load zone representatives
console.log('üìã Loading zone representatives...');
const zoneResponse = await makeRequest('getNamedRangeData', { rangeName: 'ZoneRepEmailList' });

// ADD DEBUG HERE TOO:
console.log('üîç RAW zone response:', zoneResponse);

if (zoneResponse.success) {
    console.log('üîç Zone data structure:', zoneResponse.data);
    zoneReps = zoneResponse.data.map((item, index) => ({
        id: index + 1,
        zone: item.zone || '',
        name: item.name || '',
        email: item.email || ''
    }));
    console.log('‚úÖ Zone representatives loaded:', zoneReps.length, 'zones');
}
                
                // Initialize with some sample inactive contacts for demo
                inactiveContacts = [
                    { name: 'John Smith', email: 'john.smith@example.com', type: 'maintenance', removedDate: '2024-01-15' },
                    { name: 'Mary Johnson', email: 'mary.johnson@example.com', type: 'zoneRep', zone: 'Zone 5', removedDate: '2024-02-01' }
                ];
                
                renderAllLists();
                
            } catch (error) {
                console.error('‚ùå Error loading email lists:', error);
                showSaveStatus('Failed to load email lists', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // Render all lists
        function renderAllLists() {
            renderMaintenanceTeam();
            renderZoneReps();
            renderInactiveContacts();
        }
        
        // Render maintenance team list
        function renderMaintenanceTeam() {
            const container = document.getElementById('maintenanceTeamList');
            container.innerHTML = '';
            
            maintenanceTeam.forEach(person => {
                const row = document.createElement('div');
                row.className = 'table-row maintenance-row';
                
                row.innerHTML = `
                    <div class="table-cell ${!person.name ? 'empty' : ''}" 
                         onclick="editCell('maintenance', ${person.id}, 'name')"
                         id="maintenance-${person.id}-name">
                        ${person.name || 'Enter name...'} ${person.name ? '‚úèÔ∏è' : ''}
                    </div>
                    <div class="table-cell ${!person.email ? 'empty' : ''}" 
                         onclick="editCell('maintenance', ${person.id}, 'email')"
                         id="maintenance-${person.id}-email">
                        ${person.email || 'Enter email address...'} ${person.email ? '‚úèÔ∏è' : ''}
                    </div>
                `;
                
                container.appendChild(row);
            });
        }
        
        // Render zone representatives list
        function renderZoneReps() {
            const container = document.getElementById('zoneRepsList');
            container.innerHTML = '';
            
            zoneReps.forEach(rep => {
                const row = document.createElement('div');
                row.className = 'table-row zone-row';
                
                row.innerHTML = `
                    <div class="table-cell ${!rep.zone ? 'empty' : ''}" 
                         onclick="editCell('zoneRep', ${rep.id}, 'zone')"
                         id="zoneRep-${rep.id}-zone">
                        ${rep.zone || 'Enter zone...'} ${rep.zone ? '‚úèÔ∏è' : ''}
                    </div>
                    <div class="table-cell ${!rep.name ? 'empty' : ''}" 
                         onclick="editCell('zoneRep', ${rep.id}, 'name')"
                         id="zoneRep-${rep.id}-name">
                        ${rep.name || 'Enter name...'} ${rep.name ? '‚úèÔ∏è' : ''}
                    </div>
                    <div class="table-cell ${!rep.email ? 'empty' : ''}" 
                         onclick="editCell('zoneRep', ${rep.id}, 'email')"
                         id="zoneRep-${rep.id}-email">
                        ${rep.email || 'Enter email address...'} ${rep.email ? '‚úèÔ∏è' : ''}
                    </div>
                `;
                
                container.appendChild(row);
            });
        }
        
        // Render inactive contacts
        function renderInactiveContacts() {
            const section = document.getElementById('inactiveSection');
            const container = document.getElementById('inactiveContactsList');
            
            if (inactiveContacts.length === 0) {
                section.classList.add('hidden');
                return;
            }
            
            section.classList.remove('hidden');
            container.innerHTML = '';
            
            inactiveContacts.forEach((contact, index) => {
                const row = document.createElement('div');
                row.className = 'table-row inactive-row';
                
                row.innerHTML = `
                    <div class="header-cell">${contact.name}</div>
                    <div class="header-cell" style="font-family: monospace;">${contact.email}</div>
                    <div class="header-cell">${contact.type === 'maintenance' ? 'üîß Maintenance' : 'üèòÔ∏è Zone Rep'}</div>
                    <div class="header-cell">${contact.removedDate}</div>
                    <div class="action-buttons">
                        <button class="action-btn" onclick="restoreContact(${index})">‚Ü©Ô∏è Restore</button>
                        <button class="action-btn delete" onclick="removeFromInactive(${index})">üóëÔ∏è Delete</button>
                    </div>
                `;
                
                container.appendChild(row);
            });
        }
        
        // Edit cell functionality
        function editCell(type, id, field) {
            if (editingCell) {
                // Save current edit first
                saveCurrentEdit();
            }
            
            const cellId = `${type}-${id}-${field}`;
            const cell = document.getElementById(cellId);
            
            if (!cell) return;
            
            const currentValue = getCurrentValue(type, id, field);
            
            // Create input
            const input = document.createElement('input');
            input.type = field === 'email' ? 'email' : 'text';
            input.className = 'edit-input';
            input.value = currentValue;
            input.placeholder = getPlaceholder(field);
            
            // Replace cell content
            cell.innerHTML = '';
            cell.appendChild(input);
            cell.classList.add('editing');
            
            // Focus and select
            input.focus();
            input.select();
            
            // Save on Enter or blur
            input.addEventListener('blur', () => saveEdit(type, id, field, input.value));
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    saveEdit(type, id, field, input.value);
                } else if (e.key === 'Escape') {
                    cancelEdit(cellId);
                }
            });
            
            editingCell = cellId;
        }
        
        // Get current value
        function getCurrentValue(type, id, field) {
            if (type === 'maintenance') {
                const person = maintenanceTeam.find(p => p.id === id);
                return person ? (person[field] || '') : '';
            } else {
                const rep = zoneReps.find(r => r.id === id);
                return rep ? (rep[field] || '') : '';
            }
        }
        
        // Get placeholder text
        function getPlaceholder(field) {
            switch (field) {
                case 'name': return 'Enter name...';
                case 'email': return 'Enter email address...';
                case 'zone': return 'Enter zone...';
                default: return 'Enter value...';
            }
        }
        
        // Save edit
        async function saveEdit(type, id, field, value) {
            try {
                const oldValue = getCurrentValue(type, id, field);
                
                // Check if email is being cleared (move to inactive)
                if (field === 'email' && oldValue && !value) {
                    await moveToInactive(type, id, oldValue);
                }
                
                // Update local data
                if (type === 'maintenance') {
                    const person = maintenanceTeam.find(p => p.id === id);
                    if (person) person[field] = value;
                } else {
                    const rep = zoneReps.find(r => r.id === id);
                    if (rep) rep[field] = value;
                }
                
                // Save to backend
                await saveToBackend(type, id);
                
                // Re-render
                renderAllLists();
                
                showSaveStatus('‚úÖ Saved', 'success');
                
            } catch (error) {
                console.error('‚ùå Error saving:', error);
                showSaveStatus('‚ùå Save failed', 'error');
                // Restore previous render
                renderAllLists();
            }
            
            editingCell = null;
        }
        
        // Move contact to inactive when email cleared
        async function moveToInactive(type, id, email) {
            const contact = type === 'maintenance' 
                ? maintenanceTeam.find(p => p.id === id)
                : zoneReps.find(r => r.id === id);
                
            if (contact) {
                const inactiveContact = {
                    name: contact.name || (contact.zone || 'Unknown'),
                    email: email,
                    type: type,
                    zone: contact.zone,
                    removedDate: new Date().toISOString().split('T')[0]
                };
                
                inactiveContacts.push(inactiveContact);
            }
        }
        
        // Cancel edit
        function cancelEdit(cellId) {
            editingCell = null;
            renderAllLists();
        }
        
        // Save current edit if any
        function saveCurrentEdit() {
            // Implementation would save any current edit
            editingCell = null;
        }
        
        // Add new maintenance person
        function addMaintenancePerson() {
            const newId = Math.max(...maintenanceTeam.map(p => p.id), 0) + 1;
            maintenanceTeam.push({ id: newId, name: '', email: '' });
            renderMaintenanceTeam();
            
            // Focus on name field
            setTimeout(() => {
                editCell('maintenance', newId, 'name');
            }, 100);
        }
        
        // Add new zone representative
        function addZoneRep() {
            const newId = Math.max(...zoneReps.map(r => r.id), 0) + 1;
            zoneReps.push({ id: newId, zone: '', name: '', email: '' });
            renderZoneReps();
            
            // Focus on zone field
            setTimeout(() => {
                editCell('zoneRep', newId, 'zone');
            }, 100);
        }
        
        // Restore contact from inactive
        function restoreContact(index) {
            const contact = inactiveContacts[index];
            
            if (contact.type === 'maintenance') {
                const newId = Math.max(...maintenanceTeam.map(p => p.id), 0) + 1;
                maintenanceTeam.push({ id: newId, name: contact.name, email: contact.email });
            } else {
                const newId = Math.max(...zoneReps.map(r => r.id), 0) + 1;
                zoneReps.push({ 
                    id: newId, 
                    zone: contact.zone || contact.name, 
                    name: contact.name, 
                    email: contact.email 
                });
            }
            
            // Remove from inactive
            inactiveContacts.splice(index, 1);
            
            renderAllLists();
            showSaveStatus('‚úÖ Contact restored', 'success');
        }
        
        // Remove from inactive permanently
        function removeFromInactive(index) {
            inactiveContacts.splice(index, 1);
            renderInactiveContacts();
        }
        
        // Save to backend
        async function saveToBackend(type, id) {
            // This would call your V2.3 backend to update the Named Ranges
            const rangeName = type === 'maintenance' ? 'MtceTeamEmailList' : 'ZoneRepEmailList';
            
            console.log(`üíæ Saving ${type} ${id} to ${rangeName}`);
            
            // For now, just simulate success
            return Promise.resolve();
        }
        
        // Show/hide loading overlay
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }
        
        // Show save status
        function showSaveStatus(message, type) {
            const statusDiv = document.getElementById('saveStatus');
            statusDiv.textContent = message;
            statusDiv.className = `save-status ${type}`;
            statusDiv.classList.remove('hidden');
            
            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 3000);
        }
        
        // Make JSONP request to backend
        async function makeRequest(action, params = {}) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                const script = document.createElement('script');
                const queryParams = new URLSearchParams({ action, callback: callbackName, ...params });
                
                script.src = `${WEB_APP_URL}?${queryParams}`;
                
                window[callbackName] = function(response) {
                    document.head.removeChild(script);
                    delete window[callbackName];
                    resolve(response);
                };
                
                script.onerror = function() {
                    document.head.removeChild(script);
                    delete window[callbackName];
                    reject(new Error('Network request failed'));
                };
                
                document.head.appendChild(script);
                
                // Timeout after 10 seconds
                setTimeout(() => {
                    if (window[callbackName]) {
                        document.head.removeChild(script);
                        delete window[callbackName];
                        reject(new Error('Request timeout'));
                    }
                }, 10000);
            });
        }
        
        console.log('üìß Email Notification Management - Ready!');
    </script>
</body>
</html>
