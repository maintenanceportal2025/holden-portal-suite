<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal - Enhanced Dropdown Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 1rem 2rem;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .back-btn {
            background: linear-gradient(135deg, #6b73ff 0%, #000dff 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(107, 115, 255, 0.3);
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(107, 115, 255, 0.4);
        }

        .main-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .page-title {
            text-align: center;
            color: white;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .page-subtitle {
            text-align: center;
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1rem;
            margin-bottom: 3rem;
        }

        /* Enhanced Tab System */
        .tab-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .tab-navigation {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            background: #f8fafc;
            padding: 0.5rem;
            border-radius: 12px;
        }

        .tab-btn {
            flex: 1;
            padding: 1rem 2rem;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #64748b;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Entity Management Sections */
        .entity-section {
            background: #f8fafc;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid #e2e8f0;
        }

        .entity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .entity-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .entity-badge {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* Enhanced Table Structure */
        .entity-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }

        .table-header {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            display: grid;
            padding: 1rem;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .dropdown-header {
            grid-template-columns: 0.8fr 2fr 1fr 1fr;
        }

        .unit-header {
            grid-template-columns: 1fr 2fr 0.8fr 1fr;
        }

        .staff-header {
            grid-template-columns: 2fr 2fr 1fr 1fr;
        }

        .table-row {
            display: grid;
            padding: 1rem;
            border-bottom: 1px solid #f1f5f9;
            transition: all 0.2s ease;
            align-items: center;
        }

        .table-row:hover {
            background: #f8fafc;
        }

        .table-row:last-child {
            border-bottom: none;
        }

        /* Editable Fields */
        .editable-field {
            padding: 0.5rem 0.75rem;
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 2.5rem;
            display: flex;
            align-items: center;
            background: transparent;
        }

        .editable-field:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }

        .editable-field.editing {
            background: white;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .editable-input {
            width: 100%;
            border: none;
            outline: none;
            font-family: inherit;
            font-size: inherit;
            background: transparent;
        }

        /* Status Indicators */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-active {
            background: #dcfce7;
            color: #166534;
        }

        .status-inactive {
            background: #fef2f2;
            color: #991b1b;
        }

        .status-system {
            background: #ddd6fe;
            color: #5b21b6;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .action-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }

        .edit-btn {
            background: #3b82f6;
            color: white;
        }

        .edit-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .delete-btn {
            background: #ef4444;
            color: white;
        }

        .delete-btn:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        .add-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        /* Enhanced Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: all 0.3s ease;
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .modal-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        .modal-btn {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .modal-btn.secondary {
            background: #f1f5f9;
            color: #64748b;
        }

        .modal-btn.primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
        }

        /* Enhanced Toast System */
        .toast-container {
            position: fixed;
            top: 2rem;
            right: 2rem;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .toast {
            background: white;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            border-left: 4px solid;
            max-width: 400px;
            transform: translateX(100%);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            border-left-color: #10b981;
        }

        .toast.error {
            border-left-color: #ef4444;
        }

        .toast.warning {
            border-left-color: #f59e0b;
        }

        .toast-icon {
            font-size: 1.5rem;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .toast-message {
            color: #64748b;
            font-size: 0.9rem;
        }

        /* Loading States */
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1500;
        }

        .loading-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            text-align: center;
        }

        .hidden {
            display: none;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-container {
                padding: 0 1rem;
            }

            .table-header, .table-row {
                font-size: 0.8rem;
                padding: 0.75rem;
            }

            .dropdown-header, .unit-header, .staff-header {
                grid-template-columns: 1fr;
            }

            .table-row {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .action-buttons {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <button class="back-btn" onclick="goBackToAdminMain()">
                ← Back to Admin Portal
            </button>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <span id="lastUpdated" style="color: #64748b; font-size: 0.9rem;"></span>
                <button class="back-btn" onclick="refreshAllData()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    🔄 Refresh Data
                </button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <h1 class="page-title">🎛️ Enhanced Dropdown Manager</h1>
        <p class="page-subtitle">Unified entity management with EmailNotification schema architecture</p>

        <!-- Tab Container -->
        <div class="tab-container">
            <!-- Tab Navigation -->
            <div class="tab-navigation">
                <button class="tab-btn active" onclick="switchTab('dropdowns')" id="dropdownsTabBtn">
                    📋 Simple Dropdowns
                </button>
                <button class="tab-btn" onclick="switchTab('units')" id="unitsTabBtn">
                    🏠 Unit Entities
                </button>
                <button class="tab-btn" onclick="switchTab('staff')" id="staffTabBtn">
                    👥 Staff Entities
                </button>
            </div>

            <!-- Simple Dropdowns Tab -->
            <div id="dropdownsContent" class="tab-content active">
                
                <!-- Status Management -->
                <div class="entity-section">
                    <div class="entity-header">
                        <div class="entity-title">
                            📋 Status Options
                            <span class="entity-badge" id="statusCount">0 items</span>
                        </div>
                        <button class="add-btn" onclick="openEntityModal('status', null)">+ Add Status</button>
                    </div>
                    
                    <div class="entity-table">
                        <div class="table-header dropdown-header">
                            <div>Priority</div>
                            <div>Status Name</div>
                            <div>Usage</div>
                            <div>Actions</div>
                        </div>
                        <div id="statusList">
                            <!-- Populated dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Priority Management -->
                <div class="entity-section">
                    <div class="entity-header">
                        <div class="entity-title">
                            ⚡ Priority Levels
                            <span class="entity-badge" id="priorityCount">0 items</span>
                        </div>
                        <button class="add-btn" onclick="openEntityModal('priority', null)">+ Add Priority</button>
                    </div>
                    
                    <div class="entity-table">
                        <div class="table-header dropdown-header">
                            <div>Level</div>
                            <div>Priority Name</div>
                            <div>Usage</div>
                            <div>Actions</div>
                        </div>
                        <div id="priorityList">
                            <!-- Populated dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Category Management -->
                <div class="entity-section">
                    <div class="entity-header">
                        <div class="entity-title">
                            📂 Categories
                            <span class="entity-badge" id="categoryCount">0 items</span>
                        </div>
                        <button class="add-btn" onclick="openEntityModal('category', null)">+ Add Category</button>
                    </div>
                    
                    <div class="entity-table">
                        <div class="table-header dropdown-header">
                            <div>Order</div>
                            <div>Category Name</div>
                            <div>Usage</div>
                            <div>Actions</div>
                        </div>
                        <div id="categoryList">
                            <!-- Populated dynamically -->
                        </div>
                    </div>
                </div>

            </div>

            <!-- Unit Entities Tab -->
            <div id="unitsContent" class="tab-content">
                
                <div class="entity-section">
                    <div class="entity-header">
                        <div class="entity-title">
                            🏠 Unit Directory
                            <span class="entity-badge" id="unitCount">0 units</span>
                        </div>
                        <button class="add-btn" onclick="openEntityModal('unit', null)">+ Add Unit</button>
                    </div>
                    
                    <div class="entity-table">
                        <div class="table-header unit-header">
                            <div>Unit Number</div>
                            <div>Primary Resident</div>
                            <div>Zone</div>
                            <div>Actions</div>
                        </div>
                        <div id="unitList">
                            <!-- Populated dynamically -->
                        </div>
                    </div>
                </div>

            </div>

            <!-- Staff Entities Tab -->
            <div id="staffContent" class="tab-content">
                
                <div class="entity-section">
                    <div class="entity-header">
                        <div class="entity-title">
                            👥 Maintenance Team
                            <span class="entity-badge" id="staffCount">0 staff</span>
                        </div>
                        <button class="add-btn" onclick="openEntityModal('staff', null)">+ Add Staff</button>
                    </div>
                    
                    <div class="entity-table">
                        <div class="table-header staff-header">
                            <div>Staff Name</div>
                            <div>Email Address</div>
                            <div>Status</div>
                            <div>Actions</div>
                        </div>
                        <div id="staffList">
                            <!-- Populated dynamically -->
                        </div>
                    </div>
                </div>

            </div>

        </div>
    </div>

    <!-- Enhanced Modal -->
    <div id="entityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Add Item</h3>
                <p id="modalSubtitle" style="color: #64748b;"></p>
            </div>
            <form id="entityForm">
                <div id="modalFields">
                    <!-- Dynamic fields populated here -->
                </div>
                <div class="modal-actions">
                    <button type="button" class="modal-btn secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="modal-btn primary" id="modalSubmitBtn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div>Processing request...</div>
        </div>
    </div>

    <script>
        // Configuration - Updated to match EmailNotification pattern
        const MAINTENANCE_API_URL = 'https://script.google.com/macros/s/AKfycbztwt4c9-rAfrZUQT9_fRi3Lwt23Mcc9ygETGAp59NZiwlbkeTjr9SBgLJXbUUtQ7R7/exec';
        const EMAIL_NOTIFICATION_API_URL = 'https://script.google.com/macros/s/AKfycby7gsG4aokrVFIiEKSx_hNyLMDQHDLRpnA4qQhE7bfy6Gmdvn1NBwtHNCJXcRauTveA/exec';
        
        // Global state - Enhanced with entity management
        let currentTab = 'dropdowns';
        let currentEditItem = null;
        let allData = {
            dropdowns: {},
            units: [],
            staff: [],
            categories: []
        };

        // Initialize system
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🎛️ Enhanced Dropdown Manager - Starting...');
            setupEventListeners();
            loadAllData();
        });

        function setupEventListeners() {
            // Tab switching
            document.getElementById('dropdownsTabBtn').addEventListener('click', () => switchTab('dropdowns'));
            document.getElementById('unitsTabBtn').addEventListener('click', () => switchTab('units'));
            document.getElementById('staffTabBtn').addEventListener('click', () => switchTab('staff'));
            
            // Modal
            document.getElementById('entityForm').addEventListener('submit', handleModalSubmit);
            document.getElementById('entityModal').addEventListener('click', function(e) {
                if (e.target === this) closeModal();
            });
        }

        // Enhanced tab switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`${tabName}TabBtn`).classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}Content`).classList.add('active');
            
            currentTab = tabName;
            console.log(`📋 Switched to ${tabName} tab`);
        }

        // Enhanced data loading with multiple sources
        async function loadAllData() {
            try {
                showLoading(true);
                
                // Load dropdown data (existing functionality)
                await loadDropdownData();
                
                // Load entity data (new EmailNotification schema pattern)
                await loadEntityData();
                
                // Render all sections
                renderAllSections();
                
                showToast('success', 'Data Loaded', 'All system data loaded successfully');
                updateLastUpdatedTime();
                
            } catch (error) {
                console.error('❌ Error loading data:', error);
                showToast('error', 'Load Failed', 'Failed to load system data');
            } finally {
                showLoading(false);
            }
        }

        // Load dropdown data (existing pattern)
        async function loadDropdownData() {
            console.log('📋 Loading dropdown options...');
            
            const response = await makeRequest(MAINTENANCE_API_URL, 'getDropdownOptions', {});
            
            if (response.success) {
                allData.dropdowns = response.options || {};
                console.log('✅ Dropdown data loaded:', Object.keys(allData.dropdowns));
            } else {
                throw new Error('Failed to load dropdown data');
            }
        }

        // Load entity data (EmailNotification schema pattern)
        async function loadEntityData() {
            console.log('👥 Loading entity data...');
            
            try {
                // Load staff from named range (EmailNotification pattern)
                const staffResponse = await makeRequest(EMAIL_NOTIFICATION_API_URL, 'getNamedRangeData', {
                    rangeName: 'MtceTeamEmailList'
                });
                
                if (staffResponse.success) {
                    allData.staff = staffResponse.data.map((item, index) => ({
                        id: index + 1,
                        name: item.name || '',
                        email: item.email || '',
                        status: item.email ? 'active' : 'inactive'
                    }));
                }

                // Load unit data (if available)
                // This would be implemented based on your UnitList structure
                
                console.log('✅ Entity data loaded');
                
            } catch (error) {
                console.log('⚠️ Entity data loading failed:', error.message);
                // Continue with dropdown-only functionality
            }
        }

        // Enhanced rendering system
        function renderAllSections() {
            // Render dropdown sections
            renderDropdownSection('Status', 'statusList', 'statusCount');
            renderDropdownSection('Priority', 'priorityList', 'priorityCount');
            renderDropdownSection('Category', 'categoryList', 'categoryCount');
            
            // Render entity sections
            renderStaffSection();
            renderUnitSection();
        }

        // Render dropdown sections (enhanced existing functionality)
        function renderDropdownSection(type, listId, countId) {
            const container = document.getElementById(listId);
            const countElement = document.getElementById(countId);
            
            if (!container) return;
            
            const items = allData.dropdowns[type] || [];
            
            // Update count
            if (countElement) {
                countElement.textContent = `${items.length} items`;
            }
            
            // Render items
            container.innerHTML = items.map((item, index) => `
                <div class="table-row dropdown-header">
                    <div>${index + 1}</div>
                    <div class="editable-field" onclick="editInline('${type}', ${index}, this)">${item}</div>
                    <div><span class="status-indicator status-active">Active</span></div>
                    <div class="action-buttons">
                        <button class="action-btn edit-btn" onclick="openEntityModal('${type.toLowerCase()}', ${index})">Edit</button>
                        <button class="action-btn delete-btn" onclick="deleteItem('${type}', '${item}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Render staff section (EmailNotification schema pattern)
        function renderStaffSection() {
            const container = document.getElementById('staffList');
            const countElement = document.getElementById('staffCount');
            
            if (!container) return;
            
            const staff = allData.staff || [];
            
            // Update count
            if (countElement) {
                countElement.textContent = `${staff.length} staff`;
            }
            
            // Render staff
            container.innerHTML = staff.map(person => `
                <div class="table-row staff-header">
                    <div class="editable-field" onclick="editStaffField(${person.id}, 'name', this)">${person.name || 'Click to edit'}</div>
                    <div class="editable-field" onclick="editStaffField(${person.id}, 'email', this)">${person.email || 'Click to edit'}</div>
                    <div><span class="status-indicator ${person.status === 'active' ? 'status-active' : 'status-inactive'}">${person.status}</span></div>
                    <div class="action-buttons">
                        <button class="action-btn edit-btn" onclick="openEntityModal('staff', ${person.id})">Edit</button>
                        <button class="action-btn delete-btn" onclick="deleteStaffMember(${person.id})">Remove</button>
                    </div>
                </div>
            `).join('');
        }

        // Render unit section (placeholder for future implementation)
        function renderUnitSection() {
            const container = document.getElementById('unitList');
            const countElement = document.getElementById('unitCount');
            
            if (!container) return;
            
            // Placeholder implementation
            if (countElement) {
                countElement.textContent = '44 units';
            }
            
            container.innerHTML = `
                <div class="table-row unit-header">
                    <div style="color: #64748b; font-style: italic;">Unit management integration planned</div>
                    <div style="color: #64748b; font-style: italic;">Will integrate with UnitList tab</div>
                    <div style="color: #64748b; font-style: italic;">-</div>
                    <div style="color: #64748b; font-style: italic;">Coming soon</div>
                </div>
            `;
        }

        // Enhanced modal system with entity-specific forms
        function openEntityModal(entityType, entityId) {
            const modal = document.getElementById('entityModal');
            const title = document.getElementById('modalTitle');
            const subtitle = document.getElementById('modalSubtitle');
            const fields = document.getElementById('modalFields');
            const submitBtn = document.getElementById('modalSubmitBtn');
            
            // Clear previous state
            currentEditItem = { type: entityType, id: entityId };
            
            // Configure modal based on entity type
            switch (entityType) {
                case 'status':
                case 'priority':
                case 'category':
                    setupDropdownModal(entityType, entityId, title, subtitle, fields, submitBtn);
                    break;
                    
                case 'staff':
                    setupStaffModal(entityId, title, subtitle, fields, submitBtn);
                    break;
                    
                case 'unit':
                    setupUnitModal(entityId, title, subtitle, fields, submitBtn);
                    break;
                    
                default:
                    console.error('Unknown entity type:', entityType);
                    return;
            }
            
            modal.classList.add('show');
        }

        // Setup dropdown modal (enhanced existing functionality)
        function setupDropdownModal(type, index, title, subtitle, fields, submitBtn) {
            const isEdit = index !== null;
            const currentValue = isEdit ? allData.dropdowns[type][index] : '';
            
            title.textContent = `${isEdit ? 'Edit' : 'Add'} ${type}`;
            subtitle.textContent = `${isEdit ? 'Modify existing' : 'Create new'} ${type.toLowerCase()} option`;
            
            fields.innerHTML = `
                <div class="form-group">
                    <label class="form-label">${type} Name</label>
                    <input type="text" class="form-input" id="entityValue" value="${currentValue}" 
                           placeholder="Enter ${type.toLowerCase()} name..." required>
                </div>
                ${type === 'priority' ? `
                    <div class="form-group">
                        <label class="form-label">Priority Level</label>
                        <select class="form-input" id="priorityLevel">
                            <option value="1">1 - Lowest</option>
                            <option value="2">2 - Low</option>
                            <option value="3">3 - Medium</option>
                            <option value="4">4 - High</option>
                            <option value="5">5 - Urgent</option>
                        </select>
                    </div>
                ` : ''}
            `;
            
            submitBtn.textContent = isEdit ? 'Update Item' : 'Add Item';
            
            // Focus on input
            setTimeout(() => document.getElementById('entityValue').focus(), 100);
        }

        // Setup staff modal (EmailNotification schema pattern)
        function setupStaffModal(staffId, title, subtitle, fields, submitBtn) {
            const isEdit = staffId !== null;
            const currentStaff = isEdit ? allData.staff.find(s => s.id === staffId) : { name: '', email: '' };
            
            title.textContent = `${isEdit ? 'Edit' : 'Add'} Staff Member`;
            subtitle.textContent = `${isEdit ? 'Modify existing' : 'Add new'} maintenance team member`;
            
            fields.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Staff Name</label>
                    <input type="text" class="form-input" id="staffName" value="${currentStaff.name || ''}" 
                           placeholder="Enter staff member name..." required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-input" id="staffEmail" value="${currentStaff.email || ''}" 
                           placeholder="Enter email address...">
                </div>
                <div class="form-group">
                    <label class="form-label">Notification Status</label>
                    <select class="form-input" id="staffStatus">
                        <option value="active" ${currentStaff.status === 'active' ? 'selected' : ''}>Active - Receives notifications</option>
                        <option value="inactive" ${currentStaff.status === 'inactive' ? 'selected' : ''}>Inactive - No notifications</option>
                    </select>
                </div>
            `;
            
            submitBtn.textContent = isEdit ? 'Update Staff' : 'Add Staff';
            
            // Focus on name input
            setTimeout(() => document.getElementById('staffName').focus(), 100);
        }

        // Setup unit modal (placeholder for future implementation)
        function setupUnitModal(unitId, title, subtitle, fields, submitBtn) {
            title.textContent = 'Unit Management';
            subtitle.textContent = 'Unit management integration coming soon';
            
            fields.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: #64748b;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">🏠</div>
                    <p>Unit management will integrate with the UnitList tab</p>
                    <p style="margin-top: 0.5rem; font-size: 0.9rem;">This feature is planned for the next update</p>
                </div>
            `;
            
            submitBtn.textContent = 'Close';
        }

        // Enhanced form submission handler
        async function handleModalSubmit(e) {
            e.preventDefault();
            
            if (!currentEditItem) return;
            
            const { type, id } = currentEditItem;
            
            try {
                showLoading(true);
                
                switch (type) {
                    case 'status':
                    case 'priority':
                    case 'category':
                        await handleDropdownSubmit(type, id);
                        break;
                        
                    case 'staff':
                        await handleStaffSubmit(id);
                        break;
                        
                    case 'unit':
                        // Placeholder - just close modal
                        closeModal();
                        return;
                        
                    default:
                        throw new Error(`Unknown entity type: ${type}`);
                }
                
                closeModal();
                await loadAllData(); // Refresh all data
                
            } catch (error) {
                console.error('❌ Error saving:', error);
                showToast('error', 'Save Failed', error.message);
            } finally {
                showLoading(false);
            }
        }

        // Handle dropdown submissions (enhanced existing functionality)
        async function handleDropdownSubmit(type, index) {
            const value = document.getElementById('entityValue').value.trim();
            
            if (!value) {
                throw new Error('Value is required');
            }
            
            const isEdit = index !== null;
            const oldValue = isEdit ? allData.dropdowns[type][index] : null;
            
            // Check for duplicates
            if (allData.dropdowns[type] && allData.dropdowns[type].includes(value) && value !== oldValue) {
                throw new Error(`${type} "${value}" already exists`);
            }
            
            // Make API call
            if (isEdit) {
                const response = await makeRequest(MAINTENANCE_API_URL, 'updateDropdownItem', {
                    type: type,
                    oldValue: oldValue,
                    newValue: value
                });
                
                if (!response.success) {
                    throw new Error(response.message || 'Update failed');
                }
                
                showToast('success', 'Updated', `${type} "${value}" updated successfully`);
            } else {
                const response = await makeRequest(MAINTENANCE_API_URL, 'addDropdownItem', {
                    type: type,
                    value: value
                });
                
                if (!response.success) {
                    throw new Error(response.message || 'Add failed');
                }
                
                showToast('success', 'Added', `${type} "${value}" added successfully`);
            }
        }

        // Handle staff submissions (EmailNotification schema pattern)
        async function handleStaffSubmit(staffId) {
            const name = document.getElementById('staffName').value.trim();
            const email = document.getElementById('staffEmail').value.trim();
            const status = document.getElementById('staffStatus').value;
            
            if (!name) {
                throw new Error('Staff name is required');
            }
            
            const isEdit = staffId !== null;
            
            if (isEdit) {
                // Update existing staff member
                const response = await makeRequest(EMAIL_NOTIFICATION_API_URL, 'updateNamedRangeRow', {
                    rangeName: 'MtceTeamEmailList',
                    rowIndex: staffId - 1, // Convert to 0-based index
                    data: { name: name, email: email }
                });
                
                if (!response.success) {
                    throw new Error(response.message || 'Update failed');
                }
                
                showToast('success', 'Updated', `Staff member "${name}" updated successfully`);
            } else {
                // Add new staff member
                const response = await makeRequest(EMAIL_NOTIFICATION_API_URL, 'addNamedRangeRow', {
                    rangeName: 'MtceTeamEmailList',
                    data: { name: name, email: email }
                });
                
                if (!response.success) {
                    throw new Error(response.message || 'Add failed');
                }
                
                showToast('success', 'Added', `Staff member "${name}" added successfully`);
            }
        }

        // Enhanced inline editing for staff fields
        function editStaffField(staffId, field, element) {
            const currentValue = element.textContent.trim();
            
            // Create input element
            const input = document.createElement('input');
            input.type = field === 'email' ? 'email' : 'text';
            input.value = currentValue === 'Click to edit' ? '' : currentValue;
            input.className = 'editable-input';
            input.placeholder = `Enter ${field}...`;
            
            // Replace element content
            element.innerHTML = '';
            element.appendChild(input);
            element.classList.add('editing');
            
            // Focus and select
            input.focus();
            input.select();
            
            // Save on blur or enter
            const saveEdit = async () => {
                const newValue = input.value.trim();
                
                try {
                    // Update staff data
                    const staff = allData.staff.find(s => s.id === staffId);
                    if (staff) {
                        staff[field] = newValue;
                        staff.status = staff.email ? 'active' : 'inactive';
                    }
                    
                    // Save to backend
                    const response = await makeRequest(EMAIL_NOTIFICATION_API_URL, 'updateNamedRangeRow', {
                        rangeName: 'MtceTeamEmailList',
                        rowIndex: staffId - 1,
                        data: { name: staff.name, email: staff.email }
                    });
                    
                    if (response.success) {
                        showToast('success', 'Saved', `${field} updated successfully`);
                        renderStaffSection(); // Re-render to show changes
                    } else {
                        throw new Error('Save failed');
                    }
                    
                } catch (error) {
                    console.error('❌ Error saving:', error);
                    showToast('error', 'Save Failed', 'Failed to update field');
                    renderStaffSection(); // Restore original data
                }
            };
            
            // Event listeners
            input.addEventListener('blur', saveEdit);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    saveEdit();
                } else if (e.key === 'Escape') {
                    renderStaffSection(); // Cancel edit
                }
            });
        }

        // Enhanced delete functions
        async function deleteItem(type, value) {
            if (!confirm(`Are you sure you want to delete "${value}" from ${type}?`)) {
                return;
            }
            
            try {
                showLoading(true);
                
                const response = await makeRequest(MAINTENANCE_API_URL, 'deleteDropdownItem', {
                    type: type,
                    value: value
                });
                
                if (response.success) {
                    showToast('success', 'Deleted', `${type} "${value}" deleted successfully`);
                    await loadAllData();
                } else {
                    throw new Error(response.message || 'Delete failed');
                }
                
            } catch (error) {
                console.error('❌ Error deleting:', error);
                showToast('error', 'Delete Failed', error.message);
            } finally {
                showLoading(false);
            }
        }

        async function deleteStaffMember(staffId) {
            const staff = allData.staff.find(s => s.id === staffId);
            if (!staff) return;
            
            if (!confirm(`Are you sure you want to remove "${staff.name}" from the maintenance team?`)) {
                return;
            }
            
            try {
                showLoading(true);
                
                const response = await makeRequest(EMAIL_NOTIFICATION_API_URL, 'deleteNamedRangeRow', {
                    rangeName: 'MtceTeamEmailList',
                    rowIndex: staffId - 1
                });
                
                if (response.success) {
                    showToast('success', 'Removed', `Staff member "${staff.name}" removed successfully`);
                    await loadAllData();
                } else {
                    throw new Error(response.message || 'Delete failed');
                }
                
            } catch (error) {
                console.error('❌ Error deleting staff:', error);
                showToast('error', 'Delete Failed', error.message);
            } finally {
                showLoading(false);
            }
        }

        // Enhanced utility functions
        function closeModal() {
            document.getElementById('entityModal').classList.remove('show');
            currentEditItem = null;
        }

        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        function showToast(type, title, message, duration = 5000) {
            const container = document.getElementById('toastContainer');
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️'
            };
            
            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || icons.info}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;
            
            container.appendChild(toast);
            
            // Trigger animation
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Auto remove
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }

        function updateLastUpdatedTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            document.getElementById('lastUpdated').textContent = `Last updated: ${timeString}`;
        }

        async function refreshAllData() {
            showToast('info', 'Refreshing', 'Reloading all system data...');
            await loadAllData();
        }

        function goBackToAdminMain() {
            if (document.referrer && document.referrer.includes('admin')) {
                window.history.back();
            } else {
                // Fallback to a reasonable admin URL or close
                window.location.href = '../admin-portal.html';
            }
        }

        // Enhanced JSONP request function
        async function makeRequest(baseUrl, action, params = {}) {
            return new Promise((resolve, reject) => {
                const callbackName = 'callback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                // Prepare URL
                const url = new URL(baseUrl);
                url.searchParams.set('action', action);
                url.searchParams.set('callback', callbackName);
                
                // Add parameters
                Object.keys(params).forEach(key => {
                    if (params[key] !== undefined && params[key] !== null) {
                        url.searchParams.set(key, params[key]);
                    }
                });
                
                // Create callback
                window[callbackName] = function(data) {
                    delete window[callbackName];
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    resolve(data);
                };
                
                // Create script
                const script = document.createElement('script');
                script.src = url.toString();
                script.onerror = function() {
                    delete window[callbackName];
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    reject(new Error('Network request failed'));
                };
                
                // Timeout
                setTimeout(() => {
                    if (window[callbackName]) {
                        delete window[callbackName];
                        if (script.parentNode) {
                            script.parentNode.removeChild(script);
                        }
                        reject(new Error('Request timeout'));
                    }
                }, 15000);
                
                document.head.appendChild(script);
            });
        }

        console.log('🎛️ Enhanced Dropdown Manager - Ready!');
        console.log('✨ NEW FEATURES:');
        console.log('  • EmailNotification schema pattern integration');
        console.log('  • Multi-entity management (dropdowns, staff, units)');
        console.log('  • Enhanced inline editing with real-time saves');
        console.log('  • Unified modal system for all entity types');
        console.log('  • Improved visual feedback and animations');
        console.log('  • Named range integration for complex entities');
    </script>
</body>
</html>