<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Dropdown Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .sections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .section {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .section:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .section-header {
            padding: 20px 25px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-size: 1.2rem;
        }

        .resident-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .maintenance-header {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .section-icon {
            font-size: 1.5rem;
            margin-right: 10px;
        }

        .add-button {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .add-button:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .section-content {
            padding: 25px;
        }

        .section-content > div {
            margin-bottom: 30px;
        }

        .section-content > div:last-child {
            margin-bottom: 0;
        }

        .items-container {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #f1f5f9;
            border-radius: 12px;
            padding: 15px;
            background: #f8fafc;
        }

        .item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 10px;
            background: white;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .item:last-child {
            margin-bottom: 0;
        }

        .item:hover {
            border-color: #3b82f6;
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.1);
            transform: translateY(-2px);
        }

        .item-content {
            font-weight: 500;
            color: #374151;
            flex: 1;
        }

        .item-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .edit-btn {
            background: #f59e0b;
            color: white;
        }

        .edit-btn:hover {
            background: #d97706;
            transform: scale(1.05);
        }

        .delete-btn {
            background: #ef4444;
            color: white;
        }

        .delete-btn:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        .loading {
            text-align: center;
            color: #6b7280;
            font-style: italic;
            padding: 20px;
        }

        .empty {
            text-align: center;
            color: #6b7280;
            font-style: italic;
            padding: 20px;
        }

        .error {
            text-align: center;
            color: #ef4444;
            font-weight: 500;
            padding: 20px;
            background: #fef2f2;
            border-radius: 8px;
            border: 1px solid #fecaca;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-header h3 {
            color: #374151;
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .form-input:read-only {
            background: #f9fafb;
            color: #6b7280;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        .modal-btn {
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-cancel {
            background: #e5e7eb;
            color: #374151;
        }

        .btn-cancel:hover {
            background: #d1d5db;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
            transform: scale(1.05);
        }

        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .stats {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            text-align: center;
        }

        .stat-item {
            padding: 15px;
            background: #f8fafc;
            border-radius: 10px;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #3b82f6;
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6b7280;
            margin-top: 5px;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
        }

        .toast {
            background: white;
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-left: 4px solid;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 400px;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            border-left-color: #10b981;
        }

        .toast.error {
            border-left-color: #ef4444;
        }

        .toast.info {
            border-left-color: #3b82f6;
        }

        .toast-icon {
            font-size: 1.2rem;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            color: #374151;
        }

        .toast-message {
            font-size: 0.9rem;
            color: #6b7280;
            margin-top: 2px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .sections-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎛️ Dynamic Dropdown Manager</h1>
            <p>Manage all system dropdown options from one central location</p>
        </div>

        <!-- Stats Section -->
        <div class="stats" id="statsSection" style="display: none;">
            <div class="stats-grid" id="statsGrid">
                <!-- Stats will be populated by JavaScript -->
            </div>
        </div>

        <!-- Dropdown Sections -->
        <div class="sections-grid">
            <!-- Resident Data Section -->
            <div class="section">
                <div class="section-header resident-header">
                    <div>
                        <span class="section-icon">🏠</span>
                        Resident Data
                    </div>
                </div>
                <div class="section-content">
                    <!-- Unit Numbers -->
                    <div style="margin-bottom: 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="color: #374151; font-weight: 600;">🏢 Unit Numbers</h4>
                            <button class="add-button" onclick="showAddModal('Unit Number')" style="background: #3b82f6; border: none; border-radius: 8px; padding: 8px 12px; color: white; font-size: 0.8rem;">+ Add Unit</button>
                        </div>
                        <div class="items-container" id="unitNumbersContainer">
                            <div class="loading">Loading unit numbers...</div>
                        </div>
                    </div>

                    <!-- Reported By Names -->
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="color: #374151; font-weight: 600;">👤 Reported By Names</h4>
                            <button class="add-button" onclick="showAddModal('Reported By')" style="background: #3b82f6; border: none; border-radius: 8px; padding: 8px 12px; color: white; font-size: 0.8rem;">+ Add Name</button>
                        </div>
                        <div class="items-container" id="reportedByContainer">
                            <div class="loading">Loading reported by names...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Maintenance Data Section -->
            <div class="section">
                <div class="section-header maintenance-header">
                    <div>
                        <span class="section-icon">🔧</span>
                        Maintenance Data
                    </div>
                </div>
                <div class="section-content">
                    <!-- Status -->
                    <div style="margin-bottom: 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="color: #374151; font-weight: 600;">📊 Status Options</h4>
                            <button class="add-button" onclick="showAddModal('Status')" style="background: #10b981; border: none; border-radius: 8px; padding: 8px 12px; color: white; font-size: 0.8rem;">+ Add Status</button>
                        </div>
                        <div class="items-container" id="statusContainer">
                            <div class="loading">Loading status options...</div>
                        </div>
                    </div>

                    <!-- Priority -->
                    <div style="margin-bottom: 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="color: #374151; font-weight: 600;">⚡ Priority Levels</h4>
                            <button class="add-button" onclick="showAddModal('Priority')" style="background: #10b981; border: none; border-radius: 8px; padding: 8px 12px; color: white; font-size: 0.8rem;">+ Add Priority</button>
                        </div>
                        <div class="items-container" id="priorityContainer">
                            <div class="loading">Loading priority levels...</div>
                        </div>
                    </div>

                    <!-- Category -->
                    <div style="margin-bottom: 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="color: #374151; font-weight: 600;">🏷️ Categories</h4>
                            <button class="add-button" onclick="showAddModal('Category')" style="background: #10b981; border: none; border-radius: 8px; padding: 8px 12px; color: white; font-size: 0.8rem;">+ Add Category</button>
                        </div>
                        <div class="items-container" id="categoryContainer">
                            <div class="loading">Loading categories...</div>
                        </div>
                    </div>

                    <!-- Sub-Category -->
                    <div style="margin-bottom: 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="color: #374151; font-weight: 600;">🏷️ Sub-Categories</h4>
                            <button class="add-button" onclick="showAddModal('Sub-Category')" style="background: #10b981; border: none; border-radius: 8px; padding: 8px 12px; color: white; font-size: 0.8rem;">+ Add Sub-Category</button>
                        </div>
                        <div class="items-container" id="subCategoryContainer">
                            <div class="loading">Loading sub-categories...</div>
                        </div>
                    </div>

                    <!-- Assigned To -->
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="color: #374151; font-weight: 600;">👥 Assigned To</h4>
                            <button class="add-button" onclick="showAddModal('Assigned To')" style="background: #10b981; border: none; border-radius: 8px; padding: 8px 12px; color: white; font-size: 0.8rem;">+ Add Assignee</button>
                        </div>
                        <div class="items-container" id="assignedToContainer">
                            <div class="loading">Loading assignees...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div id="addEditModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Add New Item</h3>
            </div>
            <form id="addEditForm">
                <div class="form-group">
                    <label class="form-label" for="itemType">Type:</label>
                    <input type="text" id="itemType" class="form-input" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label" for="itemValue">Value:</label>
                    <input type="text" id="itemValue" class="form-input" placeholder="Enter value..." required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="modal-btn btn-cancel" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="modal-btn btn-primary" id="submitBtn">Add Item</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <script>
        // Configuration - Your standalone Dynamic Dropdown Service
        // const API_URL = 'https://script.google.com/macros/s/AKfycbysMz0Hd-m3dzhs3eXsCaoXeGzHI_2Gxc1PWmLlCTFFz4WIbpOTWzLd1ndHuvWvxXYhKQ/exec';

        const API_URL = 'https://script.google.com/macros/s/AKfycbwLlANXCea17ujhiDOsv85c_4cwEaxS8uKCPTl-vOmJ5W5r4ZNW8EPio_uvVLIjG0BuUg/exec';
        
        // Global state
        let allDropdownData = {};
        let currentEditItem = null;

        // Type to container mapping
        const typeContainers = {
            'Unit Number': 'unitNumbersContainer',
            'Reported By': 'reportedByContainer',
            'Status': 'statusContainer',
            'Priority': 'priorityContainer',
            'Category': 'categoryContainer',
            'Sub-Category': 'subCategoryContainer',
            'Assigned To': 'assignedToContainer'
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🎛️ Dynamic Dropdown Manager Initialized');
            console.log('📡 Standalone Service URL:', API_URL);
            loadAllDropdowns();
        });

        // JSONP Request Function (matches your established pattern)
        async function makeRequest(action, additionalParams = {}) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                const script = document.createElement('script');
                
                const params = new URLSearchParams({
                    action: action,
                    callback: callbackName,
                    ...additionalParams
                });
                
                script.src = `${API_URL}?${params.toString()}`;
                
                window[callbackName] = function(response) {
                    setTimeout(() => {
                        if (script && script.parentNode) {
                            script.parentNode.removeChild(script);
                        }
                        if (window[callbackName]) {
                            delete window[callbackName];
                        }
                    }, 100);
                    resolve(response);
                };
                
                script.onerror = function() {
                    setTimeout(() => {
                        if (script && script.parentNode) {
                            script.parentNode.removeChild(script);
                        }
                        if (window[callbackName]) {
                            delete window[callbackName];
                        }
                    }, 100);
                    reject(new Error('Network request failed'));
                };
                
                setTimeout(() => {
                    if (window[callbackName]) {
                        if (script && script.parentNode) {
                            script.parentNode.removeChild(script);
                        }
                        delete window[callbackName];
                        reject(new Error('Request timeout'));
                    }
                }, 15000);
                
                document.head.appendChild(script);
            });
        }

        // Load all dropdown data using your standalone service
        async function loadAllDropdowns() {
            try {
                console.log('📋 Loading all dropdown data from standalone service...');
                showToast('info', 'Loading', 'Fetching dropdown data...');
                
                const response = await makeRequest('getAllDropdowns');
                
                if (response.success) {
                    allDropdownData = response.dropdowns;
                    console.log('✅ Dropdown data loaded:', allDropdownData);
                    
                    displayAllDropdowns();
                    updateStats();
                    showToast('success', 'Success', 'Dropdown data loaded successfully');
                } else {
                    throw new Error(response.error || 'Failed to load dropdown data');
                }
                
            } catch (error) {
                console.error('❌ Error loading dropdown data:', error);
                showError('Failed to load dropdown data. Please check the service connection.');
                showToast('error', 'Error', error.message);
            }
        }

        // Display all dropdown data in their respective containers
        function displayAllDropdowns() {
            Object.keys(typeContainers).forEach(type => {
                const container = document.getElementById(typeContainers[type]);
                const items = allDropdownData[type] || [];
                
                if (items.length === 0) {
                    container.innerHTML = `<div class="empty">No ${type.toLowerCase()} items found</div>`;
                } else {
                    container.innerHTML = items.map((item, index) => createItemHTML(type, item, index)).join('');
                }
            });
        }

        // Create HTML for a dropdown item
        function createItemHTML(type, value, index) {
            // Ensure value is a string and escape HTML to prevent XSS
            const stringValue = String(value); // Convert to string first
            const safeValue = stringValue.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
            const safeType = String(type).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
            
            return `
                <div class="item">
                    <div class="item-content">${stringValue}</div>
                    <div class="item-actions">
                        <button class="action-btn edit-btn" onclick="editItem('${safeType}', '${safeValue}', ${index})">Edit</button>
                        <button class="action-btn delete-btn" onclick="deleteItem('${safeType}', '${safeValue}', ${index})">Delete</button>
                    </div>
                </div>
            `;
        }

        // Update statistics
        function updateStats() {
            const statsSection = document.getElementById('statsSection');
            const statsGrid = document.getElementById('statsGrid');
            
            let totalItems = 0;
            let residentItems = 0;
            let maintenanceItems = 0;
            
            Object.keys(allDropdownData).forEach(type => {
                const count = allDropdownData[type].length;
                totalItems += count;
                
                if (type === 'Unit Number' || type === 'Reported By') {
                    residentItems += count;
                } else {
                    maintenanceItems += count;
                }
            });
            
            statsGrid.innerHTML = `
                <div class="stat-item">
                    <span class="stat-number">${totalItems}</span>
                    <div class="stat-label">Total Items</div>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${residentItems}</span>
                    <div class="stat-label">Resident Data</div>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${maintenanceItems}</span>
                    <div class="stat-label">Maintenance Data</div>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${Object.keys(allDropdownData).length}</span>
                    <div class="stat-label">Categories</div>
                </div>
            `;
            
            statsSection.style.display = 'block';
        }

        // Show add modal
        function showAddModal(type) {
            currentEditItem = null;
            document.getElementById('modalTitle').textContent = `Add New ${type}`;
            document.getElementById('itemType').value = type;
            document.getElementById('itemValue').value = '';
            document.getElementById('submitBtn').textContent = 'Add Item';
            document.getElementById('addEditModal').style.display = 'block';
            
            // Focus on value input
            setTimeout(() => {
                document.getElementById('itemValue').focus();
            }, 100);
        }

        // Edit item
        function editItem(type, value, index) {
            currentEditItem = { type, value, index };
            document.getElementById('modalTitle').textContent = `Edit ${type}`;
            document.getElementById('itemType').value = type;
            document.getElementById('itemValue').value = value;
            document.getElementById('submitBtn').textContent = 'Update Item';
            document.getElementById('addEditModal').style.display = 'block';
            
            // Focus and select value input
            setTimeout(() => {
                const input = document.getElementById('itemValue');
                input.focus();
                input.select();
            }, 100);
        }

        // Delete item (GROUP INTEGRITY: Uses getDropdownItems to find exact rowIndex)
        async function deleteItem(type, value, index) {
            if (!confirm(`Are you sure you want to delete "${value}" from ${type}?`)) {
                return;
            }
            
            try {
                console.log(`🗑️ Deleting item: ${type} = ${value}`);
                showToast('info', 'Deleting', `Removing "${value}"...`);
                
                // CRITICAL: Get exact rowIndex from your service for group integrity
                console.log('🔍 Finding exact row index for deletion...');
                
                let allItemsResponse;
                try {
                    // Call getDropdownItems with sheetName parameter for your service
                    allItemsResponse = await makeRequest('getDropdownItems', { sheetName: 'Dropdowns' });
                } catch (requestError) {
                    console.error('❌ Error calling getDropdownItems:', requestError);
                    throw new Error('Failed to connect to service for deletion');
                }
                
                if (allItemsResponse && allItemsResponse.success) {
                    console.log('📋 All items response:', allItemsResponse);
                    
                    const targetItem = allItemsResponse.items.find(item => 
                        item.type === type && item.value === value
                    );
                    
                    if (targetItem) {
                        console.log(`🎯 Found target item at rowIndex: ${targetItem.rowIndex}`);
                        
                        let deleteResponse;
                        try {
                            deleteResponse = await makeRequest('deleteDropdownItem', {
                                rowIndex: targetItem.rowIndex
                            });
                        } catch (deleteError) {
                            console.error('❌ Error calling deleteDropdownItem:', deleteError);
                            throw new Error('Failed to delete item from service');
                        }
                        
                        if (deleteResponse && deleteResponse.success) {
                            console.log('✅ Item deleted successfully');
                            showToast('success', 'Deleted', `"${value}" removed successfully`);
                            await loadAllDropdowns(); // Reload to show updated groups
                        } else {
                            console.error('❌ Delete response:', deleteResponse);
                            throw new Error(deleteResponse?.error || 'Failed to delete item');
                        }
                    } else {
                        console.error('❌ Item not found in list:', { type, value, items: allItemsResponse.items });
                        throw new Error(`Item "${value}" not found in ${type} list`);
                    }
                } else {
                    console.error('❌ getDropdownItems failed:', allItemsResponse);
                    throw new Error('Failed to get item list for deletion');
                }
                
            } catch (error) {
                console.error('❌ Error deleting item:', error);
                showToast('error', 'Delete Failed', error.message);
            }
        }

        // Handle form submission (ADD/UPDATE with group integrity)
        document.getElementById('addEditForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const type = document.getElementById('itemType').value;
            const value = document.getElementById('itemValue').value.trim();
            const submitBtn = document.getElementById('submitBtn');
            
            if (!value) {
                showToast('error', 'Validation Error', 'Please enter a value');
                return;
            }
            
            // Check for duplicates
            const existingItems = allDropdownData[type] || [];
            if (existingItems.includes(value) && (!currentEditItem || currentEditItem.value !== value)) {
                showToast('error', 'Duplicate Item', `"${value}" already exists in ${type}`);
                return;
            }
            
            try {
                // Disable submit button
                submitBtn.disabled = true;
                submitBtn.textContent = currentEditItem ? 'Updating...' : 'Adding...';
                
                let response;
                
                if (currentEditItem) {
                    // UPDATE: Need rowIndex for group integrity
                    console.log(`✏️ Updating item: ${type} = ${currentEditItem.value} → ${value}`);
                    showToast('info', 'Updating', `Updating "${currentEditItem.value}" to "${value}"...`);
                    
                    // Get exact rowIndex for the item being updated
                    const allItemsResponse = await makeRequest('getDropdownItems', { sheetName: 'Dropdowns' });
                    
                    if (allItemsResponse.success) {
                        const targetItem = allItemsResponse.items.find(item => 
                            item.type === currentEditItem.type && item.value === currentEditItem.value
                        );
                        
                        if (targetItem) {
                            console.log(`🎯 Found target item at rowIndex: ${targetItem.rowIndex}`);
                            
                            response = await makeRequest('updateDropdownItem', {
                                rowIndex: targetItem.rowIndex,
                                type: type,
                                value: value
                            });
                        } else {
                            throw new Error('Item not found for update');
                        }
                    } else {
                        throw new Error('Failed to get item list for update');
                    }
                } else {
                    // ADD: Simple addition - service handles group integrity with sorting
                    console.log(`➕ Adding new item: ${type} = ${value}`);
                    showToast('info', 'Adding', `Adding "${value}" to ${type}...`);
                    
                    response = await makeRequest('addDropdownItem', {
                        type: type,
                        value: value
                    });
                }
                
                if (response.success) {
                    console.log('✅ Item saved successfully');
                    const action = currentEditItem ? 'updated' : 'added';
                    showToast('success', 'Success', `"${value}" ${action} successfully`);
                    closeModal();
                    await loadAllDropdowns(); // Reload to show updated groups (automatic sorting)
                } else {
                    throw new Error(response.error || 'Failed to save item');
                }
                
            } catch (error) {
                console.error('❌ Error saving item:', error);
                showToast('error', 'Save Failed', error.message);
            } finally {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.textContent = currentEditItem ? 'Update Item' : 'Add Item';
            }
        });

        // Close modal
        function closeModal() {
            document.getElementById('addEditModal').style.display = 'none';
            currentEditItem = null;
        }

        // Show error message in all containers
        function showError(message) {
            Object.values(typeContainers).forEach(containerId => {
                document.getElementById(containerId).innerHTML = `<div class="error">${message}</div>`;
            });
        }

        // Toast notification system
        function showToast(type, title, message, duration = 5000) {
            const container = document.getElementById('toastContainer');
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icon = type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️';
            
            toast.innerHTML = `
                <div class="toast-icon">${icon}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;
            
            container.appendChild(toast);
            
            // Auto remove after duration
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, duration);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('addEditModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Handle escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });

        // Enhanced logging for debugging
        console.log('🔧 Dynamic Dropdown Manager - Ready!');
        console.log('📡 Standalone Service:', API_URL);
        console.log('🎯 Key Features:');
        console.log('  • GROUP INTEGRITY: Uses getDropdownItems for exact rowIndex mapping');
        console.log('  • AUTO-SORTING: Service automatically sorts after each operation');
        console.log('  • JSONP API: Compatible with your established patterns');
        console.log('  • Modern UI: Unified interface for all dropdown types');
        console.log('📋 Supported Types:', Object.keys(typeContainers));
        console.log('');
        console.log('🔍 GROUP INTEGRITY WORKFLOW:');
        console.log('  1. ADD: service.addDropdownItem() → appendRow() → sortDropdownSheet()');
        console.log('  2. DELETE: getDropdownItems() → find rowIndex → deleteRow()');
        console.log('  3. UPDATE: getDropdownItems() → find rowIndex → updateRow() → sortDropdownSheet()');
        console.log('  4. RESULT: Groups stay together (Priority items, Status items, etc.)');
    </script>
</body>
</html>
