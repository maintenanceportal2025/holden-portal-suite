<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔧 Lake Illawong Maintenance Portal</title>
    <style>
        /* SIMPLIFIED MAINTENANCE PORTAL V3.1 - Enhanced with Completed Problems Toggle */
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* AUTHENTICATION STYLES */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            width: 100%;
            max-width: 400px;
        }
        
        .login-header {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .login-header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .login-body {
            padding: 30px;
        }
        
        .login-input {
            width: 100%;
            padding: 12px 40px 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s ease;
        }
        
        .login-input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .login-btn {
            width: 100%;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            margin-top: 20px;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
        }
        
        /* MAIN PORTAL STYLES */
        .hidden {
            display: none !important;
        }
        
        .header-section {
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
        }
        
        .header-content h1 {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 4px;
        }
        
        .header-content p {
            color: #6b7280;
            font-size: 16px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
        }
        
        .btn-refresh {
            background: #3b82f6;
            color: white;
        }
        
        .btn-logout {
            background: #ef4444;
            color: white;
        }
        
        .data-indicator {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .data-indicator.loading {
            background: #fbbf24;
            color: white;
        }
        
        .data-indicator.ready {
            background: #10b981;
            color: white;
        }
        
        .data-indicator.error {
            background: #ef4444;
            color: white;
        }
        
        /* PRIORITY DASHBOARD */
        .priority-dashboard {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .dashboard-title {
            font-size: 20px;
            font-weight: 700;
        }
        
        .dashboard-controls {
            display: flex;
            gap: 10px;
        }
        
        .control-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s ease;
        }
        
        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* VIEW TOGGLE BUTTONS */
        .view-toggle-section {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            background: #f8fafc;
        }
        
        .view-toggle-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .view-toggle-btn {
            padding: 12px 20px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .view-toggle-btn.active {
            border-color: #3b82f6;
            background: #3b82f6;
            color: white;
        }
        
        .view-toggle-btn.completed.active {
            border-color: #10b981;
            background: #10b981;
            color: white;
        }
        
        .view-toggle-btn:hover:not(.active) {
            border-color: #9ca3af;
            background: #f9fafb;
        }
        
        .view-stats {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #6b7280;
        }
        
        .view-stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .priority-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            padding: 20px;
        }
        
        .priority-card {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        
        .priority-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .priority-card.active {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .priority-card.urgent {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            color: #dc2626;
        }
        
        .priority-card.high {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #d97706;
        }
        
        .priority-card.medium {
            background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
            color: #0284c7;
        }
        
        .priority-card.low {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            color: #16a34a;
        }
        
        .priority-card.all {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: #475569;
        }
        
        .priority-number {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .priority-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* SEARCH AND CONTROLS */
        .search-controls {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .search-bar {
            position: relative;
            margin-bottom: 15px;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 45px 12px 45px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s ease;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            font-size: 18px;
        }
        
        .clear-search {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            font-size: 18px;
            display: none;
        }
        
        .clear-search.visible {
            display: block;
        }
        
        .search-results {
            font-size: 14px;
            color: #6b7280;
            margin-top: 10px;
        }
        
        /* PROBLEM LIST */
        .problems-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        
        .problems-header {
            background: #f8fafc;
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .problems-title {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
        }
        
        .problems-count {
            background: #3b82f6;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .problems-list {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .problem-item {
            padding: 20px;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .problem-item:hover {
            background: #f8fafc;
        }
        
        .problem-item:last-child {
            border-bottom: none;
        }
        
        /* COMPLETED PROBLEM STYLING */
        .problem-item.completed {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-left: 4px solid #10b981;
        }
        
        .problem-item.completed:hover {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
        }
        
        .problem-item.completed .problem-priority.urgent,
        .problem-item.completed .problem-priority.high,
        .problem-item.completed .problem-priority.medium,
        .problem-item.completed .problem-priority.low {
            background: #10b981;
            color: white;
        }
        
        .problem-item.completed::before {
            content: '✅';
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 18px;
        }
        
        .problem-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .problem-left {
            flex: 1;
        }
        
        .problem-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .problem-id {
            font-size: 14px;
            font-weight: 600;
            color: #3b82f6;
            margin-bottom: 4px;
        }
        
        .problem-item.completed .problem-id {
            color: #10b981;
        }
        
        .problem-unit {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
        }
        
        .problem-date {
            font-size: 12px;
            color: #6b7280;
            background: #f3f4f6;
            padding: 2px 8px;
            border-radius: 4px;
        }
        
        .problem-priority {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .problem-priority.urgent {
            background: #fef2f2;
            color: #dc2626;
        }
        
        .problem-priority.high {
            background: #fef3c7;
            color: #d97706;
        }
        
        .problem-priority.medium {
            background: #e0f2fe;
            color: #0284c7;
        }
        
        .problem-priority.low {
            background: #f0fdf4;
            color: #16a34a;
        }
        
        .problem-description {
            color: #4b5563;
            margin-bottom: 12px;
            line-height: 1.5;
        }
        
        .problem-meta {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: #6b7280;
        }
        
        .problem-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* LOADING STATES */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .loading-content {
            background: white;
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-phase {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 10px;
        }
        
        .loading-progress {
            background: #e5e7eb;
            border-radius: 20px;
            height: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .loading-progress-bar {
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .loading-detail {
            font-size: 14px;
            color: #6b7280;
        }
        
        /* EMPTY STATES */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }
        
        .empty-state .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #374151;
        }
        
        .empty-state p {
            font-size: 16px;
            line-height: 1.6;
        }
        
        /* PROBLEM DETAILS PAGE */
        .page-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .back-btn {
            background: #f3f4f6;
            color: #374151;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .back-btn:hover {
            background: #e5e7eb;
        }
        
        .detail-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .section-title-bar {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 15px 20px;
            font-weight: 700;
            font-size: 16px;
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 20px;
        }
        
        .detail-field {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .detail-field.full-width {
            grid-column: 1 / -1;
        }
        
        .detail-field label {
            font-weight: 600;
            color: #374151;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .detail-field span {
            color: #1f2937;
            font-size: 16px;
            padding: 8px 0;
        }
        
        .report-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .report-btn.green {
            background: #059669;
        }
        
        .report-btn:hover {
            transform: translateY(-2px);
        }
        
        /* RESPONSIVE DESIGN */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .header-right {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .priority-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .view-toggle-buttons {
                flex-direction: column;
            }
            
            .view-stats {
                flex-direction: column;
                gap: 10px;
            }
            
            .problem-header {
                flex-direction: column;
                gap: 10px;
            }
            
            .problem-right {
                align-self: flex-start;
            }
            
            .problem-meta {
                flex-direction: column;
                gap: 8px;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* NOTIFICATION STYLES */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            padding: 16px 20px;
            max-width: 400px;
            z-index: 2000;
            transform: translateX(450px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            border-left: 4px solid #10b981;
        }
        
        .notification.error {
            border-left: 4px solid #ef4444;
        }
        
        .notification.info {
            border-left: 4px solid #3b82f6;
        }
    </style>
</head>
<body>
    <!-- LOGIN VIEW -->
    <div id="loginView">
        <div class="login-container">
            <div class="login-card">
                <div class="login-header">
                    <h1>🔧 Maintenance Portal</h1>
                    <p>Lake Illawong Retirement Village</p>
                </div>
                
                <div class="login-body">
                    <div style="margin-bottom: 25px;">
                        <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <span style="font-size: 20px;">🔐</span>
                                <strong style="color: #1e40af;">Secure Access Required</strong>
                            </div>
                            <p style="color: #1e40af; font-size: 14px; line-height: 1.5; margin: 0;">
                                This portal provides full access to maintenance data including resident contact details and sensitive information. Authentication is required to ensure system security.
                            </p>
                        </div>
                    </div>
                    
                    <!-- Login Form -->
                    <form id="loginForm">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; color: #374151; font-size: 16px; margin-bottom: 8px;">Password</label>
                            <div style="position: relative;">
                                <input type="password" id="passwordInput" class="login-input"
                                       placeholder="Enter maintenance password" required>
                                <button type="button" id="togglePassword" 
                                        style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #6b7280; cursor: pointer; font-size: 18px;">
                                    👁️
                                </button>
                            </div>
                        </div>
                        
                        <button type="submit" id="loginBtn" class="login-btn">
                            🔐 Access Maintenance Portal
                        </button>
                    </form>
                    
                    <!-- Footer -->
                    <div style="text-align: center; margin-top: 30px; color: #9ca3af; font-size: 14px;">
                        Lake Illawong Maintenance Team
                    </div>
                </div>
            </div>
        </div>
    </div>
        
       
        <!-- MAIN PORTAL -->
        <div id="mainView" class="hidden">
            <!-- HEADER -->
            <div class="header-section">
                <div class="container">
                    <div class="header-content">
                        <div>
                            <h1>🔧 Maintenance Portal</h1>
                            <p>Simplified Problem Management</p>
                        </div>
                        <div class="header-right">
                            <button id="refreshBtn" class="btn btn-refresh">🔄 Refresh</button>
                            <button id="logoutBtn" class="btn btn-logout">🚪 Logout</button>
                            <span id="dataStatus" class="data-indicator loading">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="container" id="listView">
                <!-- PRIORITY DASHBOARD -->
                <div class="priority-dashboard">
                    <div class="dashboard-header">
                        <div class="dashboard-title">📊 Problem Dashboard</div>
                        <div class="dashboard-controls">
                            <button class="control-btn" onclick="refreshData()">🔄 Refresh</button>
                        </div>
                    </div>
                    
                    <!-- VIEW TOGGLE SECTION -->
                    <div class="view-toggle-section">
                        <div class="view-toggle-buttons">
                            <button id="activeProblemsBtn" class="view-toggle-btn active">
                                📋 Active Problems
                            </button>
                            <button id="completedProblemsBtn" class="view-toggle-btn completed">
                                ✅ Completed Problems
                            </button>
                        </div>
                        <div class="view-stats">
                            <div class="view-stat">
                                <span>📋 Active:</span>
                                <strong id="activeCount">0</strong>
                            </div>
                            <div class="view-stat">
                                <span>✅ Completed:</span>
                                <strong id="completedCount">0</strong>
                            </div>
                            <div class="view-stat">
                                <span>📊 Total:</span>
                                <strong id="totalCount">0</strong>
                            </div>
                        </div>
                    </div>
                    
                    <div class="priority-stats" id="priorityStats">
                        <div class="priority-card all active" data-priority="all">
                            <div class="priority-number" id="allCount">0</div>
                            <div class="priority-label">All Problems</div>
                        </div>
                        <div class="priority-card urgent" data-priority="Urgent">
                            <div class="priority-number" id="urgentCount">0</div>
                            <div class="priority-label">Urgent</div>
                        </div>
                        <div class="priority-card high" data-priority="High">
                            <div class="priority-number" id="highCount">0</div>
                            <div class="priority-label">High</div>
                        </div>
                        <div class="priority-card medium" data-priority="Medium">
                            <div class="priority-number" id="mediumCount">0</div>
                            <div class="priority-label">Medium</div>
                        </div>
                        <div class="priority-card low" data-priority="Low">
                            <div class="priority-number" id="lowCount">0</div>
                            <div class="priority-label">Low</div>
                        </div>
                    </div>
                </div>

                <!-- SEARCH CONTROLS -->
                <div class="search-controls">
                    <div class="search-bar">
                        <span class="search-icon">🔍</span>
                        <input type="text" id="searchInput" class="search-input" placeholder="Search problems by unit, description, category...">
                        <button id="clearSearch" class="clear-search">✕</button>
                    </div>
                    <div class="search-results" id="searchResults">
                        Ready to search problems...
                    </div>
                </div>

                <!-- PROBLEMS LIST -->
                <div class="problems-container">
                    <div class="problems-header">
                        <div class="problems-title" id="problemsTitle">📋 Active Problems</div>
                        <div class="problems-count" id="problemsCount">0</div>
                    </div>
                    <div class="problems-list" id="problemsList">
                        <div class="empty-state">
                            <div class="empty-icon">🔍</div>
                            <h3>Loading Problems...</h3>
                            <p>Please wait while we fetch the latest maintenance data.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- LOADING OVERLAY -->
            <div id="loadingOverlay" class="loading-overlay hidden">
                <div class="loading-content">
                    <div class="loading-spinner"></div>
                    <div class="loading-phase" id="loadingPhase">Initializing system...</div>
                    <div class="loading-progress">
                        <div class="loading-progress-bar" id="loadingProgressBar"></div>
                    </div>
                    <div class="loading-detail" id="loadingDetail">Loading maintenance problems...</div>
                </div>
            </div>
        </div>

        <!-- PROBLEM DETAILS PAGE -->
        <div id="problemDetailsView" class="container hidden">
            <div class="page-header">
                <button id="backToList" class="back-btn">← Back</button>
                <h2 id="problemPageTitle">Problem Details</h2>
            </div>

            <!-- Report Buttons Section -->
            <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; padding: 15px 20px; display: flex; gap: 10px;">
                <button id="viewProblemReport" class="report-btn">📄 View Report</button>
                <button id="copyProblemReport" class="report-btn green">📋 Copy Report</button>
            </div>

            <!-- Problem Details -->
            <div class="detail-section">
                <div class="section-title-bar">📋 Problem Details</div>
                <div class="detail-grid">
                    <div class="detail-field">
                        <label>Problem ID</label>
                        <span id="detailProblemId">-</span>
                    </div>
                    <div class="detail-field">
                        <label>Unit Number</label>
                        <span id="detailUnitNumber">-</span>
                    </div>
                    <div class="detail-field">
                        <label>Reported Date</label>
                        <span id="detailReportedDate">-</span>
                    </div>
                    <div class="detail-field">
                        <label>Zone</label>
                        <span id="detailZone">-</span>
                    </div>
                    <div class="detail-field full-width">
                        <label>Problem Description</label>
                        <span id="detailDescription">-</span>
                    </div>
                </div>
            </div>

            <!-- Management Details -->
            <div class="detail-section">
                <div class="section-title-bar">🔧 Management Details</div>
                <div class="detail-grid">
                    <div class="detail-field">
                        <label>Priority</label>
                        <span id="detailPriority">-</span>
                    </div>
                    <div class="detail-field">
                        <label>Status</label>
                        <span id="detailStatus">-</span>
                    </div>
                    <div class="detail-field">
                        <label>Category</label>
                        <span id="detailCategory">-</span>
                    </div>
                    <div class="detail-field">
                        <label>Sub-Category</label>
                        <span id="detailSubCategory">-</span>
                    </div>
                    <div class="detail-field">
                        <label>Assigned To</label>
                        <span id="detailAssignedTo">-</span>
                    </div>
                    <div class="detail-field">
                        <label>Completion Date</label>
                        <span id="detailCompletionDate">-</span>
                    </div>
                    <div class="detail-field full-width">
                        <label>Work Notes</label>
                        <span id="detailWorkNotes">-</span>
                    </div>
                </div>
            </div>

            <!-- Contact Details -->
            <div class="detail-section">
                <div class="section-title-bar">📞 Contact Details</div>
                <div class="detail-grid">
                    <div class="detail-field">
                        <label>Resident Name</label>
                        <span id="detailResidentName">-</span>
                    </div>
                    <div class="detail-field">
                        <label>Phone Number</label>
                        <span id="detailPhoneNumber">-</span>
                    </div>
                    <div class="detail-field">
                        <label>Email Address</label>
                        <span id="detailEmailAddress">-</span>
                    </div>
                    <div class="detail-field">
                        <label>Emergency Contact</label>
                        <span id="detailEmergencyContact">-</span>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // SIMPLIFIED MAINTENANCE PORTAL V3.1 - Enhanced with Completed Problems Toggle
            
            // API Configuration
            const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxtdMfxB5b1F5K401X0lJxnK2-DGkiG2zYZNukJvAHx0K1AqgPTMIdiunwS3etm0FOL/exec';
            const MAINTENANCE_PASSWORD = 'maint2025';
            
            // State Management
            let allProblems = []; // ALL problems (active + completed)
            let filteredProblems = [];
            let activePriorityFilter = 'all';
            let searchTerm = '';
            let currentProblem = null;
            let isAuthenticated = false;
            let currentView = 'active'; // 'active' or 'completed'
            
            // URL Search Parameter Enhancement
            let pendingSearchParam = null;
            
            // Dynamic dropdown data storage
            let dynamicDropdownData = {
                categories: [],
                subCategories: [],
                priorities: [],
                statuses: [],
                assignedTo: []
            };
            
            // Priority Order
            const PRIORITY_ORDER = ['Urgent', 'High', 'Medium', 'Low'];
            
            document.addEventListener('DOMContentLoaded', function() {
                console.log('🚀 Maintenance Portal V3.1 - With Completed Problems Toggle');
                
                captureSearchParameter();
                setupEventListeners();
                
                if (isAuthenticated) {
                    showMainPortal();
                    initializeSystem();
                } else {
                    showLogin();
                }
            });
            
            // =================================================================
            // ENHANCED EVENT LISTENERS WITH VIEW TOGGLE
            // =================================================================
            
            function setupEventListeners() {
                // Login
                document.getElementById('loginForm').addEventListener('submit', handleLogin);
                document.getElementById('togglePassword').addEventListener('click', togglePasswordVisibility);
                
                // Main Portal
                document.getElementById('refreshBtn').addEventListener('click', refreshData);
                document.getElementById('logoutBtn').addEventListener('click', handleLogout);
                
                // VIEW TOGGLE BUTTONS - NEW FUNCTIONALITY
                document.getElementById('activeProblemsBtn').addEventListener('click', () => switchView('active'));
                document.getElementById('completedProblemsBtn').addEventListener('click', () => switchView('completed'));
                
                // Priority filters
                document.querySelectorAll('.priority-card').forEach(card => {
                    card.addEventListener('click', function() {
                        const priority = this.dataset.priority;
                        setPriorityFilter(priority);
                    });
                });
                
                // Search
                const searchInput = document.getElementById('searchInput');
                searchInput.addEventListener('input', debounce(handleSearch, 300));
                
                document.getElementById('clearSearch').addEventListener('click', clearSearch);
                
                // Problem details navigation
                document.getElementById('backToList').addEventListener('click', () => {
                    showListView();
                });
            }
            
            // =================================================================
            // NEW VIEW TOGGLE FUNCTIONALITY
            // =================================================================
            
            function switchView(view) {
                console.log('🔄 Switching to view:', view);
                
                currentView = view;
                
                // Update button states
                const activeBtn = document.getElementById('activeProblemsBtn');
                const completedBtn = document.getElementById('completedProblemsBtn');
                
                if (view === 'active') {
                    activeBtn.classList.add('active');
                    completedBtn.classList.remove('active');
                    document.getElementById('problemsTitle').textContent = '📋 Active Problems';
                } else {
                    activeBtn.classList.remove('active');
                    completedBtn.classList.add('active');
                    document.getElementById('problemsTitle').textContent = '✅ Completed Problems';
                }
                
                // Reset priority filter to 'all' when switching views
                setPriorityFilter('all');
                
                // Apply filters and render
                applyFilters();
                renderProblems();
            }
            
            // =================================================================
            // ENHANCED DATA LOADING - GETS ALL PROBLEMS
            // =================================================================
            
            async function loadProblems() {
                console.log('📥 Loading ALL problems (active + completed)...');
                
                try {
                    // Call existing API without any includeCompleted parameter
                    const response = await makeRequest({
                        action: 'getFaultLogData'
                        // Note: No includeCompleted parameter - using existing backend as-is
                    });
                    
                    if (response.success && response.data) {
                        allProblems = response.data;
                        console.log(`✅ Loaded ${allProblems.length} total problems`);
                        
                        // Update view statistics
                        updateViewStatistics();
                        
                        // Apply current filters
                        applyFilters();
                        
                        return response;
                    } else {
                        throw new Error(response.message || 'Failed to load problems');
                    }
                } catch (error) {
                    console.error('❌ Error loading problems:', error);
                    throw error;
                }
            }
            
            // =================================================================
            // NEW VIEW STATISTICS CALCULATION
            // =================================================================
            
            function updateViewStatistics() {
                const activeProblems = allProblems.filter(p => p.status !== 'Completed');
                const completedProblems = allProblems.filter(p => p.status === 'Completed');
                
                document.getElementById('activeCount').textContent = activeProblems.length;
                document.getElementById('completedCount').textContent = completedProblems.length;
                document.getElementById('totalCount').textContent = allProblems.length;
                
                console.log(`📊 Statistics - Active: ${activeProblems.length}, Completed: ${completedProblems.length}, Total: ${allProblems.length}`);
            }
            
            // =================================================================
            // ENHANCED FILTERING LOGIC
            // =================================================================
            
            function applyFilters() {
                console.log(`🔍 Applying filters - View: ${currentView}, Priority: ${activePriorityFilter}, Search: "${searchTerm}"`);
                
                // Start with all problems
                let filtered = [...allProblems];
                
                // STEP 1: Filter by view (active vs completed)
                if (currentView === 'active') {
                    filtered = filtered.filter(problem => problem.status !== 'Completed');
                } else {
                    filtered = filtered.filter(problem => problem.status === 'Completed');
                }
                
                // STEP 2: Filter by priority
                if (activePriorityFilter !== 'all') {
                    filtered = filtered.filter(problem => problem.priority === activePriorityFilter);
                }
                
                // STEP 3: Filter by search term
                if (searchTerm) {
                    const term = searchTerm.toLowerCase();
                    filtered = filtered.filter(problem =>
                        problem.unitNumber?.toLowerCase().includes(term) ||
                        problem.description?.toLowerCase().includes(term) ||
                        problem.category?.toLowerCase().includes(term) ||
                        problem.subCategory?.toLowerCase().includes(term) ||
                        problem.residentName?.toLowerCase().includes(term) ||
                        problem.assignedTo?.toLowerCase().includes(term)
                    );
                }
                
                filteredProblems = filtered;
                
                console.log(`✅ Filtered to ${filteredProblems.length} problems`);
                
                // Update UI
                updatePriorityStats();
                updateSearchResults();
            }
            
            // =================================================================
            // ENHANCED PRIORITY STATISTICS
            // =================================================================
            
            function updatePriorityStats() {
                // Get current view problems before priority filtering
                let viewProblems;
                if (currentView === 'active') {
                    viewProblems = allProblems.filter(p => p.status !== 'Completed');
                } else {
                    viewProblems = allProblems.filter(p => p.status === 'Completed');
                }
                
                // Apply search filter to view problems
                if (searchTerm) {
                    const term = searchTerm.toLowerCase();
                    viewProblems = viewProblems.filter(problem =>
                        problem.unitNumber?.toLowerCase().includes(term) ||
                        problem.description?.toLowerCase().includes(term) ||
                        problem.category?.toLowerCase().includes(term) ||
                        problem.subCategory?.toLowerCase().includes(term) ||
                        problem.residentName?.toLowerCase().includes(term) ||
                        problem.assignedTo?.toLowerCase().includes(term)
                    );
                }
                
                // Count by priority
                const stats = {
                    all: viewProblems.length,
                    Urgent: viewProblems.filter(p => p.priority === 'Urgent').length,
                    High: viewProblems.filter(p => p.priority === 'High').length,
                    Medium: viewProblems.filter(p => p.priority === 'Medium').length,
                    Low: viewProblems.filter(p => p.priority === 'Low').length
                };
                
                // Update UI
                document.getElementById('allCount').textContent = stats.all;
                document.getElementById('urgentCount').textContent = stats.Urgent;
                document.getElementById('highCount').textContent = stats.High;
                document.getElementById('mediumCount').textContent = stats.Medium;
                document.getElementById('lowCount').textContent = stats.Low;
            }
            
            // =================================================================
            // ENHANCED PROBLEM RENDERING WITH COMPLETED STYLING
            // =================================================================
            
            function renderProblems() {
                const problemsList = document.getElementById('problemsList');
                const problemsCount = document.getElementById('problemsCount');
                
                problemsCount.textContent = filteredProblems.length;
                
                if (filteredProblems.length === 0) {
                    problemsList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">${currentView === 'active' ? '📋' : '✅'}</div>
                            <h3>No ${currentView} problems found</h3>
                            <p>${getEmptyStateMessage()}</p>
                        </div>
                    `;
                    return;
                }
                
                // Sort problems by priority and date
                const sortedProblems = [...filteredProblems].sort((a, b) => {
                    const aPriorityIndex = PRIORITY_ORDER.indexOf(a.priority);
                    const bPriorityIndex = PRIORITY_ORDER.indexOf(b.priority);
                    
                    if (aPriorityIndex !== bPriorityIndex) {
                        return aPriorityIndex - bPriorityIndex;
                    }
                    
                    return new Date(b.reportedDate) - new Date(a.reportedDate);
                });
                
                problemsList.innerHTML = sortedProblems.map(problem => `
                    <div class="problem-item ${problem.status === 'Completed' ? 'completed' : ''}" onclick="showProblemDetails('${problem.internalId}')">
                        <div class="problem-header">
                            <div class="problem-left">
                                <div class="problem-id">#${problem.internalId}</div>
                                <div class="problem-unit">Unit ${problem.unitNumber}</div>
                            </div>
                            <div class="problem-right">
                                <div class="problem-date">${formatDate(problem.reportedDate)}</div>
                                <div class="problem-priority ${problem.priority?.toLowerCase()}">${problem.priority}</div>
                            </div>
                        </div>
                        <div class="problem-description">${problem.description}</div>
                        <div class="problem-meta">
                            <span>📂 ${problem.category || 'No Category'}</span>
                            <span>🔧 ${problem.assignedTo || 'Unassigned'}</span>
                            <span>📊 ${problem.status}</span>
                            ${problem.status === 'Completed' && problem.completionDate ? 
                                `<span>✅ Completed: ${formatDate(problem.completionDate)}</span>` : ''}
                        </div>
                    </div>
                `).join('');
            }
            
            function getEmptyStateMessage() {
                if (currentView === 'active') {
                    if (searchTerm) {
                        return `No active problems match your search for "${searchTerm}".`;
                    }
                    if (activePriorityFilter !== 'all') {
                        return `No active problems with ${activePriorityFilter} priority.`;
                    }
                    return 'Great! No active maintenance problems found.';
                } else {
                    if (searchTerm) {
                        return `No completed problems match your search for "${searchTerm}".`;
                    }
                    if (activePriorityFilter !== 'all') {
                        return `No completed problems with ${activePriorityFilter} priority.`;
                    }
                    return 'No completed problems found in the system.';
                }
            }
            
            // =================================================================
            // UTILITY FUNCTIONS (UNCHANGED)
            // =================================================================
            
            function captureSearchParameter() {
                const urlParams = new URLSearchParams(window.location.search);
                const searchParam = urlParams.get('search');
                if (searchParam) {
                    pendingSearchParam = decodeURIComponent(searchParam);
                    console.log('🔍 URL search parameter captured:', pendingSearchParam);
                }
            }
            
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
            
            function formatDate(dateString) {
                if (!dateString) return 'No Date';
                try {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('en-AU', { 
                        day: '2-digit', 
                        month: '2-digit', 
                        year: 'numeric' 
                    });
                } catch (error) {
                    return dateString;
                }
            }
            
            function showNotification(message, type = 'info', duration = 3000) {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 18px;">${type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️'}</span>
                        <span style="font-weight: 600;">${message}</span>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => notification.classList.add('show'), 100);
                
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 300);
                }, duration);
            }
            
            // =================================================================
            // AUTHENTICATION (UNCHANGED)
            // =================================================================
            
            function showLogin() {
                document.getElementById('loginView').classList.remove('hidden');
                document.getElementById('mainView').classList.add('hidden');
                document.getElementById('passwordInput').focus();
            }
            
            function showMainPortal() {
                document.getElementById('loginView').classList.add('hidden');
                document.getElementById('mainView').classList.remove('hidden');
            }
            
            function handleLogin(e) {
                e.preventDefault();
                const password = document.getElementById('passwordInput').value;
                
                if (password === MAINTENANCE_PASSWORD) {
                    isAuthenticated = true;
                    showMainPortal();
                    initializeSystem();
                } else {
                    showNotification('Invalid password. Please try again.', 'error');
                    document.getElementById('passwordInput').value = '';
                    document.getElementById('passwordInput').focus();
                }
            }
            
            function handleLogout() {
                isAuthenticated = false;
                allProblems = [];
                filteredProblems = [];
                currentProblem = null;
                currentView = 'active';
                activePriorityFilter = 'all';
                searchTerm = '';
                
                document.getElementById('passwordInput').value = '';
                showLogin();
                showNotification('Logged out successfully', 'info');
            }
            
            function togglePasswordVisibility() {
                const passwordInput = document.getElementById('passwordInput');
                const toggleBtn = document.getElementById('togglePassword');
                
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    toggleBtn.textContent = '🙈';
                } else {
                    passwordInput.type = 'password';
                    toggleBtn.textContent = '👁️';
                }
            }
            
            // =================================================================
            // SYSTEM INITIALIZATION (UPDATED)
            // =================================================================
            
            async function initializeSystem() {
                console.log('🚀 Initializing Maintenance Portal...');
                
                showLoadingOverlay();
                
                try {
                    updateLoadingProgress(20, 'Loading system data...');
                    
                    // Load all problems (active + completed)
                    await loadProblems();
                    updateLoadingProgress(60, 'Processing problem data...');
                    
                    // Set initial view to active
                    currentView = 'active';
                    updateLoadingProgress(80, 'Applying filters...');
                    
                    // Apply filters and render
                    applyFilters();
                    renderProblems();
                    
                    updateLoadingProgress(100, 'System ready!');
                    
                    // Handle pending search parameter
                    if (pendingSearchParam) {
                        document.getElementById('searchInput').value = pendingSearchParam;
                        searchTerm = pendingSearchParam;
                        applyFilters();
                        renderProblems();
                        pendingSearchParam = null;
                        showNotification(`Searched for: "${searchTerm}"`, 'info');
                    }
                    
                    setTimeout(() => {
                        hideLoadingOverlay();
                        document.getElementById('dataStatus').textContent = 'Data Ready';
                        document.getElementById('dataStatus').className = 'data-indicator ready';
                        showNotification('System initialized successfully', 'success');
                    }, 500);
                    
                } catch (error) {
                    console.error('❌ System initialization failed:', error);
                    hideLoadingOverlay();
                    document.getElementById('dataStatus').textContent = 'Error';
                    document.getElementById('dataStatus').className = 'data-indicator error';
                    showNotification('Failed to load system data', 'error');
                }
            }
            
            // =================================================================
            // SEARCH FUNCTIONALITY (UNCHANGED)
            // =================================================================
            
            function handleSearch(e) {
                searchTerm = e.target.value.trim();
                
                const clearBtn = document.getElementById('clearSearch');
                if (searchTerm) {
                    clearBtn.classList.add('visible');
                } else {
                    clearBtn.classList.remove('visible');
                }
                
                applyFilters();
                renderProblems();
            }
            
            function clearSearch() {
                searchTerm = '';
                document.getElementById('searchInput').value = '';
                document.getElementById('clearSearch').classList.remove('visible');
                applyFilters();
                renderProblems();
            }
            
            function updateSearchResults() {
                const searchResults = document.getElementById('searchResults');
                
                if (searchTerm) {
                    searchResults.textContent = `Found ${filteredProblems.length} ${currentView} problems matching "${searchTerm}"`;
                } else {
                    const totalInView = currentView === 'active' ? 
                        allProblems.filter(p => p.status !== 'Completed').length :
                        allProblems.filter(p => p.status === 'Completed').length;
                    searchResults.textContent = `Showing ${filteredProblems.length} of ${totalInView} ${currentView} problems`;
                }
            }
            
            // =================================================================
            // PRIORITY FILTERING (UNCHANGED)
            // =================================================================
            
            function setPriorityFilter(priority) {
                activePriorityFilter = priority;
                
                // Update UI
                document.querySelectorAll('.priority-card').forEach(card => {
                    card.classList.remove('active');
                });
                
                document.querySelector(`[data-priority="${priority}"]`).classList.add('active');
                
                applyFilters();
                renderProblems();
            }
            
            // =================================================================
            // PROBLEM DETAILS (UNCHANGED)
            // =================================================================
            
            function showProblemDetails(internalId) {
                const problem = allProblems.find(p => p.internalId === internalId);
                if (!problem) return;
                
                currentProblem = problem;
                
                // Update details page
                document.getElementById('problemPageTitle').textContent = `Problem #${problem.internalId}`;
                
                // Basic details
                document.getElementById('detailProblemId').textContent = problem.internalId || '-';
                document.getElementById('detailUnitNumber').textContent = problem.unitNumber || '-';
                document.getElementById('detailReportedDate').textContent = formatDate(problem.reportedDate);
                document.getElementById('detailZone').textContent = problem.zone || '-';
                document.getElementById('detailDescription').textContent = problem.description || '-';
                
                // Management details
                document.getElementById('detailPriority').textContent = problem.priority || '-';
                document.getElementById('detailStatus').textContent = problem.status || '-';
                document.getElementById('detailCategory').textContent = problem.category || '-';
                document.getElementById('detailSubCategory').textContent = problem.subCategory || '-';
                document.getElementById('detailAssignedTo').textContent = problem.assignedTo || '-';
                document.getElementById('detailCompletionDate').textContent = formatDate(problem.completionDate) || '-';
                document.getElementById('detailWorkNotes').textContent = problem.workNotes || 'No work notes available';
                
                // Contact details
                document.getElementById('detailResidentName').textContent = problem.residentName || '-';
                document.getElementById('detailPhoneNumber').textContent = problem.phoneNumber || '-';
                document.getElementById('detailEmailAddress').textContent = problem.emailAddress || '-';
                document.getElementById('detailEmergencyContact').textContent = problem.emergencyContact || '-';
                
                showDetailsView();
            }
            
            function showDetailsView() {
                document.getElementById('listView').classList.add('hidden');
                document.getElementById('problemDetailsView').classList.remove('hidden');
            }
            
            function showListView() {
                document.getElementById('problemDetailsView').classList.add('hidden');
                document.getElementById('listView').classList.remove('hidden');
            }
            
            // =================================================================
            // DATA REFRESH (UPDATED)
            // =================================================================
            
            async function refreshData() {
                console.log('🔄 Refreshing data...');
                
                try {
                    document.getElementById('dataStatus').textContent = 'Refreshing...';
                    document.getElementById('dataStatus').className = 'data-indicator loading';
                    
                    await loadProblems();
                    applyFilters();
                    renderProblems();
                    
                    document.getElementById('dataStatus').textContent = 'Data Ready';
                    document.getElementById('dataStatus').className = 'data-indicator ready';
                    
                    showNotification('Data refreshed successfully', 'success');
                } catch (error) {
                    console.error('❌ Refresh failed:', error);
                    document.getElementById('dataStatus').textContent = 'Error';
                    document.getElementById('dataStatus').className = 'data-indicator error';
                    showNotification('Failed to refresh data', 'error');
                }
            }
            
            // =================================================================
            // LOADING OVERLAY MANAGEMENT (UNCHANGED)
            // =================================================================
            
            function showLoadingOverlay() {
                document.getElementById('loadingOverlay').classList.remove('hidden');
                updateLoadingProgress(0, 'Initializing...');
            }
            
            function hideLoadingOverlay() {
                document.getElementById('loadingOverlay').classList.add('hidden');
            }
            
            function updateLoadingProgress(percentage, phase, detail = '') {
                document.getElementById('loadingProgressBar').style.width = percentage + '%';
                document.getElementById('loadingPhase').textContent = phase;
                if (detail) {
                    document.getElementById('loadingDetail').textContent = detail;
                }
            }
            
            // =================================================================
            // API COMMUNICATION (UNCHANGED)
            // =================================================================
            
            function makeRequest(params) {
                return new Promise((resolve, reject) => {
                    const callbackName = 'callback_' + Math.random().toString(36).substr(2, 9);
                    
                    window[callbackName] = function(response) {
                        delete window[callbackName];
                        const script = document.querySelector(`script[src*="${callbackName}"]`);
                        if (script) {
                            document.body.removeChild(script);
                        }
                        resolve(response);
                    };
                    
                    const script = document.createElement('script');
                    const url = new URL(WEB_APP_URL);
                    
                    Object.keys(params).forEach(key => {
                        url.searchParams.append(key, params[key]);
                    });
                    
                    script.src = url.toString() + (url.toString().includes('?') ? '&' : '?') + 'callback=' + callbackName;
                    document.body.appendChild(script);
                    
                    // Timeout after 10 seconds
                    setTimeout(() => {
                        if (window[callbackName]) {
                            delete window[callbackName];
                            document.body.removeChild(script);
                            reject(new Error('JSONP request timeout'));
                        }
                    }, 10000);
                });
            }
        </script>
    </body>
</html>
