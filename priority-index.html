<!--
=================================================================
PRIORITY PORTAL v1.0 - PHASE 1: HTML STRUCTURE & CSS
=================================================================
 * Version: v1.0 - Priority-Based Management System
 * Created: July 17, 2025
 * Status: üöß PHASE 1 - HTML Structure & CSS Complete
 * 
 * SIMPLIFIED APPROACH:
 * - No drag & drop functionality
 * - Priority-based automatic sorting
 * - Clean, streamlined interface
 * - Same backend as Maintenance Portal v2.6
 * 
 * PHASE 1 INCLUDES:
 * ‚úÖ Complete HTML structure
 * ‚úÖ Simplified CSS (no drag styles)
 * ‚úÖ Login screen layout
 * ‚úÖ List view layout
 * ‚úÖ Editor layout
 * ‚úÖ Modal structures
 * 
 * NEXT PHASES:
 * - Phase 2: JavaScript Core & Configuration
 * - Phase 3: Priority Sorting Logic
 * - Phase 4: Final Integration & Testing
=================================================================
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Priority Portal v1.0 - Smart Priority Management System</title>
    <style>
        /* ===================================================================
                                BASE STYLES & LAYOUT
        =================================================================== */
        
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
        }
        
        body { 
            font-family: Arial, sans-serif; 
            background: #f5f5f5; 
            line-height: 1.6;
        }
        
        .hidden { 
            display: none !important; 
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        
        /* ===================================================================
                                LOGIN SCREEN STYLES
        =================================================================== */
        
        .login-screen { 
            min-height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .login-box { 
            background: white; 
            padding: 40px; 
            border-radius: 15px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.1); 
            max-width: 450px; 
            width: 100%; 
        }
        
        .login-header { 
            text-align: center; 
            margin-bottom: 30px; 
        }
        
        .login-title { 
            font-size: 28px; 
            font-weight: bold; 
            color: #2563eb; 
            margin-bottom: 5px; 
        }
        
        .login-subtitle { 
            color: #666; 
            margin-bottom: 20px; 
            font-size: 16px;
        }
        
        .version-badge {
            background: #e0f2fe;
            color: #0277bd;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
            margin-bottom: 15px;
        }
        
        .data-status { 
            margin-bottom: 15px; 
            padding: 12px; 
            border-radius: 8px; 
            font-size: 13px; 
            text-align: center; 
            font-weight: 500;
        }
        
        .data-status.loading { 
            background: #e3f2fd; 
            color: #1976d2; 
        }
        
        .data-status.live { 
            background: #e8f5e8; 
            color: #2e7d32; 
        }
        
        .data-status.sample { 
            background: #fff3e0; 
            color: #f57c00; 
        }
        
        .data-status.error { 
            background: #ffebee; 
            color: #c62828; 
        }
        
        .priority-info {
            background: #f0f9ff;
            border-left: 4px solid #0ea5e9;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 0 8px 8px 0;
        }
        
        .priority-info h4 {
            color: #0c4a6e;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .priority-info p {
            color: #075985;
            font-size: 13px;
            margin: 0;
        }
        
        .warning-box { 
            background: #fff3cd; 
            border-left: 4px solid #ffc107; 
            padding: 15px; 
            margin-bottom: 20px; 
            border-radius: 0 8px 8px 0;
        }
        
        .warning-text { 
            color: #856404; 
            font-size: 14px; 
        }
        
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 500; 
            color: #333; 
        }
        
        .form-input { 
            width: 100%; 
            padding: 14px; 
            border: 2px solid #e5e7eb; 
            border-radius: 8px; 
            font-size: 16px; 
            transition: border-color 0.3s ease;
        }
        
        .form-input:focus { 
            outline: none; 
            border-color: #2563eb; 
            box-shadow: 0 0 0 3px rgba(37,99,235,0.1); 
        }
        
        .form-input:disabled { 
            background: #f9fafb; 
            color: #6b7280; 
        }
        
        .error-message { 
            background: #fee2e2; 
            color: #dc2626; 
            padding: 12px; 
            border-radius: 8px; 
            margin-bottom: 15px; 
            font-size: 14px;
        }
        
        /* ===================================================================
                                BUTTON STYLES
        =================================================================== */
        
        .btn { 
            padding: 14px 24px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 16px; 
            font-weight: 500; 
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary { 
            background: #2563eb; 
            color: white; 
            width: 100%; 
        }
        
        .btn-primary:hover { 
            background: #1d4ed8; 
            transform: translateY(-1px);
        }
        
        .btn-primary:disabled { 
            background: #9ca3af; 
            cursor: not-allowed; 
            transform: none;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .btn-logout {
            background: #dc2626;
            color: white;
        }
        
        .btn-logout:hover {
            background: #b91c1c;
        }
        
        /* ===================================================================
                                HEADER STYLES
        =================================================================== */
        
        .header { 
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); 
            color: white; 
            padding: 20px 0; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .header h1 { 
            font-size: 28px; 
            margin-bottom: 5px; 
        }
        
        .header p { 
            opacity: 0.9; 
            margin: 0;
            font-size: 16px;
        }
        
        .header-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .priority-indicator {
            background: rgba(255,255,255,0.15);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            backdrop-filter: blur(10px);
        }
        
        /* ===================================================================
                                SEARCH & FILTER STYLES
        =================================================================== */
        
        .search-section { 
            background: white; 
            padding: 25px; 
            border-radius: 12px; 
            margin-bottom: 20px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .search-section h2 { 
            margin-bottom: 15px; 
            color: #1f2937;
            font-size: 20px;
        }
        
        .search-box { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 20px;
        }
        
        .search-input { 
            flex: 1; 
            padding: 12px 16px; 
            border: 2px solid #e5e7eb; 
            border-radius: 8px; 
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .search-input:focus {
            border-color: #2563eb;
            outline: none;
        }
        
        .search-btn { 
            background: #2563eb; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }
        
        .search-btn:hover { 
            background: #1d4ed8; 
        }
        
        .filter-tabs {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .filter-tab {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            color: #6b7280;
        }
        
        .filter-tab.active {
            background: #2563eb;
            border-color: #2563eb;
            color: white;
        }
        
        .filter-tab:hover {
            border-color: #2563eb;
            color: #2563eb;
        }
        
        .filter-tab.active:hover {
            color: white;
        }
        
        /* ===================================================================
                                PROBLEMS LIST STYLES
        =================================================================== */
        
        .problems-list { 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
        }
        
        .problem-card { 
            background: white; 
            border-radius: 12px; 
            padding: 20px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
            cursor: pointer; 
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .problem-card:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 16px rgba(0,0,0,0.1); 
        }
        
        .problem-card.urgent { border-left-color: #dc2626; }
        .problem-card.high { border-left-color: #ea580c; }
        .problem-card.medium { border-left-color: #d97706; }
        .problem-card.low { border-left-color: #16a34a; }
        
        .problem-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .problem-id { 
            font-size: 18px; 
            font-weight: bold; 
            color: #1f2937; 
            margin-bottom: 5px;
        }
        
        .problem-unit { 
            color: #6b7280; 
            font-size: 14px; 
            font-weight: 500;
        }
        
        .problem-badges {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .badge { 
            padding: 4px 12px; 
            border-radius: 20px; 
            font-size: 12px; 
            font-weight: 600; 
            text-transform: uppercase;
        }
        
        .badge.urgent { background: #fecaca; color: #991b1b; }
        .badge.high { background: #fed7aa; color: #9a3412; }
        .badge.medium { background: #fde68a; color: #92400e; }
        .badge.low { background: #bbf7d0; color: #166534; }
        
        .badge.reported { background: #dbeafe; color: #1e40af; }
        .badge.in-progress { background: #fef3c7; color: #92400e; }
        .badge.on-hold { background: #e0e7ff; color: #5b21b6; }
        .badge.completed { background: #d1fae5; color: #065f46; }
        .badge.cancelled { background: #f3f4f6; color: #374151; }
        
        .problem-description { 
            color: #374151; 
            margin-bottom: 15px; 
            line-height: 1.5;
            font-size: 15px;
        }
        
        .problem-footer { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            color: #6b7280; 
            font-size: 13px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .problem-reporter {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .problem-date {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* ===================================================================
                                EDITOR STYLES
        =================================================================== */
        
        .editor { 
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
        }
        
        .section { 
            margin-bottom: 35px; 
        }
        
        .section-title { 
            font-size: 20px; 
            font-weight: bold; 
            margin-bottom: 20px; 
            padding-bottom: 10px; 
            border-bottom: 2px solid #e5e7eb; 
            color: #1f2937;
        }
        
        .form-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
        }
        
        .form-field { 
            margin-bottom: 20px; 
        }
        
        .form-field.full-width { 
            grid-column: 1 / -1; 
        }
        
        .form-field.read-only .form-input {
            background: #f9fafb;
            color: #6b7280;
            border-color: #e5e7eb;
        }
        
        .textarea { 
            resize: vertical; 
            min-height: 100px; 
            font-family: inherit;
        }
        
        .save-btn { 
            background: #16a34a; 
            color: white; 
            padding: 15px 30px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 16px; 
            font-weight: 500;
            float: right;
            transition: background-color 0.3s ease;
        }
        
        .save-btn:hover { 
            background: #15803d; 
        }
        
        /* ===================================================================
                                REPORT STYLES
        =================================================================== */
        
        .report-section { 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            margin-bottom: 20px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .report-btn { 
            display: block; 
            width: 100%; 
            margin-bottom: 10px; 
            padding: 15px; 
            background: #2563eb; 
            color: white; 
            text-decoration: none; 
            text-align: center; 
            border-radius: 8px; 
            border: none; 
            cursor: pointer; 
            font-size: 15px;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }
        
        .report-btn:hover { 
            background: #1d4ed8; 
        }
        
        .report-btn.green { 
            background: #16a34a; 
        }
        
        .report-btn.green:hover { 
            background: #15803d; 
        }
        
        /* ===================================================================
                                MODAL STYLES
        =================================================================== */
        
        .modal { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.6); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        
        .modal-content { 
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            max-width: 600px; 
            max-height: 80vh; 
            overflow-y: auto; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 90%;
        }
        
        .modal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
        }
        
        .modal-header h3 {
            color: #1f2937;
            font-size: 20px;
        }
        
        .close-btn { 
            background: none; 
            border: none; 
            font-size: 24px; 
            cursor: pointer; 
            color: #6b7280;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }
        
        .close-btn:hover {
            background: #f3f4f6;
        }
        
        .report-text { 
            font-family: 'Courier New', monospace; 
            white-space: pre-wrap; 
            font-size: 13px; 
            line-height: 1.5; 
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        /* ===================================================================
                                UTILITY STYLES
        =================================================================== */
        
        .loading-spinner { 
            display: inline-block; 
            width: 20px; 
            height: 20px; 
            border: 3px solid #f3f3f3; 
            border-top: 3px solid #2563eb; 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        .no-data { 
            text-align: center; 
            padding: 60px 20px; 
            color: #6b7280; 
        }
        
        .no-data h3 { 
            margin-bottom: 10px; 
            color: #9ca3af; 
            font-size: 18px;
        }
        
        .back-btn {
            background: #6b7280;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }
        
        .back-btn:hover {
            background: #4b5563;
        }
        
        /* ===================================================================
                                RESPONSIVE DESIGN
        =================================================================== */
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .login-box {
                margin: 20px;
                padding: 30px;
            }
            
            .login-title {
                font-size: 24px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .search-box {
                flex-direction: column;
            }
            
            .problem-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .problem-badges {
                align-self: stretch;
                justify-content: flex-start;
            }
            
            .modal-content {
                margin: 20px;
                padding: 20px;
            }
            
            .editor {
                padding: 20px;
            }
        }
        
        @media (max-width: 480px) {
            .filter-tabs {
                gap: 5px;
            }
            
            .filter-tab {
                padding: 6px 12px;
                font-size: 13px;
            }
            
            .problem-card {
                padding: 15px;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <div class="login-header">
                <h1 class="login-title">Priority Portal</h1>
                <div class="version-badge">v1.0</div>
                <p class="login-subtitle">Smart Priority Management System</p>
                
                <div class="priority-info">
                    <h4>üéØ Intelligent Workflow</h4>
                    <p>Automatic priority-based sorting ‚Ä¢ No manual reordering needed ‚Ä¢ Smart problem management</p>
                </div>
                
                <div id="dataStatus" class="data-status loading">
                    <span class="loading-spinner"></span> Connecting to live data...
                </div>
            </div>
            
            <div class="warning-box">
                <div class="warning-text">
                    <strong>Authorized Personnel Only</strong><br>
                    This system contains sensitive maintenance data. Unauthorized access is prohibited.
                </div>
            </div>
            
            <div class="form-group">
                <label for="password" class="form-label">Password</label>
                <input type="password" id="password" class="form-input" placeholder="Enter maintenance password">
            </div>
            
            <div id="errorMessage" class="error-message hidden"></div>
            
            <button id="loginBtn" class="btn btn-primary">
                üîê Access Priority Portal
            </button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp" class="hidden">
        <!-- LIST VIEW -->
        <div id="listView">
            <div class="header">
                <div class="container">
                    <div class="header-content">
                        <div>
                            <h1>Priority Portal</h1>
                            <p>Smart Priority Management System</p>
                        </div>
                        <div class="header-right">
                            <div class="priority-indicator">
                                üéØ Auto-Sorted by Priority
                            </div>
                            <button id="refreshBtn" class="btn btn-secondary">üîÑ Refresh</button>
                            <button id="logoutBtn" class="btn btn-logout">üö™ Logout</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="container">
                <div class="search-section">
                    <h2>Search by Problem ID (PID)</h2>
                    <div class="search-box">
                        <input type="text" id="searchInput" class="search-input" placeholder="PID 110716">
                        <button id="searchBtn" class="search-btn">Search</button>
                    </div>
                    
                    <div class="filter-tabs">
                        <div class="filter-tab active" data-filter="all">All Problems</div>
                        <div class="filter-tab" data-filter="reported">Reported</div>
                        <div class="filter-tab" data-filter="in-progress">In Progress</div>
                        <div class="filter-tab" data-filter="on-hold">On Hold</div>
                        <div class="filter-tab" data-filter="completed">Completed</div>
                        <div class="filter-tab" data-filter="cancelled">Cancelled</div>
                    </div>
                </div>
                
                <h3 id="resultsCount">All Problems (0)</h3>
                
                <div class="report-section">
                    <button id="viewListReport" class="report-btn">üìÑ View Report</button>
                    <button id="copyListReport" class="report-btn green">üìã Copy Report</button>
                </div>
                
                <div id="problemsList" class="problems-list">
                    <!-- Problems will be inserted here by JavaScript -->
                </div>
            </div>
        </div>

        <!-- EDITOR VIEW -->
        <div id="editorView" class="hidden">
            <div class="header">
                <div class="container">
                    <div class="header-content">
                        <div>
                            <h1>Problem Editor</h1>
                            <p id="editorPID">PID 110716</p>
                        </div>
                        <div class="header-right">
                            <button id="backBtn" class="back-btn">‚Üê Back to List</button>
                            <button id="refreshBtnEditor" class="btn btn-secondary">üîÑ Refresh</button>
                            <button id="logoutBtnEditor" class="btn btn-logout">üö™ Logout</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="container">
                <div class="editor">
                    <div class="section">
                        <div class="section-title">üìã Problem Details</div>
                        <div class="form-grid">
                            <div class="form-field read-only">
                                <label class="form-label">Reported Date</label>
                                <input type="text" id="reportedDate" class="form-input" readonly>
                            </div>
                            <div class="form-field read-only">
                                <label class="form-label">Unit Number</label>
                                <input type="text" id="unitNumber" class="form-input" readonly>
                            </div>
                            <div class="form-field read-only">
                                <label class="form-label">Reported By</label>
                                <input type="text" id="reportedBy" class="form-input" readonly>
                            </div>
                            <div class="form-field read-only">
                                <label class="form-label">Zone</label>
                                <input type="text" id="zone" class="form-input" readonly>
                            </div>
                            <div class="form-field read-only">
                                <label class="form-label">Unit Owner Name</label>
                                <input type="text" id="residentName" class="form-input" readonly>
                            </div>
                            <div class="form-field read-only">
                                <label class="form-label">Unit Contact</label>
                                <input type="text" id="residentMobile" class="form-input" readonly>
                            </div>
                            <div class="form-field full-width read-only">
                                <label class="form-label">Problem Description</label>
                                <textarea id="problemDescription" class="form-input textarea" readonly></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">üîß Management Details</div>
                        <div class="form-grid">
                            <div class="form-field">
                                <label class="form-label">Category</label>
                                <select id="category" class="form-input">
                                    <option value="">Select Category</option>
                                </select>
                            </div>
                            <div class="form-field">
                                <label class="form-label">Sub-Category</label>
                                <select id="subCategory" class="form-input">
                                    <option value="">Select Sub-Category</option>
                                </select>
                            </div>
                            <div class="form-field">
                                <label class="form-label">Priority</label>
                                <select id="priority" class="form-input">
                                    <option value="Low">Low</option>
                                    <option value="Medium">Medium</option>
                                    <option value="High">High</option>
                                    <option value="Urgent">Urgent</option>
                                </select>
                            </div>
                            <div class="form-field">
                                <label class="form-label">Status</label>
                                <select id="status" class="form-input">
                                    <option value="Reported">Reported</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="On Hold">On Hold</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Cancelled">Cancelled</option>
                                </select>
                            </div>
                            <div class="form-field">
                                <label class="form-label">Assigned To</label>
                                <select id="assignedTo" class="form-input">
                                    <option value="">Select Assignee</option>
                                </select>
                            </div>
                            <div class="form-field">
                                <label class="form-label">Completion Date</label>
                                <input type="date" id="completionDate" class="form-input">
                            </div>
                            <div class="form-field full-width">
                                <label class="form-label">Internal Comments</label>
                                <textarea id="internalComments" class="form-input textarea" placeholder="Add internal notes..."></textarea>
                            </div>
                        </div>
                    </div>

                    <button id="saveBtn" class="save-btn">üíæ Save Changes</button>
                    <div style="clear: both;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- REPORT MODAL -->
    <div id="reportModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Report Preview</h3>
                <button id="closeReportModal" class="close-btn">√ó</button>
            </div>
            <div class="report-text" id="reportText"></div>
            <div style="margin-top: 20px;">
                <button id="copyModalReport" class="btn btn-primary">üìã Copy Report</button>
            </div>
        </div>
    </div>

    <!-- AUTO-SYNC NOTIFICATION MODAL -->
    <div id="autoSyncModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üîÑ Data Updated</h3>
                <button id="closeAutoSyncModal" class="close-btn">√ó</button>
            </div>
            <p>The problem list has been updated with new data from another session.</p>
            <div style="margin-top: 20px;">
                <button id="refreshDataBtn" class="btn btn-primary">üîÑ Refresh Now</button>
            </div>
        </div>
    </div>

    
</body>
</html>

<script>
    

/* ===================================================================
   PRIORITY PORTAL v1.0 - PHASE 2: JAVASCRIPT CORE & CONFIGURATION
   ===================================================================
   
   üéØ PHASE 2 INCLUDES:
   ‚úÖ Configuration constants
   ‚úÖ Global state management  
   ‚úÖ Authentication system
   ‚úÖ Data loading functions
   ‚úÖ Sample data structure
   ‚úÖ Dynamic dropdown management
   ‚úÖ Utility functions
   
   üîÑ SIMPLIFIED APPROACH:
   - No drag & drop state management
   - Priority-based data organization
   - Clean authentication flow
   - Same backend API as Maintenance Portal v2.6
   
   üìå INSERT LOCATION: Replace the placeholder <script> section in Phase 1 HTML
   
=================================================================== */

/* ===================================================================
                     CONFIGURATION & CONSTANTS
=================================================================== */


    
// API Configuration
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwbXAKuE3sH9xnRFVpuCWsW97W_USNcjgSVmgPcWmTFrwU9TA0QEK8V32NH9gNwCAat/exec';
const MAINTENANCE_PASSWORD = "maint2025";

// Priority Portal Configuration
const PRIORITY_ORDER = ['Urgent', 'High', 'Medium', 'Low'];
const STATUS_ORDER = ['Reported', 'In Progress', 'On Hold', 'Completed', 'Cancelled'];

/* ===================================================================
                        GLOBAL STATE MANAGEMENT
=================================================================== */

// Authentication State
let isAuthenticated = false;
let loginAttempts = 0;
const MAX_LOGIN_ATTEMPTS = 3;
let lockoutUntil = null;

// Application State
let currentView = 'list'; // 'list' or 'editor'
let currentProblem = null;
let problems = [];
let filteredProblems = [];
let searchTerm = '';
let activeFilter = 'all';

// Data Connection State
let dataConnectionStatus = 'loading'; // 'loading', 'live', 'sample', 'error'
let lastDataHash = '';
let autoSyncInterval = null;

// Dynamic Dropdown Data
let dynamicDropdownData = {
    categories: [],
    subCategories: [],
    assignedTo: []
};

/* ===================================================================
                        SAMPLE DATA STRUCTURE
=================================================================== */

const sampleData = [
    {
        internalId: '20250115-110716',
        reportedDate: '15/01/2025',
        unitNumber: 'A-201',
        reportedBy: 'John Smith',
        zone: 'Zone A',
        residentName: 'John Smith',
        residentMobile: '0412345678',
        problemDescription: 'Kitchen faucet leaking continuously, water damage to cabinet below',
        priority: 'Urgent',
        status: 'Reported',
        category: 'Plumbing',
        subCategory: 'Faucet/Tap',
        assignedTo: '',
        completionDate: '',
        internalComments: 'Requires immediate attention',
        sortOrder: 1
    },
    {
        internalId: '20250114-143022',
        reportedDate: '14/01/2025',
        unitNumber: 'B-105',
        reportedBy: 'Sarah Johnson',
        zone: 'Zone B',
        residentName: 'Sarah Johnson',
        residentMobile: '0423456789',
        problemDescription: 'Air conditioning unit not cooling properly, temperature not reaching set point',
        priority: 'High',
        status: 'In Progress',
        category: 'Aircon',
        subCategory: 'General',
        assignedTo: 'Ben',
        completionDate: '',
        internalComments: 'Technician scheduled for tomorrow',
        sortOrder: 2
    },
    {
        internalId: '20250112-092345',
        reportedDate: '12/01/2025',
        unitNumber: 'C-302',
        reportedBy: 'David Wilson',
        zone: 'Zone C',
        residentName: 'David Wilson',
        residentMobile: '0434567890',
        problemDescription: 'Bathroom exhaust fan making loud grinding noise',
        priority: 'Medium',
        status: 'Completed',
        category: 'Electrical',
        subCategory: 'General',
        assignedTo: 'Jade',
        completionDate: '13/01/2025',
        internalComments: 'Fan motor replaced, working normally',
        sortOrder: 3
    },
    {
        internalId: '20250110-165530',
        reportedDate: '10/01/2025',
        unitNumber: 'D-404',
        reportedBy: 'Lisa Chen',
        zone: 'Zone D',
        residentName: 'Lisa Chen',
        residentMobile: '0445678901',
        problemDescription: 'Front door lock sticking, key difficult to turn',
        priority: 'Low',
        status: 'On Hold',
        category: 'Doors',
        subCategory: 'General',
        assignedTo: 'David',
        completionDate: '',
        internalComments: 'Waiting for replacement lock mechanism',
        sortOrder: 4
    },
    {
        internalId: '20250108-081245',
        reportedDate: '08/01/2025',
        unitNumber: 'E-501',
        reportedBy: 'Michael Brown',
        zone: 'Zone E',
        residentName: 'Michael Brown',
        residentMobile: '0456789012',
        problemDescription: 'Garden sprinkler system not working in front yard area',
        priority: 'Low',
        status: 'Cancelled',
        category: 'Irrigation',
        subCategory: 'General',
        assignedTo: 'Gardening Club',
        completionDate: '',
        internalComments: 'Resident decided to handle privately',
        sortOrder: 5
    }
];

/* ===================================================================
                        UTILITY FUNCTIONS
=================================================================== */

/**
 * Generate friendly PID from internal ID
 */
function getFriendlyPID(internalId) {
    if (!internalId || typeof internalId !== 'string') return 'PID Unknown';
    
    const parts = internalId.split('-');
    if (parts.length >= 2) {
        return `PID ${parts[1]}`;
    }
    
    return `PID ${internalId}`;
}

/**
 * Priority-based sorting function
 */
function sortByPriority(problems) {
    return [...problems].sort((a, b) => {
        // First sort by priority
        const priorityA = PRIORITY_ORDER.indexOf(a.priority) !== -1 ? PRIORITY_ORDER.indexOf(a.priority) : 999;
        const priorityB = PRIORITY_ORDER.indexOf(b.priority) !== -1 ? PRIORITY_ORDER.indexOf(b.priority) : 999;
        
        if (priorityA !== priorityB) {
            return priorityA - priorityB;
        }
        
        // Then by status (active statuses first)
        const statusA = STATUS_ORDER.indexOf(a.status) !== -1 ? STATUS_ORDER.indexOf(a.status) : 999;
        const statusB = STATUS_ORDER.indexOf(b.status) !== -1 ? STATUS_ORDER.indexOf(b.status) : 999;
        
        if (statusA !== statusB) {
            return statusA - statusB;
        }
        
        // Finally by date (newest first)
        const dateA = new Date(a.reportedDate.split('/').reverse().join('-'));
        const dateB = new Date(b.reportedDate.split('/').reverse().join('-'));
        return dateB - dateA;
    });
}

/**
 * Calculate hash for change detection
 */
function calculateDataHash(data) {
    try {
        const jsonString = JSON.stringify(data.map(p => ({
            id: p.internalId,
            priority: p.priority,
            status: p.status,
            comments: p.internalComments || ''
        })));
        // Use a simple hash instead of btoa to avoid character encoding issues
        let hash = 0;
        for (let i = 0; i < jsonString.length; i++) {
            const char = jsonString.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // Convert to 32-bit integer
        }
        return Math.abs(hash).toString(16).substring(0, 16);
    } catch (error) {
        console.warn('Hash calculation failed:', error);
        return 'fallback-hash';
    }
}

/**
 * Safe JSON parsing
 */
function safeJSONParse(jsonString, fallback = null) {
    try {
        return JSON.parse(jsonString);
    } catch (error) {
        console.warn('JSON parse error:', error);
        return fallback;
    }
}

/**
 * Format date for display
 */
function formatDate(dateString) {
    if (!dateString) return '';
    
    try {
        const parts = dateString.split('/');
        if (parts.length === 3) {
            const date = new Date(parts[2], parts[1] - 1, parts[0]);
            return date.toLocaleDateString('en-AU', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
        }
    } catch (error) {
        console.warn('Date formatting error:', error);
    }
    
    return dateString;
}

/**
 * Debounce function for search
 */
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

/* ===================================================================
                        AUTHENTICATION SYSTEM
=================================================================== */

/**
 * Check if user is locked out
 */
function isLockedOut() {
    if (lockoutUntil && Date.now() < lockoutUntil) {
        const remainingTime = Math.ceil((lockoutUntil - Date.now()) / 1000);
        return remainingTime;
    }
    lockoutUntil = null;
    return false;
}

/**
 * Handle login attempt
 */
function handleLogin() {
    const passwordInput = document.getElementById('password');
    const password = passwordInput.value.trim();
    const errorDiv = document.getElementById('errorMessage');
    const loginBtn = document.getElementById('loginBtn');
    
    // Clear previous errors
    errorDiv.classList.add('hidden');
    
    // Check lockout status
    const lockoutTime = isLockedOut();
    if (lockoutTime) {
        showError(`Too many failed attempts. Try again in ${lockoutTime} seconds.`);
        return;
    }
    
    // Validate password
    if (!password) {
        showError('Please enter a password.');
        return;
    }
    
    // Check password
    if (password === MAINTENANCE_PASSWORD) {
        loginAttempts = 0;
        isAuthenticated = true;
        passwordInput.value = '';
        
        // Show success state
        loginBtn.innerHTML = '‚úÖ Access Granted';
        loginBtn.disabled = true;
        
        setTimeout(() => {
            showMainApp();
            loadProblemsData();
        }, 500);
        
    } else {
        loginAttempts++;
        const remainingAttempts = MAX_LOGIN_ATTEMPTS - loginAttempts;
        
        if (remainingAttempts > 0) {
            showError(`Incorrect password. ${remainingAttempts} attempt(s) remaining.`);
        } else {
            lockoutUntil = Date.now() + (60 * 1000); // 1 minute lockout
            showError('Too many failed attempts. Please wait 1 minute before trying again.');
        }
        
        passwordInput.value = '';
        passwordInput.focus();
    }
}

/**
 * Show error message
 */
function showError(message) {
    const errorDiv = document.getElementById('errorMessage');
    errorDiv.textContent = message;
    errorDiv.classList.remove('hidden');
}

/**
 * Handle logout
 */
function handleLogout() {
    isAuthenticated = false;
    currentView = 'list';
    currentProblem = null;
    
    // Clear auto-sync
    if (autoSyncInterval) {
        clearInterval(autoSyncInterval);
        autoSyncInterval = null;
    }
    
    // Reset UI
    document.getElementById('mainApp').classList.add('hidden');
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('password').value = '';
    document.getElementById('loginBtn').innerHTML = 'üîê Access Priority Portal';
    document.getElementById('loginBtn').disabled = false;
    
    console.log('User logged out');
}

/* ===================================================================
                        UI STATE MANAGEMENT
=================================================================== */

/**
 * Show main application
 */
function showMainApp() {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    showListView();
    
    // Start auto-sync
    startAutoSync();
    
    console.log('Main app displayed');
}

/**
 * Show list view
 */
function showListView() {
    currentView = 'list';
    document.getElementById('listView').classList.remove('hidden');
    document.getElementById('editorView').classList.add('hidden');
    updateProblemsList();
}

/**
 * Show editor view
 */
function showEditorView(problem) {
    currentView = 'editor';
    currentProblem = problem;
    
    document.getElementById('listView').classList.add('hidden');
    document.getElementById('editorView').classList.remove('hidden');
    
    populateEditor(problem);
    
    // Update header PID
    document.getElementById('editorPID').textContent = getFriendlyPID(problem.internalId);
}

/**
 * Update data connection status
 */
function updateDataStatus(status, message = '') {
    dataConnectionStatus = status;
    const statusDiv = document.getElementById('dataStatus');
    
    if (!statusDiv) return;
    
    statusDiv.className = `data-status ${status}`;
    
    switch (status) {
        case 'loading':
            statusDiv.innerHTML = '<span class="loading-spinner"></span> Connecting to live data...';
            break;
        case 'live':
            statusDiv.innerHTML = `üü¢ Live Data - ${message}`;
            break;
        case 'sample':
            statusDiv.innerHTML = `üü° Sample Data - ${message}`;
            break;
        case 'error':
            statusDiv.innerHTML = `üî¥ Connection Error - ${message}`;
            break;
    }
}

/* ===================================================================
                        DATA LOADING FUNCTIONS
=================================================================== */

/**
 * Load problems data from API or fallback to sample
 */
async function loadProblemsData() {
    console.log('Loading problems data...');
    updateDataStatus('loading');
    
    try {
        // Try to load live data first
        const data = await loadLiveData();
        if (data && data.length > 0) {
            problems = data;
            updateDataStatus('live', `${problems.length} problems loaded`);
            
            // Calculate hash for change detection
            lastDataHash = calculateDataHash(problems);
            
            console.log(`‚úÖ Live data loaded: ${problems.length} problems`);
        } else {
            throw new Error('No live data available');
        }
        
    } catch (error) {
        console.warn('Live data failed, using sample data:', error);
        problems = sampleData;
        updateDataStatus('sample', `${problems.length} sample problems`);
        lastDataHash = calculateDataHash(problems);
    }
    
    // Load dynamic dropdowns
    await loadDynamicDropdowns();
    
    // Update UI
    applyFilters();
    updateProblemsList();
}

/**
 * Load live data from Google Sheets API
 */
function loadLiveData() {
    return new Promise((resolve, reject) => {
        const timeout = setTimeout(() => {
            reject(new Error('Request timeout'));
        }, 10000);
        
        const callbackName = 'jsonp_callback_' + Date.now();
        
        window[callbackName] = function(data) {
            clearTimeout(timeout);
            delete window[callbackName];
            
            if (data && data.success && Array.isArray(data.problems)) {
                resolve(data.problems);
            } else {
                reject(new Error('Invalid data format'));
            }
        };
        
        const script = document.createElement('script');
        script.src = `${WEB_APP_URL}?action=getFaultLogData&callback=${callbackName}`;
        script.onerror = () => {
            clearTimeout(timeout);
            delete window[callbackName];
            reject(new Error('Script loading failed'));
        };
        
        document.head.appendChild(script);
        setTimeout(() => {
            if (document.head.contains(script)) {
                document.head.removeChild(script);
            }
        }, 11000);
    });
}

/**
 * Load dynamic dropdown options
 */
async function loadDynamicDropdowns() {
    try {
        const dropdownData = await loadDropdownData();
        if (dropdownData && dropdownData.success) {
            dynamicDropdownData = {
                categories: dropdownData.categories || [],
                subCategories: dropdownData.subCategories || [],
                assignedTo: dropdownData.assignedTo || []
            };
            console.log('‚úÖ Dynamic dropdowns loaded');
        } else {
            throw new Error('Failed to load dropdown data');
        }
    } catch (error) {
        console.warn('Dropdown loading failed, using fallbacks:', error);
        
        // Fallback dropdown data
        dynamicDropdownData = {
            categories: ['Aircon', 'Doors', 'Electrical', 'Plumbing', 'Irrigation', 'General'],
            subCategories: ['General', 'Faucet/Tap', 'Lighting', 'Repair', 'Maintenance'],
            assignedTo: ['Ben', 'Jade', 'David', 'Gardening Club', 'External Contractor']
        };
    }
    
    // Populate dropdowns in editor
    populateDropdowns();
}

/**
 * Load dropdown data from API
 */
function loadDropdownData() {
    return new Promise((resolve, reject) => {
        const timeout = setTimeout(() => {
            reject(new Error('Dropdown request timeout'));
        }, 5000);
        
        const callbackName = 'dropdown_callback_' + Date.now();
        
        window[callbackName] = function(data) {
            clearTimeout(timeout);
            delete window[callbackName];
            resolve(data);
        };
        
        const script = document.createElement('script');
        script.src = `${WEB_APP_URL}?action=getDropdownOptions&callback=${callbackName}`;
        script.onerror = () => {
            clearTimeout(timeout);
            delete window[callbackName];
            reject(new Error('Dropdown script loading failed'));
        };
        
        document.head.appendChild(script);
        setTimeout(() => {
            if (document.head.contains(script)) {
                document.head.removeChild(script);
            }
        }, 6000);
    });
}

/* ===================================================================
                        AUTO-SYNC SYSTEM
=================================================================== */

/**
 * Start automatic sync checking
 */
function startAutoSync() {
    if (autoSyncInterval) {
        clearInterval(autoSyncInterval);
    }
    
    // Check for changes every 45 seconds
    autoSyncInterval = setInterval(checkForDataChanges, 45000);
    console.log('Auto-sync started (45s interval)');
}

/**
 * Check for data changes
 */
async function checkForDataChanges() {
    if (!isAuthenticated || dataConnectionStatus !== 'live') {
        return;
    }
    
    try {
        const data = await loadLiveData();
        if (data && data.length > 0) {
            const newHash = calculateDataHash(data);
            
            if (newHash !== lastDataHash) {
                console.log('üîÑ Data changes detected');
                
                // Show notification modal
                showAutoSyncNotification();
                
                // Update data silently
                problems = data;
                lastDataHash = newHash;
            }
        }
    } catch (error) {
        console.warn('Auto-sync check failed:', error);
    }
}

/**
 * Show auto-sync notification
 */
function showAutoSyncNotification() {
    const modal = document.getElementById('autoSyncModal');
    modal.classList.remove('hidden');
}

/* ===================================================================
                        INITIALIZATION
=================================================================== */

/**
 * Initialize Priority Portal
 */
function initializePriorityPortal() {
    console.log('üéØ Priority Portal v1.0 Initializing...');
    
    // Update initial data status
    updateDataStatus('loading');
    
    // Setup event listeners (will be added in Phase 3)
    console.log('‚úÖ Phase 2 Complete: JavaScript Core & Configuration');
    console.log('üîÑ Ready for Phase 3: Priority Sorting Logic & Event Handlers');
}



/* ===================================================================
   PRIORITY PORTAL v1.0 - PHASE 3: PRIORITY SORTING LOGIC & EVENT HANDLERS
   ===================================================================
   
   üéØ PHASE 3 INCLUDES:
   ‚úÖ Search and filtering logic
   ‚úÖ Priority-sorted problem list rendering
   ‚úÖ Editor population and form handling
   ‚úÖ Event listeners and user interactions
   ‚úÖ Report generation system
   ‚úÖ Problem saving functionality
   
   üîÑ PRIORITY-FOCUSED FEATURES:
   - Smart priority-based sorting (Urgent ‚Üí High ‚Üí Medium ‚Üí Low)
   - Status-aware filtering and organization
   - Clean list rendering without drag & drop complexity
   - Streamlined editing workflow
   
   üìå INSERT LOCATION: Append to the end of Phase 2 JavaScript
   
=================================================================== */

/* ===================================================================
                        SEARCH & FILTERING LOGIC
=================================================================== */

/**
 * Apply search and filter to problems
 */
function applyFilters() {
    let filtered = [...problems];
    
    // Apply search filter
    if (searchTerm.trim()) {
        const searchLower = searchTerm.toLowerCase();
        filtered = filtered.filter(problem => {
            const friendlyPID = getFriendlyPID(problem.internalId).toLowerCase();
            return friendlyPID.includes(searchLower) ||
                   problem.unitNumber.toLowerCase().includes(searchLower) ||
                   problem.problemDescription.toLowerCase().includes(searchLower) ||
                   problem.reportedBy.toLowerCase().includes(searchLower) ||
                   problem.residentName.toLowerCase().includes(searchLower);
        });
    }
    
    // Apply status filter
    // Apply status filter
if (activeFilter !== 'all') {
    const filterMap = {
        'reported': 'Reported',
        'in-progress': 'In Progress', 
        'on-hold': 'On Hold',
        'completed': 'Completed',
        'cancelled': 'Cancelled'
    };
    
    if (filterMap[activeFilter]) {
        filtered = filtered.filter(problem => 
            problem.problemStatus === filterMap[activeFilter]
        );
    }
} else {
    // For "All Problems", exclude completed and cancelled
    filtered = filtered.filter(problem => 
        problem.problemStatus !== 'Completed' && 
        problem.problemStatus !== 'Cancelled'
    );
}
    
    // Sort by priority (this is the key difference from original)
    filteredProblems = sortByPriority(filtered);
    
    console.log(`Filtered ${filteredProblems.length} problems (from ${problems.length} total)`);
}

/**
 * Handle search input with debouncing
 */
const handleSearchInput = debounce((value) => {
    searchTerm = value;
    applyFilters();
    updateProblemsList();
}, 300);

/**
 * Handle filter tab change
 */
function handleFilterChange(filter) {
    activeFilter = filter;
    
    // Update active tab styling
    document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
    
    applyFilters();
    updateProblemsList();
    
    console.log(`Filter changed to: ${filter}`);
}

/* ===================================================================
                        PROBLEM LIST RENDERING
=================================================================== */

/**
 * Update the problems list display
 */
function updateProblemsList() {
    const container = document.getElementById('problemsList');
    const countElement = document.getElementById('resultsCount');
    
    if (!container || !countElement) return;
    
    // Update count
    const filterText = activeFilter === 'all' ? 'All Problems' : 
                      activeFilter.charAt(0).toUpperCase() + activeFilter.slice(1).replace('-', ' ');
    countElement.textContent = `${filterText} (${filteredProblems.length})`;
    
    // Clear container
    container.innerHTML = '';
    
    if (filteredProblems.length === 0) {
        container.innerHTML = `
            <div class="no-data">
                <h3>No problems found</h3>
                <p>Try adjusting your search or filter criteria</p>
            </div>
        `;
        return;
    }
    
    // Render problem cards (priority sorted)
    filteredProblems.forEach((problem, index) => {
        const card = createProblemCard(problem, index);
        container.appendChild(card);
    });
    
    console.log(`Rendered ${filteredProblems.length} problem cards`);
}

/**
 * Create a problem card element
 */
function createProblemCard(problem, index) {
    const card = document.createElement('div');
    
    card.className = `problem-card ${(problem.priority || 'medium').toLowerCase()}`;
    
    card.dataset.internalId = problem.internalId;
    card.dataset.index = index;
    
    const friendlyPID = getFriendlyPID(problem.internalId);
    const formattedDate = formatDate(problem.reportedDate);
    
    card.innerHTML = `
        <div class="problem-header">
            <div>
                <div class="problem-id">${friendlyPID}</div>
                <div class="problem-unit">üìç ${problem.unitNumber} ‚Ä¢ ${problem.zone}</div>
            </div>
            <div class="problem-badges">
               <span class="badge ${(problem.priority || 'medium').toLowerCase()}">${problem.priority || 'Medium'}</span>
               <span class="badge ${(problem.problemStatus || 'reported').toLowerCase().replace(' ', '-')}">${problem.problemStatus || 'Reported'}</span>
            </div>
        </div>
        
        <div class="problem-description">
            ${problem.problemDescription}
        </div>
        
        <div class="problem-footer">
            <div class="problem-reporter">
                <span>üë§</span>
                <span>${problem.reportedBy}</span>
            </div>
            <div class="problem-date">
                <span>üìÖ</span>
                <span>${formattedDate}</span>
            </div>
        </div>
    `;
    
    // Add click handler
    card.addEventListener('click', () => handleProblemCardClick(problem));
    
    return card;
}

/**
 * Handle problem card click
 */
function handleProblemCardClick(problem) {
    console.log(`Opening editor for problem: ${getFriendlyPID(problem.internalId)}`);
    showEditorView(problem);
}

/* ===================================================================
                        EDITOR FUNCTIONALITY
=================================================================== */

/**
 * Populate editor with problem data
 */
function populateEditor(problem) {
    if (!problem) return;
    
    // Problem Details (read-only)
    document.getElementById('reportedDate').value = problem.reportedDate || '';
    document.getElementById('unitNumber').value = problem.unitNumber || '';
    document.getElementById('reportedBy').value = problem.reportedBy || '';
    document.getElementById('zone').value = problem.zone || '';
    document.getElementById('residentName').value = problem.residentName || '';
    document.getElementById('residentMobile').value = problem.residentMobile || '';
    document.getElementById('problemDescription').value = problem.problemDescription || '';
    
    // Management Details (editable)
    document.getElementById('category').value = problem.category || '';
    document.getElementById('subCategory').value = problem.subCategory || '';
    document.getElementById('priority').value = problem.priority || 'Medium';
    document.getElementById('status').value = problem.status || 'Reported';
    document.getElementById('assignedTo').value = problem.assignedTo || '';
    document.getElementById('completionDate').value = problem.completionDate || '';
    document.getElementById('internalComments').value = problem.internalComments || '';
    
    console.log(`Editor populated for: ${getFriendlyPID(problem.internalId)}`);
}

/**
 * Populate dropdown options
 */
function populateDropdowns() {
    // Categories dropdown
    const categorySelect = document.getElementById('category');
    if (categorySelect) {
        categorySelect.innerHTML = '<option value="">Select Category</option>';
        dynamicDropdownData.categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            categorySelect.appendChild(option);
        });
    }
    
    // Sub-categories dropdown
    const subCategorySelect = document.getElementById('subCategory');
    if (subCategorySelect) {
        subCategorySelect.innerHTML = '<option value="">Select Sub-Category</option>';
        dynamicDropdownData.subCategories.forEach(subCategory => {
            const option = document.createElement('option');
            option.value = subCategory;
            option.textContent = subCategory;
            subCategorySelect.appendChild(option);
        });
    }
    
    // Assigned To dropdown
    const assignedToSelect = document.getElementById('assignedTo');
    if (assignedToSelect) {
        assignedToSelect.innerHTML = '<option value="">Select Assignee</option>';
        dynamicDropdownData.assignedTo.forEach(assignee => {
            const option = document.createElement('option');
            option.value = assignee;
            option.textContent = assignee;
            assignedToSelect.appendChild(option);
        });
    }
    
    console.log('‚úÖ Dropdowns populated with dynamic data');
}

/**
 * Collect form data from editor
 */
function collectFormData() {
    return {
        internalId: currentProblem.internalId,
        
        // Problem details (read-only, but include for completeness)
        reportedDate: document.getElementById('reportedDate').value,
        unitNumber: document.getElementById('unitNumber').value,
        reportedBy: document.getElementById('reportedBy').value,
        zone: document.getElementById('zone').value,
        residentName: document.getElementById('residentName').value,
        residentMobile: document.getElementById('residentMobile').value,
        problemDescription: document.getElementById('problemDescription').value,
        
        // Management details (editable)
        category: document.getElementById('category').value,
        subCategory: document.getElementById('subCategory').value,
        priority: document.getElementById('priority').value,
        status: document.getElementById('status').value,
        assignedTo: document.getElementById('assignedTo').value,
        completionDate: document.getElementById('completionDate').value,
        internalComments: document.getElementById('internalComments').value
    };
}

/**
 * Save problem changes
 */
async function saveProblem() {
    if (!currentProblem) {
        console.error('No current problem to save');
        return;
    }
    
    const saveBtn = document.getElementById('saveBtn');
    const originalText = saveBtn.innerHTML;
    
    try {
        // Show saving state
        saveBtn.innerHTML = '‚è≥ Saving...';
        saveBtn.disabled = true;
        
        const formData = collectFormData();
        console.log('Saving problem:', getFriendlyPID(formData.internalId));
        
        // Try to save to live system
        if (dataConnectionStatus === 'live') {
            const result = await saveProblemToAPI(formData);
            if (result && result.success) {
                console.log('‚úÖ Problem saved successfully');
                
                // Update local data
                updateLocalProblemData(formData);
                
                // Show success
                saveBtn.innerHTML = '‚úÖ Saved!';
                setTimeout(() => {
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                }, 2000);
                
            } else {
                throw new Error(result?.message || 'Save failed');
            }
        } else {
            // Update sample data only
            updateLocalProblemData(formData);
            console.log('üìù Sample data updated (no live connection)');
            
            saveBtn.innerHTML = '‚úÖ Updated!';
            setTimeout(() => {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }, 2000);
        }
        
    } catch (error) {
        console.error('Save error:', error);
        
        saveBtn.innerHTML = '‚ùå Error';
        setTimeout(() => {
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        }, 3000);
    }
}

/**
 * Save problem data to API
 */
function saveProblemToAPI(formData) {
    return new Promise((resolve, reject) => {
        const timeout = setTimeout(() => {
            reject(new Error('Save request timeout'));
        }, 10000);
        
        const callbackName = 'save_callback_' + Date.now();
        
        window[callbackName] = function(data) {
            clearTimeout(timeout);
            delete window[callbackName];
            resolve(data);
        };
        
        // Build query parameters
        const params = new URLSearchParams({
            action: 'updateProblem',
            callback: callbackName,
            ...formData
        });
        
        const script = document.createElement('script');
        script.src = `${WEB_APP_URL}?${params.toString()}`;
        script.onerror = () => {
            clearTimeout(timeout);
            delete window[callbackName];
            reject(new Error('Save script loading failed'));
        };
        
        document.head.appendChild(script);
        setTimeout(() => {
            if (document.head.contains(script)) {
                document.head.removeChild(script);
            }
        }, 11000);
    });
}

/**
 * Update local problem data
 */
function updateLocalProblemData(formData) {
    // Find and update the problem in local data
    const problemIndex = problems.findIndex(p => p.internalId === formData.internalId);
    if (problemIndex !== -1) {
        problems[problemIndex] = { ...problems[problemIndex], ...formData };
        
        // Update current problem reference
        currentProblem = problems[problemIndex];
        
        // Refresh filtered list and UI
        applyFilters();
        
        // Update list view if visible
        if (currentView === 'list') {
            updateProblemsList();
        }
        
        console.log('Local data updated for:', getFriendlyPID(formData.internalId));
    }
}

/* ===================================================================
                        REPORT GENERATION
=================================================================== */

/**
 * Generate problem list report
 */
function generateListReport() {
    const reportData = filteredProblems.map(problem => ({
        pid: getFriendlyPID(problem.internalId),
        unit: problem.unitNumber,
        zone: problem.zone,
        priority: problem.priority,
        status: problem.status,
        description: problem.problemDescription.substring(0, 80) + (problem.problemDescription.length > 80 ? '...' : ''),
        reporter: problem.reportedBy,
        date: problem.reportedDate,
        assignedTo: problem.assignedTo || 'Unassigned'
    }));
    
    let report = 'PRIORITY PORTAL - PROBLEMS REPORT\n';
    report += '='.repeat(60) + '\n';
    report += `Generated: ${new Date().toLocaleString('en-AU')}\n`;
    report += `Total Problems: ${reportData.length}\n`;
    report += `Filter: ${activeFilter === 'all' ? 'All Problems' : activeFilter.replace('-', ' ')}\n`;
    report += `Search: ${searchTerm || 'None'}\n`;
    report += '='.repeat(60) + '\n\n';
    
    // Priority breakdown
    const priorityCount = {
        'Urgent': reportData.filter(p => p.priority === 'Urgent').length,
        'High': reportData.filter(p => p.priority === 'High').length,
        'Medium': reportData.filter(p => p.priority === 'Medium').length,
        'Low': reportData.filter(p => p.priority === 'Low').length
    };
    
    report += 'PRIORITY BREAKDOWN:\n';
    report += '-'.repeat(30) + '\n';
    Object.entries(priorityCount).forEach(([priority, count]) => {
        if (count > 0) {
            report += `${priority}: ${count}\n`;
        }
    });
    report += '\n';
    
    // Status breakdown
    const statusCount = {};
    reportData.forEach(p => {
        statusCount[p.status] = (statusCount[p.status] || 0) + 1;
    });
    
    report += 'STATUS BREAKDOWN:\n';
    report += '-'.repeat(30) + '\n';
    Object.entries(statusCount).forEach(([status, count]) => {
        report += `${status}: ${count}\n`;
    });
    report += '\n';
    
    // Detailed list
    report += 'DETAILED PROBLEM LIST:\n';
    report += '-'.repeat(60) + '\n';
    
    reportData.forEach((problem, index) => {
        report += `${index + 1}. ${problem.pid}\n`;
        report += `   Unit: ${problem.unit} (${problem.zone})\n`;
        report += `   Priority: ${problem.priority} | Status: ${problem.status}\n`;
        report += `   Reporter: ${problem.reporter} | Date: ${problem.date}\n`;
        report += `   Assigned: ${problem.assignedTo}\n`;
        report += `   Description: ${problem.description}\n`;
        report += '\n';
    });
    
    report += '='.repeat(60) + '\n';
    report += 'End of Report\n';
    
    return report;
}

/**
 * Show report modal
 */
function showReportModal() {
    const modal = document.getElementById('reportModal');
    const reportText = document.getElementById('reportText');
    
    const report = generateListReport();
    reportText.textContent = report;
    
    modal.classList.remove('hidden');
    
    console.log('Report modal displayed');
}

/**
 * Copy report to clipboard
 */
async function copyReportToClipboard() {
    const report = generateListReport();
    
    try {
        await navigator.clipboard.writeText(report);
        
        // Show success feedback
        const copyBtn = document.getElementById('copyModalReport');
        const originalText = copyBtn.innerHTML;
        copyBtn.innerHTML = '‚úÖ Copied!';
        
        setTimeout(() => {
            copyBtn.innerHTML = originalText;
        }, 2000);
        
        console.log('Report copied to clipboard');
        
    } catch (error) {
        console.error('Copy failed:', error);
        
        // Fallback: select text for manual copy
        const reportText = document.getElementById('reportText');
        const range = document.createRange();
        range.selectNode(reportText);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
    }
}

/* ===================================================================
                        EVENT LISTENERS
=================================================================== */

/**
 * Setup all event listeners
 */
function setupEventListeners() {
    // Login screen
    const passwordInput = document.getElementById('password');
    const loginBtn = document.getElementById('loginBtn');
    
    if (passwordInput && loginBtn) {
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleLogin();
            }
        });
        
        loginBtn.addEventListener('click', handleLogin);
    }
    
    // Logout buttons
    document.querySelectorAll('#logoutBtn, #logoutBtnEditor').forEach(btn => {
        btn.addEventListener('click', handleLogout);
    });
    
    // Navigation
    const backBtn = document.getElementById('backBtn');
    if (backBtn) {
        backBtn.addEventListener('click', () => {
            showListView();
        });
    }
    
    // Search
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            handleSearchInput(e.target.value);
        });
        
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleSearchInput(e.target.value);
            }
        });
    }
    
    if (searchBtn) {
        searchBtn.addEventListener('click', () => {
            if (searchInput) {
                handleSearchInput(searchInput.value);
            }
        });
    }
    
    // Filter tabs
    document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
            const filter = e.target.dataset.filter;
            if (filter) {
                handleFilterChange(filter);
            }
        });
    });
    
    // Refresh buttons
    document.querySelectorAll('#refreshBtn, #refreshBtnEditor').forEach(btn => {
        btn.addEventListener('click', () => {
            loadProblemsData();
        });
    });
    
    // Editor save button
    const saveBtn = document.getElementById('saveBtn');
    if (saveBtn) {
        saveBtn.addEventListener('click', saveProblem);
    }
    
    // Report buttons
    const viewReportBtn = document.getElementById('viewListReport');
    const copyReportBtn = document.getElementById('copyListReport');
    
    if (viewReportBtn) {
        viewReportBtn.addEventListener('click', showReportModal);
    }
    
    if (copyReportBtn) {
        copyReportBtn.addEventListener('click', copyReportToClipboard);
    }
    
    // Modal close buttons
    const closeReportModal = document.getElementById('closeReportModal');
    const closeAutoSyncModal = document.getElementById('closeAutoSyncModal');
    const copyModalReport = document.getElementById('copyModalReport');
    const refreshDataBtn = document.getElementById('refreshDataBtn');
    
    if (closeReportModal) {
        closeReportModal.addEventListener('click', () => {
            document.getElementById('reportModal').classList.add('hidden');
        });
    }
    
    if (closeAutoSyncModal) {
        closeAutoSyncModal.addEventListener('click', () => {
            document.getElementById('autoSyncModal').classList.add('hidden');
        });
    }
    
    if (copyModalReport) {
        copyModalReport.addEventListener('click', copyReportToClipboard);
    }
    
    if (refreshDataBtn) {
        refreshDataBtn.addEventListener('click', () => {
            document.getElementById('autoSyncModal').classList.add('hidden');
            loadProblemsData();
            if (currentView === 'list') {
                updateProblemsList();
            }
        });
    }
    
    // Modal background clicks
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.add('hidden');
            }
        });
    });
    
    console.log('‚úÖ Event listeners setup complete');
}

/* ===================================================================
                        ENHANCED INITIALIZATION
=================================================================== */

/**
 * Enhanced Priority Portal initialization with event listeners
 */
function initializePriorityPortalWithEvents() {
    console.log('üéØ Priority Portal v1.0 - Phase 3 Initializing...');
    
    // Setup all event listeners
    setupEventListeners();
    
    // Update initial data status
    updateDataStatus('loading');
    
    console.log('‚úÖ Phase 3 Complete: Priority Sorting Logic & Event Handlers');
    console.log('üîÑ Ready for Phase 4: Final Integration & Testing');
}

// Override the initialization to include Phase 3


/* ===================================================================
   PRIORITY PORTAL v1.0 - PHASE 4: FINAL INTEGRATION & TESTING
   ===================================================================
   
   üéØ PHASE 4 INCLUDES:
   ‚úÖ Edge case handling and error recovery
   ‚úÖ Performance optimizations
   ‚úÖ Enhanced user feedback systems
   ‚úÖ Complete integration testing
   ‚úÖ Production-ready validations
   ‚úÖ Deployment package preparation
   
   üèÅ FINAL FEATURES:
   - Robust error handling for all scenarios
   - Smooth loading states and transitions
   - Enhanced mobile experience
   - Complete data validation
   - Production deployment readiness
   
   üìå INSERT LOCATION: Append to the end of Phase 3 JavaScript
   
=================================================================== */

/* ===================================================================
                        ENHANCED ERROR HANDLING
=================================================================== */

/**
 * Global error handler for uncaught errors
 */
window.addEventListener('error', (event) => {
    console.error('Global error caught:', event.error);
    showUserFeedback('An unexpected error occurred. Please refresh the page.', 'error');
});

/**
 * Handle unhandled promise rejections
 */
window.addEventListener('unhandledrejection', (event) => {
    console.error('Unhandled promise rejection:', event.reason);
    showUserFeedback('A network error occurred. Please check your connection.', 'warning');
    event.preventDefault();
});

/**
 * Enhanced user feedback system
 */
function showUserFeedback(message, type = 'info', duration = 5000) {
    // Remove existing feedback
    const existing = document.querySelector('.user-feedback');
    if (existing) {
        existing.remove();
    }
    
    // Create feedback element
    const feedback = document.createElement('div');
    feedback.className = `user-feedback ${type}`;
    feedback.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'error' ? '#fee2e2' : type === 'warning' ? '#fef3c7' : type === 'success' ? '#d1fae5' : '#e0f2fe'};
        color: ${type === 'error' ? '#dc2626' : type === 'warning' ? '#d97706' : type === 'success' ? '#065f46' : '#0369a1'};
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        max-width: 400px;
        font-size: 14px;
        font-weight: 500;
        border-left: 4px solid ${type === 'error' ? '#dc2626' : type === 'warning' ? '#d97706' : type === 'success' ? '#065f46' : '#0369a1'};
        animation: slideIn 0.3s ease-out;
    `;
    
    feedback.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 18px; cursor: pointer; margin-left: 10px;">&times;</button>
        </div>
    `;
    
    // Add animation styles
    if (!document.querySelector('#feedback-styles')) {
        const style = document.createElement('style');
        style.id = 'feedback-styles';
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    }
    
    document.body.appendChild(feedback);
    
    // Auto-remove after duration
    if (duration > 0) {
        setTimeout(() => {
            if (feedback.parentElement) {
                feedback.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => feedback.remove(), 300);
            }
        }, duration);
    }
}

/* ===================================================================
                        ENHANCED DATA VALIDATION
=================================================================== */

/**
 * Validate problem data structure
 */
function validateProblemData(problem) {
    const required = ['internalId', 'reportedDate', 'unitNumber', 'problemDescription'];
    const errors = [];
    
    for (const field of required) {
        if (!problem[field] || problem[field].toString().trim() === '') {
            errors.push(`Missing required field: ${field}`);
        }
    }
    
    // Validate date format
    if (problem.reportedDate && !isValidDate(problem.reportedDate)) {
        errors.push('Invalid date format');
    }
    
    // Validate priority
    if (problem.priority && !PRIORITY_ORDER.includes(problem.priority)) {
        errors.push('Invalid priority value');
    }
    
    // Validate status
    if (problem.status && !STATUS_ORDER.includes(problem.status)) {
        errors.push('Invalid status value');
    }
    
    return {
        isValid: errors.length === 0,
        errors
    };
}

/**
 * Check if date string is valid
 */
function isValidDate(dateString) {
    if (!dateString) return false;
    
    const parts = dateString.split('/');
    if (parts.length !== 3) return false;
    
    const day = parseInt(parts[0]);
    const month = parseInt(parts[1]);
    const year = parseInt(parts[2]);
    
    if (isNaN(day) || isNaN(month) || isNaN(year)) return false;
    if (day < 1 || day > 31 || month < 1 || month > 12 || year < 2020) return false;
    
    return true;
}

/**
 * Sanitize user input
 */
function sanitizeInput(input) {
    if (typeof input !== 'string') return input;
    
    return input
        .trim()
        .replace(/[<>]/g, '') // Remove potential HTML
        .substring(0, 1000); // Limit length
}

/* ===================================================================
                        PERFORMANCE OPTIMIZATIONS
=================================================================== */

/**
 * Optimized problem list rendering with virtual scrolling for large datasets
 */
function updateProblemsListOptimized() {
    const container = document.getElementById('problemsList');
    const countElement = document.getElementById('resultsCount');
    
    if (!container || !countElement) return;
    
    // Update count
    const filterText = activeFilter === 'all' ? 'All Problems' : 
                      activeFilter.charAt(0).toUpperCase() + activeFilter.slice(1).replace('-', ' ');
    countElement.textContent = `${filterText} (${filteredProblems.length})`;
    
    // Use document fragment for better performance
    const fragment = document.createDocumentFragment();
    
    if (filteredProblems.length === 0) {
        const noData = document.createElement('div');
        noData.className = 'no-data';
        noData.innerHTML = `
            <h3>No problems found</h3>
            <p>Try adjusting your search or filter criteria</p>
        `;
        fragment.appendChild(noData);
    } else {
        // Batch render for performance
        const BATCH_SIZE = 20;
        const visibleProblems = filteredProblems.slice(0, BATCH_SIZE);
        
        visibleProblems.forEach((problem, index) => {
            const card = createProblemCard(problem, index);
            fragment.appendChild(card);
        });
        
        // Add load more button if there are more problems
        if (filteredProblems.length > BATCH_SIZE) {
            const loadMoreBtn = document.createElement('button');
            loadMoreBtn.className = 'btn btn-secondary';
            loadMoreBtn.style.cssText = 'width: 100%; margin-top: 20px; padding: 15px;';
            loadMoreBtn.innerHTML = `üìÑ Load More (${filteredProblems.length - BATCH_SIZE} remaining)`;
            loadMoreBtn.onclick = () => loadMoreProblems(BATCH_SIZE);
            fragment.appendChild(loadMoreBtn);
        }
    }
    
    // Clear and update container
    container.innerHTML = '';
    container.appendChild(fragment);
    
    console.log(`Rendered ${Math.min(filteredProblems.length, 20)} problem cards`);
}

/**
 * Load more problems (for large datasets)
 */
function loadMoreProblems(currentCount) {
    const container = document.getElementById('problemsList');
    const loadMoreBtn = container.querySelector('.btn-secondary');
    
    if (loadMoreBtn) {
        loadMoreBtn.remove();
    }
    
    const BATCH_SIZE = 20;
    const nextBatch = filteredProblems.slice(currentCount, currentCount + BATCH_SIZE);
    
    nextBatch.forEach((problem, index) => {
        const card = createProblemCard(problem, currentCount + index);
        container.appendChild(card);
    });
    
    // Add new load more button if needed
    if (currentCount + BATCH_SIZE < filteredProblems.length) {
        const loadMoreBtn = document.createElement('button');
        loadMoreBtn.className = 'btn btn-secondary';
        loadMoreBtn.style.cssText = 'width: 100%; margin-top: 20px; padding: 15px;';
        loadMoreBtn.innerHTML = `üìÑ Load More (${filteredProblems.length - currentCount - BATCH_SIZE} remaining)`;
        loadMoreBtn.onclick = () => loadMoreProblems(currentCount + BATCH_SIZE);
        container.appendChild(loadMoreBtn);
    }
}

/**
 * Optimized search with better debouncing
 */
const optimizedSearchHandler = debounce((value) => {
    const startTime = performance.now();
    
    searchTerm = value;
    applyFilters();
    updateProblemsListOptimized();
    
    const endTime = performance.now();
    console.log(`Search completed in ${(endTime - startTime).toFixed(2)}ms`);
}, 300);

/* ===================================================================
                        ENHANCED MOBILE EXPERIENCE
=================================================================== */

/**
 * Enhanced mobile responsiveness
 */
function optimizeForMobile() {
    // Detect mobile device
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    if (isMobile) {
        document.body.classList.add('mobile-device');
        
        // Add mobile-specific styles
        if (!document.querySelector('#mobile-styles')) {
            const style = document.createElement('style');
            style.id = 'mobile-styles';
            style.textContent = `
                .mobile-device .problem-card {
                    padding: 15px;
                    margin-bottom: 10px;
                }
                
                .mobile-device .search-input {
                    font-size: 16px; /* Prevents zoom on iOS */
                }
                
                .mobile-device .form-input {
                    font-size: 16px; /* Prevents zoom on iOS */
                }
                
                .mobile-device .problem-description {
                    font-size: 14px;
                    line-height: 1.4;
                }
                
                .mobile-device .header-right {
                    flex-wrap: wrap;
                    gap: 8px;
                }
                
                .mobile-device .btn {
                    min-height: 44px; /* iOS touch target minimum */
                }
            `;
            document.head.appendChild(style);
        }
        
        console.log('Mobile optimizations applied');
    }
    
    // Handle orientation changes
    window.addEventListener('orientationchange', () => {
        setTimeout(() => {
            if (currentView === 'list') {
                updateProblemsListOptimized();
            }
        }, 100);
    });
}

/* ===================================================================
                        ENHANCED AUTO-SYNC SYSTEM
=================================================================== */

/**
 * Enhanced auto-sync with better error handling
 */
async function enhancedCheckForDataChanges() {
    if (!isAuthenticated || dataConnectionStatus !== 'live') {
        return;
    }
    
    try {
        const data = await loadLiveDataWithRetry();
        if (data && data.length > 0) {
            const newHash = calculateDataHash(data);
            
            if (newHash !== lastDataHash) {
                console.log('üîÑ Data changes detected via auto-sync');
                
                // Validate new data
                const validProblems = data.filter(problem => {
                    const validation = validateProblemData(problem);
                    if (!validation.isValid) {
                        console.warn('Invalid problem data:', validation.errors, problem);
                        return false;
                    }
                    return true;
                });
                
                if (validProblems.length > 0) {
                    problems = validProblems;
                    lastDataHash = newHash;
                    
                    // Show subtle notification
                    showUserFeedback('Data updated from server', 'success', 3000);
                    
                    // Refresh current view
                    if (currentView === 'list') {
                        applyFilters();
                        updateProblemsListOptimized();
                    }
                }
            }
        }
    } catch (error) {
        console.warn('Auto-sync check failed (will retry):', error);
        // Don't show error to user for auto-sync failures
    }
}

/**
 * Load live data with retry mechanism
 */
async function loadLiveDataWithRetry(maxRetries = 2) {
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try {
            return await loadLiveData();
        } catch (error) {
            console.warn(`Data load attempt ${attempt} failed:`, error);
            
            if (attempt < maxRetries) {
                // Wait before retry (exponential backoff)
                await new Promise(resolve => setTimeout(resolve, attempt * 1000));
            } else {
                throw error;
            }
        }
    }
}

/* ===================================================================
                        PRODUCTION DEPLOYMENT HELPERS
=================================================================== */

/**
 * Check system health and configuration
 */
function performSystemHealthCheck() {
    const checks = {
        apiUrl: !!WEB_APP_URL,
        password: !!MAINTENANCE_PASSWORD,
        domElements: checkRequiredDOMElements(),
        localStorage: checkLocalStorageAvailable(),
        promises: typeof Promise !== 'undefined',
        fetchAPI: typeof fetch !== 'undefined' || typeof XMLHttpRequest !== 'undefined'
    };
    
    const failures = Object.entries(checks)
        .filter(([key, passed]) => !passed)
        .map(([key]) => key);
    
    if (failures.length > 0) {
        console.error('System health check failed:', failures);
        showUserFeedback('System configuration error. Please contact support.', 'error', 0);
        return false;
    }
    
    console.log('‚úÖ System health check passed');
    return true;
}

/**
 * Check required DOM elements exist
 */
function checkRequiredDOMElements() {
    const required = [
        'loginScreen', 'mainApp', 'problemsList', 'editorView',
        'password', 'loginBtn', 'searchInput', 'dataStatus'
    ];
    
    return required.every(id => document.getElementById(id) !== null);
}

/**
 * Check if localStorage is available
 */
function checkLocalStorageAvailable() {
    try {
        const test = 'test';
        localStorage.setItem(test, test);
        localStorage.removeItem(test);
        return true;
    } catch (e) {
        return false;
    }
}

/**
 * Initialize performance monitoring
 */
function initializePerformanceMonitoring() {
    if ('performance' in window) {
        // Monitor page load time
        window.addEventListener('load', () => {
            const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
            console.log(`Page load time: ${loadTime}ms`);
            
            if (loadTime > 5000) {
                console.warn('Slow page load detected');
            }
        });
        
        // Monitor memory usage (if available)
        if ('memory' in performance) {
            setInterval(() => {
                const memory = performance.memory;
                if (memory.usedJSHeapSize > 50 * 1024 * 1024) { // 50MB
                    console.warn('High memory usage detected:', Math.round(memory.usedJSHeapSize / 1024 / 1024) + 'MB');
                }
            }, 60000); // Check every minute
        }
    }
}

/* ===================================================================
                        FINAL INTEGRATION & STARTUP
=================================================================== */

/**
 * Enhanced initialization with all Phase 4 features
 */
function initializePriorityPortalComplete() {
    console.log('üéØ Priority Portal v1.0 - Complete Initialization Starting...');
    
    // Perform system health check
    if (!performSystemHealthCheck()) {
        return; // Don't continue if system check fails
    }
    
    // Initialize performance monitoring
    initializePerformanceMonitoring();
    
    // Optimize for mobile if needed
    optimizeForMobile();
    
    // Setup all event listeners (from Phase 3)
    setupEventListeners();
    
    // Enhanced search handler
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        // Replace existing event listener with optimized version
        searchInput.removeEventListener('input', handleSearchInput);
        searchInput.addEventListener('input', (e) => {
            optimizedSearchHandler(e.target.value);
        });
    }
    
    // Replace standard problem list updater with optimized version
    window.updateProblemsList = updateProblemsListOptimized;
    
    // Enhanced auto-sync
    window.checkForDataChanges = enhancedCheckForDataChanges;
    
    // Update initial data status
    updateDataStatus('loading');
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        // Ctrl/Cmd + K for search focus
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            const searchInput = document.getElementById('searchInput');
            if (searchInput && !searchInput.disabled) {
                searchInput.focus();
                searchInput.select();
            }
        }
        
        // Escape to clear search
        if (e.key === 'Escape' && currentView === 'list') {
            const searchInput = document.getElementById('searchInput');
            if (searchInput && searchInput.value) {
                searchInput.value = '';
                optimizedSearchHandler('');
            }
        }
    });
    
    // Add version info to console
    console.log(`
    ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
    ‚ïë                    PRIORITY PORTAL v1.0                     ‚ïë
    ‚ïë                Smart Priority Management System              ‚ïë
    ‚ïë                                                              ‚ïë
    ‚ïë  ‚úÖ Phase 1: HTML Structure & CSS                           ‚ïë
    ‚ïë  ‚úÖ Phase 2: JavaScript Core & Configuration                ‚ïë
    ‚ïë  ‚úÖ Phase 3: Priority Sorting Logic & Event Handlers       ‚ïë
    ‚ïë  ‚úÖ Phase 4: Final Integration & Testing                    ‚ïë
    ‚ïë                                                              ‚ïë
    ‚ïë  üéØ Priority-based automatic sorting                        ‚ïë
    ‚ïë  üîÑ Real-time data synchronization                          ‚ïë
    ‚ïë  üì± Mobile-optimized responsive design                      ‚ïë
    ‚ïë  üõ°Ô∏è Enhanced error handling & validation                    ‚ïë
    ‚ïë  üöÄ Production-ready deployment                             ‚ïë
    ‚ïë                                                              ‚ïë
    ‚ïë  Built for: Lake Illawong Retirement Village               ‚ïë
    ‚ïë  Deployment: Ready for parallel A/B testing                ‚ïë
    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
    `);
    
    console.log('‚úÖ Priority Portal v1.0 - Complete Initialization Finished');
    console.log('üéâ Ready for production deployment and A/B testing!');
    
    // Show ready state
    showUserFeedback('Priority Portal v1.0 ready for use', 'success', 3000);
}

// Final initialization - this replaces all previous DOMContentLoaded listeners
document.addEventListener('DOMContentLoaded', initializePriorityPortalComplete);

</script>
</body>
</html>



