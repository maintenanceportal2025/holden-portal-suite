<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Problem Data Explorer Mobile</title>
    <style>
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            -webkit-tap-highlight-color: transparent;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #f8fafc; 
            line-height: 1.6; 
            color: #334155;
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
        }
        
        .hidden { display: none !important; }
        
        /* Mobile Container */
        .mobile-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            padding-top: max(16px, env(safe-area-inset-top));
            position: relative;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .header h1 {
            font-size: 1.4rem;
            font-weight: 700;
        }
        
        .menu-btn, .back-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .menu-btn:active, .back-btn:active {
            background: rgba(255,255,255,0.3);
        }
        
        .dataset-toggle {
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 3px;
            display: flex;
            gap: 2px;
        }
        
        .dataset-btn {
            background: transparent;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background 0.2s;
            min-height: 44px;
        }
        
        .dataset-btn.active {
            background: rgba(255,255,255,0.3);
            font-weight: 600;
        }
        
        /* Stats Bar */
        .stats-bar {
            background: white;
            padding: 16px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        /* Date Filter Section */
        .date-filter-section {
            background: white;
            padding: 16px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .date-filter-title {
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .date-quick-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .date-btn {
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            padding: 8px 4px;
            border-radius: 8px;
            font-size: 0.75rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .date-btn.active {
            background: #dbeafe;
            border-color: #3b82f6;
            color: #1d4ed8;
        }
        
        .date-btn:active {
            transform: scale(0.95);
        }
        
        .custom-date-section {
            border-top: 1px solid #e2e8f0;
            margin-top: 12px;
            padding-top: 12px;
        }
        
        .custom-date-label {
            font-size: 0.8rem;
            color: #64748b;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .custom-date-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .date-input {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }
        
        .apply-date-btn {
            width: 100%;
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            font-weight: 500;
            min-height: 44px;
        }
        
        .date-range-display {
            font-size: 0.75rem;
            color: #64748b;
            text-align: center;
            padding: 8px;
            background: #f8fafc;
            border-radius: 8px;
            margin-top: 8px;
        }
        
        .stat-item {
            text-align: center;
            padding: 8px;
            background: #f8fafc;
            border-radius: 8px;
        }
        
        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1e293b;
            display: block;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 2px;
        }
        
        /* Search Section */
        .search-section {
            background: white;
            padding: 16px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .search-container {
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 44px 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px; /* Prevents zoom on iOS */
            background: #f8fafc;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
        }
        
        .filter-toggle-btn {
            position: absolute;
            right: 4px;
            top: 50%;
            transform: translateY(-50%);
            background: #667eea;
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        /* Filter Panel */
        .filter-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }
        
        .filter-panel.show {
            transform: translateY(0);
        }
        
        .filter-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .filter-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1e293b;
        }
        
        .close-filters {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #64748b;
            cursor: pointer;
            width: 44px;
            height: 44px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .filter-section {
            margin-bottom: 24px;
        }
        
        .filter-section-title {
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .filter-chip {
            background: #f1f5f9;
            border: 2px solid #e2e8f0;
            color: #475569;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 44px;
            display: flex;
            align-items: center;
        }
        
        .filter-chip.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .filter-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 20px;
        }
        
        .filter-action-btn {
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            min-height: 44px;
        }
        
        .btn-clear {
            background: #f1f5f9;
            color: #475569;
        }
        
        .btn-apply {
            background: #667eea;
            color: white;
        }
        
        /* Results Section */
        .results-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .results-header {
            background: white;
            padding: 16px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .results-count {
            font-weight: 600;
            color: #1e293b;
        }
        
        .sort-btn {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* Problems List */
        .problems-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            padding-bottom: calc(16px + env(safe-area-inset-bottom));
        }
        
        .problem-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .problem-card:active {
            transform: scale(0.98);
            background: #f8fafc;
        }
        
        .problem-card.legacy-card {
            border-left: 4px solid #8b5cf6;
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
        }
        
        .problem-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .problem-id {
            font-weight: 700;
            color: #667eea;
            font-size: 1.1rem;
        }
        
        .problem-unit {
            color: #64748b;
            font-size: 0.9rem;
            text-align: right;
        }
        
        .problem-badges {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }
        
        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .priority-urgent { background: #fecaca; color: #991b1b; }
        .priority-high { background: #fed7aa; color: #9a3412; }
        .priority-medium { background: #fde68a; color: #92400e; }
        .priority-low { background: #d1fae5; color: #065f46; }
        
        .status-reported { background: #dbeafe; color: #1e40af; }
        .status-in-progress { background: #fed7aa; color: #9a3412; }
        .status-on-hold { background: #fef3c7; color: #92400e; }
        .status-completed { background: #d1fae5; color: #065f46; }
        .status-cancelled { background: #f3f4f6; color: #6b7280; }
        
        .problem-description {
            color: #374151;
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 8px;
        }
        
        .problem-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: #64748b;
        }
        
        /* Detail View */
        .detail-view {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #f8fafc;
            z-index: 300;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
        }
        
        .detail-view.show {
            transform: translateX(0);
        }
        
        .detail-content {
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
        }
        
        .detail-section {
            background: white;
            margin: 16px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .detail-grid {
            padding: 16px;
            display: grid;
            gap: 16px;
        }
        
        .detail-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .detail-label {
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }
        
        .detail-value {
            padding: 12px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            color: #1f2937;
            font-size: 0.95rem;
            word-wrap: break-word;
        }
        
        .contact-link {
            color: #2563eb;
            text-decoration: none;
        }
        
        .contact-link:hover {
            text-decoration: underline;
        }
        
        /* Report Actions */
        .report-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 16px;
        }
        
        .report-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 44px;
        }
        
        .report-btn.secondary {
            background: #10b981;
        }
        
        /* Loading States */
        .loading, .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: #64748b;
            text-align: center;
        }
        
        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #e2e8f0;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Report Modal */
        .report-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 400;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1f2937;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #6b7280;
            cursor: pointer;
            width: 44px;
            height: 44px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .report-text {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            font-family: 'SF Mono', Consolas, monospace;
            font-size: 0.85rem;
            line-height: 1.4;
            white-space: pre-wrap;
            background: #f8fafc;
        }
        
        .modal-actions {
            padding: 20px;
            border-top: 1px solid #e2e8f0;
        }
        
        /* Pull to Refresh */
        .pull-refresh {
            position: absolute;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 8px;
            color: #667eea;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .pull-refresh.show {
            top: 20px;
        }
        
        /* Safe area handling */
        @supports(padding: max(0px)) {
            .mobile-container {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }
    </style>
</head>
<body>
    <!-- Main Mobile Container -->
    <div class="mobile-container" id="mainView">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <button class="menu-btn" id="menuBtn">☰</button>
                <h1>📊 Data Explorer</h1>
                <div class="dataset-toggle">
                    <button class="dataset-btn active" id="currentBtn">Current</button>
                    <button class="dataset-btn" id="legacyBtn">Legacy</button>
                </div>
            </div>
        </div>
        
        <!-- Stats Bar -->
        <div class="stats-bar">
            <div class="stat-item">
                <span class="stat-number" id="totalProblems">-</span>
                <div class="stat-label">Total</div>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="activeProblems">-</span>
                <div class="stat-label">Active</div>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="urgentCount">-</span>
                <div class="stat-label">Urgent</div>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="avgDays">-</span>
                <div class="stat-label">Avg Days</div>
            </div>
        </div>
        
        <!-- Date Filter Section -->
        <div class="date-filter-section">
            <div class="date-filter-title">📅 Date Range</div>
            <div class="date-quick-buttons">
                <button class="date-btn" onclick="setDateRange('1M')">📅 1M</button>
                <button class="date-btn" onclick="setDateRange('3M')">📅 3M</button>
                <button class="date-btn" onclick="setDateRange('6M')">📅 6M</button>
                <button class="date-btn" onclick="setDateRange('1Y')">📅 1Y</button>
                <button class="date-btn" onclick="setDateRange('2023')">📊 2023</button>
                <button class="date-btn" onclick="setDateRange('2024')">📊 2024</button>
                <button class="date-btn" onclick="setDateRange('2025')">📊 2025</button>
                <button class="date-btn" onclick="clearDateFilter()" style="background: #fef3c7; border-color: #f59e0b;">🗓️ All</button>
            </div>
            <div class="custom-date-section">
                <div class="custom-date-label">📅 Custom Range:</div>
                <div class="custom-date-inputs">
                    <input type="date" id="startDate" class="date-input" placeholder="Start">
                    <input type="date" id="endDate" class="date-input" placeholder="End">
                </div>
                <button onclick="applyCustomDateRange()" class="apply-date-btn">🎯 Apply Range</button>
            </div>
            <div id="dateRangeDisplay" class="date-range-display">All dates</div>
        </div>
        
        <!-- Search Section -->
        <div class="search-section">
            <div class="search-container">
                <input type="text" class="search-input" id="searchInput" placeholder="🔍 Search problems...">
                <button class="filter-toggle-btn" id="filterToggle">🎛️</button>
            </div>
        </div>
        
        <!-- Results Section -->
        <div class="results-section">
            <div class="results-header">
                <div class="results-count" id="resultsCount">Loading...</div>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <button class="sort-btn" id="exportBtn" onclick="exportToCSV()" style="background: #059669; color: white;">📊 Export</button>
                    <button class="sort-btn" id="sortBtn">📅 Date ↓</button>
                </div>
            </div>
            <div class="problems-list" id="problemsList">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div>Loading problems...</div>
                </div>
            </div>
        </div>
        
        <!-- Pull to Refresh Indicator -->
        <div class="pull-refresh" id="pullRefresh">
            <div class="loading-spinner" style="width: 20px; height: 20px; border-width: 2px;"></div>
            <span>Pull to refresh...</span>
        </div>
    </div>
    
    <!-- Filter Panel -->
    <div class="filter-panel" id="filterPanel">
        <div class="filter-content">
            <div class="filter-header">
                <div class="filter-title">🎛️ Filters</div>
                <button class="close-filters" id="closeFilters">×</button>
            </div>
            
            <div class="filter-section">
                <div class="filter-section-title">🏠 Units</div>
                <div class="filter-chips" id="unitFilters"></div>
            </div>
            
            <div class="filter-section">
                <div class="filter-section-title">📋 Status</div>
                <div class="filter-chips" id="statusFilters"></div>
            </div>
            
            <div class="filter-section">
                <div class="filter-section-title">⚡ Priority</div>
                <div class="filter-chips" id="priorityFilters"></div>
            </div>
            
            <div class="filter-section">
                <div class="filter-section-title">🏷️ Categories</div>
                <div class="filter-chips" id="categoryFilters"></div>
            </div>
            
            <div class="filter-section">
                <div class="filter-section-title">🏘️ Zones</div>
                <div class="filter-chips" id="zoneFilters"></div>
            </div>
            
            <div class="filter-section">
                <div class="filter-section-title">👤 Assigned To</div>
                <div class="filter-chips" id="assignedFilters"></div>
            </div>
            
            <div class="filter-actions">
                <button class="filter-action-btn btn-clear" id="clearFilters">🗑️ Clear All</button>
                <button class="filter-action-btn btn-apply" id="applyFilters">✅ Apply</button>
            </div>
        </div>
    </div>
    
    <!-- Detail View -->
    <div class="detail-view" id="detailView">
        <div class="header">
            <div class="header-content">
                <button class="back-btn" id="backToList">←</button>
                <h1 id="detailTitle">Problem Details</h1>
                <div></div>
            </div>
        </div>
        
        <div class="detail-content">
            <div class="report-actions">
                <button class="report-btn" id="viewReport">📄 View Report</button>
                <button class="report-btn secondary" id="copyReport">📋 Copy Report</button>
            </div>
            
            <div class="detail-section">
                <div class="section-header">📋 Problem Details</div>
                <div class="detail-grid">
                    <div class="detail-field">
                        <div class="detail-label">Problem ID</div>
                        <div class="detail-value" id="detailProblemId">-</div>
                    </div>
                    <div class="detail-field">
                        <div class="detail-label">Unit Number</div>
                        <div class="detail-value" id="detailUnitNumber">-</div>
                    </div>
                    <div class="detail-field">
                        <div class="detail-label">Reported Date</div>
                        <div class="detail-value" id="detailReportedDate">-</div>
                    </div>
                    <div class="detail-field">
                        <div class="detail-label">Zone</div>
                        <div class="detail-value" id="detailZone">-</div>
                    </div>
                    <div class="detail-field">
                        <div class="detail-label">Problem Description</div>
                        <div class="detail-value" id="detailDescription">-</div>
                    </div>
                </div>
            </div>
            
            <div class="detail-section">
                <div class="section-header">🔧 Management Details</div>
                <div class="detail-grid">
                    <div class="detail-field">
                        <div class="detail-label">Status</div>
                        <div class="detail-value" id="detailStatus">-</div>
                    </div>
                    <div class="detail-field">
                        <div class="detail-label">Priority</div>
                        <div class="detail-value" id="detailPriority">-</div>
                    </div>
                    <div class="detail-field">
                        <div class="detail-label">Category</div>
                        <div class="detail-value" id="detailCategory">-</div>
                    </div>
                    <div class="detail-field">
                        <div class="detail-label">Sub-Category</div>
                        <div class="detail-value" id="detailSubCategory">-</div>
                    </div>
                    <div class="detail-field">
                        <div class="detail-label">Assigned To</div>
                        <div class="detail-value" id="detailAssignedTo">-</div>
                    </div>
                    <div class="detail-field">
                        <div class="detail-label">Completion Date</div>
                        <div class="detail-value" id="detailCompletionDate">-</div>
                    </div>
                    <div class="detail-field">
                        <div class="detail-label">Comments</div>
                        <div class="detail-value" id="detailComments">-</div>
                    </div>
                </div>
            </div>
            
            <div class="detail-section">
                <div class="section-header">👥 Contact Details</div>
                <div class="detail-grid" id="contactDetails">
                    <!-- Contact details will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Report Modal -->
    <div class="report-modal hidden" id="reportModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">📄 Problem Report</div>
                <button class="close-modal" id="closeReportModal">×</button>
            </div>
            <div class="report-text" id="reportText"></div>
            <div class="modal-actions">
                <button class="report-btn secondary" id="copyFromModal" style="width: 100%;">📋 Copy to Clipboard</button>
            </div>
        </div>
    </div>
    
    <script>
        // Configuration
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzEWNgrtuamJxLUEo_dWCm9-WxoD-zDejn6LKwV3Vt8yCHv0CArlBVtzj1ad_JM0A6N/exec';
        
        // Global State
        let allProblems = [];
        let filteredProblems = [];
        let currentProblem = null;
        let currentDataset = 'current';
        let activeFilters = {
            units: new Set(),
            statuses: new Set(),
            priorities: new Set(),
            categories: new Set(),
            zones: new Set(),
            assignedTo: new Set()
        };
        let sortDirection = 'desc';
        let pullStartY = 0;
        let isPulling = false;
        let currentDateFilter = null; // Track active date filter
        let customDateRange = null; // Track custom date range { start, end }
        
        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📱 Mobile Problem Data Explorer - Starting...');
            setupEventListeners();
            setupPullToRefresh();
            loadProblemsData();
        });
        
        function setupEventListeners() {
            // Dataset toggle
            document.getElementById('currentBtn').addEventListener('click', () => switchDataset('current'));
            document.getElementById('legacyBtn').addEventListener('click', () => switchDataset('legacy'));
            
            // Search
            document.getElementById('searchInput').addEventListener('input', debounce(applyFilters, 300));
            
            // Filter panel
            document.getElementById('filterToggle').addEventListener('click', showFilterPanel);
            document.getElementById('closeFilters').addEventListener('click', hideFilterPanel);
            document.getElementById('clearFilters').addEventListener('click', clearAllFilters);
            document.getElementById('applyFilters').addEventListener('click', hideFilterPanel);
            
            // Detail view
            document.getElementById('backToList').addEventListener('click', hideDetailView);
            document.getElementById('viewReport').addEventListener('click', showReportModal);
            document.getElementById('copyReport').addEventListener('click', copyCurrentReport);
            
            // Report modal
            document.getElementById('closeReportModal').addEventListener('click', hideReportModal);
            document.getElementById('copyFromModal').addEventListener('click', copyFromModal);
            
            // Sort
            document.getElementById('sortBtn').addEventListener('click', toggleSort);
            
            // Close filter panel when clicking backdrop
            document.getElementById('filterPanel').addEventListener('click', function(e) {
                if (e.target === this) hideFilterPanel();
            });
            
            // Close report modal when clicking backdrop
            document.getElementById('reportModal').addEventListener('click', function(e) {
                if (e.target === this) hideReportModal();
            });
        }
        
        function setupPullToRefresh() {
            const problemsList = document.getElementById('problemsList');
            const pullRefresh = document.getElementById('pullRefresh');
            
            problemsList.addEventListener('touchstart', function(e) {
                if (problemsList.scrollTop === 0) {
                    pullStartY = e.touches[0].clientY;
                    isPulling = false;
                }
            });
            
            problemsList.addEventListener('touchmove', function(e) {
                if (problemsList.scrollTop === 0 && pullStartY > 0) {
                    const currentY = e.touches[0].clientY;
                    const pullDistance = currentY - pullStartY;
                    
                    if (pullDistance > 0) {
                        e.preventDefault();
                        isPulling = true;
                        
                        if (pullDistance > 60) {
                            pullRefresh.classList.add('show');
                            pullRefresh.innerHTML = '<div class="loading-spinner" style="width: 20px; height: 20px; border-width: 2px;"></div><span>Release to refresh...</span>';
                        } else {
                            pullRefresh.classList.remove('show');
                            pullRefresh.innerHTML = '<div class="loading-spinner" style="width: 20px; height: 20px; border-width: 2px;"></div><span>Pull to refresh...</span>';
                        }
                    }
                }
            });
            
            problemsList.addEventListener('touchend', function(e) {
                if (isPulling && pullRefresh.classList.contains('show')) {
                    refreshData();
                }
                pullStartY = 0;
                isPulling = false;
                pullRefresh.classList.remove('show');
            });
        }
        
        async function refreshData() {
            console.log('🔄 Refreshing data...');
            const pullRefresh = document.getElementById('pullRefresh');
            pullRefresh.innerHTML = '<div class="loading-spinner" style="width: 20px; height: 20px; border-width: 2px;"></div><span>Refreshing...</span>';
            
            try {
                if (currentDataset === 'current') {
                    await loadProblemsData();
                } else {
                    await loadLegacyData();
                }
            } catch (error) {
                console.error('Refresh failed:', error);
            }
            
            setTimeout(() => {
                pullRefresh.classList.remove('show');
            }, 500);
        }
        
        async function switchDataset(dataset) {
            console.log(`🔄 Switching to ${dataset} dataset...`);
            currentDataset = dataset;
            
            // Update UI
            document.getElementById('currentBtn').classList.toggle('active', dataset === 'current');
            document.getElementById('legacyBtn').classList.toggle('active', dataset === 'legacy');
            
            // Load appropriate data
            if (dataset === 'current') {
                await loadProblemsData();
            } else {
                await loadLegacyData();
            }
        }
        
        async function loadProblemsData() {
            try {
                console.log('📊 Loading current data...');
                showLoading();
                
                const response = await makeRequest('getFaultLogData');
                if (response && response.success && response.data) {
                    allProblems = response.data;
                    console.log(`✅ Loaded ${allProblems.length} current problems`);
                    buildFilters();
                    applyFilters();
                } else {
                    throw new Error('Failed to load current data');
                }
            } catch (error) {
                console.error('Error loading current data:', error);
                showError('Failed to load current data');
            }
        }
        
        async function loadLegacyData() {
            try {
                console.log('📚 Loading legacy data...');
                showLoading();
                
                const response = await makeRequest('getLegacyLogData');
                if (response && response.success && response.data) {
                    allProblems = response.data;
                    console.log(`✅ Loaded ${allProblems.length} legacy problems`);
                    buildFilters();
                    applyFilters();
                } else {
                    throw new Error('Failed to load legacy data');
                }
            } catch (error) {
                console.error('Error loading legacy data:', error);
                showError('Failed to load legacy data');
            }
        }
        
        function buildFilters() {
            // Extract unique values for each filter category
            const units = [...new Set(allProblems.map(p => String(p.unitNumber || '')).filter(Boolean))].sort((a, b) => {
                const numA = parseInt(a.replace(/\D/g, '') || '0') || 0;
                const numB = parseInt(b.replace(/\D/g, '') || '0') || 0;
                return numA - numB;
            });
            
            const statuses = [...new Set(allProblems.map(p => String(p.problemStatus || '')).filter(Boolean))].sort();
            const priorities = ['Urgent', 'High', 'Medium', 'Low'];
            const categories = [...new Set(allProblems.map(p => String(p.category || '')).filter(Boolean))].sort();
            const zones = [...new Set(allProblems.map(p => String(p.zone || '')).filter(Boolean))].sort();
            const assignedTo = [...new Set(allProblems.map(p => String(p.assignedTo || '')).filter(Boolean))].sort();
            
            // Build filter chips
            buildFilterChips('unitFilters', units, 'units');
            buildFilterChips('statusFilters', statuses, 'statuses');
            buildFilterChips('priorityFilters', priorities, 'priorities');
            buildFilterChips('categoryFilters', categories, 'categories');
            buildFilterChips('zoneFilters', zones, 'zones');
            buildFilterChips('assignedFilters', assignedTo, 'assignedTo');
        }
        
        function buildFilterChips(containerId, options, filterType) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = options.map(option => {
                const count = allProblems.filter(p => getFieldValue(p, filterType) === option).length;
                const isActive = activeFilters[filterType].has(option);
                
                return `
                    <div class="filter-chip ${isActive ? 'active' : ''}" 
                         onclick="toggleFilter('${filterType}', '${option}', this)">
                        ${option} (${count})
                    </div>
                `;
            }).join('');
        }
        
        function getFieldValue(problem, filterType) {
            switch (filterType) {
                case 'units': return String(problem.unitNumber || '');
                case 'statuses': return String(problem.problemStatus || '');
                case 'priorities': return String(problem.problemPriority || '');
                case 'categories': return String(problem.category || '');
                case 'zones': return String(problem.zone || '');
                case 'assignedTo': return String(problem.assignedTo || '');
                default: return '';
            }
        }
        
        function toggleFilter(filterType, value, element) {
            if (activeFilters[filterType].has(value)) {
                activeFilters[filterType].delete(value);
                element.classList.remove('active');
            } else {
                activeFilters[filterType].add(value);
                element.classList.add('active');
            }
            
            // Apply filters immediately for responsive feedback
            applyFilters();
        }
        
        function clearAllFilters() {
            // Clear all filter sets
            Object.keys(activeFilters).forEach(key => {
                activeFilters[key].clear();
            });
            
            // Clear search
            document.getElementById('searchInput').value = '';
            
            // Clear date filters
            clearDateFilter();
            
            // Update UI
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            
            // Apply filters
            applyFilters();
        }
        
        function exportToCSV() {
            if (!filteredProblems || filteredProblems.length === 0) {
                alert('No data to export. Please adjust your filters or check if data has loaded.');
                return;
            }
            
            // Define CSV headers
            const headers = [
                'Problem ID',
                'Unit Number',
                'Zone',
                'Reported Date',
                'Reported By',
                'Reporter Email',
                'Reporter Phone',
                'Problem Description',
                'Status',
                'Priority',
                'Category',
                'Sub-Category',
                'Assigned To',
                'Completion Date',
                'Comments',
                'Unit Primary Name',
                'Unit Primary Email',
                'Unit Primary Phone',
                'Last Updated'
            ];
            
            // Convert data to CSV format
            const csvData = filteredProblems.map(problem => {
                return [
                    getFriendlyPID(problem.internalId),
                    problem.unitNumber || '',
                    problem.zone || '',
                    formatDate(problem.timestamp),
                    problem.reportedBy || '',
                    problem.reporterEmail || '',
                    problem.reporterPhone || '',
                    `"${(problem.problemDescription || '').replace(/"/g, '""')}"`, // Escape quotes
                    problem.problemStatus || '',
                    problem.problemPriority || '',
                    problem.category || '',
                    problem.subCategory || '',
                    problem.assignedTo || '',
                    problem.completionDate ? formatDate(problem.completionDate) : '',
                    `"${(problem.comments || '').replace(/"/g, '""')}"`, // Escape quotes
                    problem.unitPrimaryName || '',
                    problem.unitPrimaryEmail || '',
                    problem.unitPrimaryPhone || '',
                    problem.lastUpdated ? formatDate(problem.lastUpdated) : ''
                ];
            });
            
            // Combine headers and data
            const csvContent = [headers, ...csvData]
                .map(row => row.join(','))
                .join('\n');
            
            // Create filename with current date and filter info
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0]; // YYYY-MM-DD format
            const datasetType = currentDataset === 'legacy' ? 'Legacy' : 'Current';
            const filterInfo = currentDateFilter ? `_${currentDateFilter}` : customDateRange ? '_CustomRange' : '';
            const filename = `Mobile_Problems_${datasetType}_${dateStr}${filterInfo}.csv`;
            
            // Create and trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Show success message
                const exportBtn = document.getElementById('exportBtn');
                const originalText = exportBtn.innerHTML;
                exportBtn.innerHTML = '✅ Exported!';
                exportBtn.style.backgroundColor = '#10b981';
                
                setTimeout(() => {
                    exportBtn.innerHTML = originalText;
                    exportBtn.style.backgroundColor = '#059669';
                }, 2000);
                
                console.log(`📊 CSV exported: ${filename} with ${filteredProblems.length} records`);
            } else {
                alert('CSV export not supported in this browser.');
            }
        }
        
        function applyFilters() {
            let filtered = [...allProblems];
            
            // Apply date filter first
            if (currentDateFilter || customDateRange) {
                if (customDateRange) {
                    filtered = applyCustomDateFilter(filtered);
                } else if (currentDateFilter) {
                    filtered = applyDateFilter(filtered, currentDateFilter);
                }
            }
            
            // Apply each filter type
            Object.keys(activeFilters).forEach(filterType => {
                if (activeFilters[filterType].size > 0) {
                    filtered = filtered.filter(problem => {
                        return activeFilters[filterType].has(getFieldValue(problem, filterType));
                    });
                }
            });
            
            // Apply search filter
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            if (searchTerm) {
                filtered = filtered.filter(problem => {
                    const searchableText = [
                        getFriendlyPID(problem.internalId),
                        problem.unitNumber,
                        problem.problemDescription,
                        problem.reportedBy,
                        problem.category,
                        problem.zone
                    ].filter(Boolean).join(' ').toLowerCase();
                    
                    return searchableText.includes(searchTerm);
                });
            }
            
            // Apply sorting
            filtered.sort((a, b) => {
                const dateA = parseDate(a.timestamp);
                const dateB = parseDate(b.timestamp);
                return sortDirection === 'desc' ? dateB - dateA : dateA - dateB;
            });
            
            filteredProblems = filtered;
            updateStats();
            updateResults();
        }
        
        function applyCustomDateFilter(problems) {
            if (!customDateRange) return problems;
            
            const startTime = customDateRange.start.getTime();
            const endTime = customDateRange.end.getTime();
            
            return problems.filter(problem => {
                const problemDate = parseDate(problem.timestamp);
                return problemDate >= startTime && problemDate <= endTime;
            });
        }
        
        function applyDateFilter(problems, filterType) {
            const now = new Date();
            let startDate, endDate;
            
            switch (filterType) {
                case '1M':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                    endDate = now;
                    break;
                case '3M':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 3, now.getDate());
                    endDate = now;
                    break;
                case '6M':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 6, now.getDate());
                    endDate = now;
                    break;
                case '1Y':
                    startDate = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
                    endDate = now;
                    break;
                case '2023':
                    startDate = new Date(2023, 0, 1);
                    endDate = new Date(2023, 11, 31);
                    break;
                case '2024':
                    startDate = new Date(2024, 0, 1);
                    endDate = new Date(2024, 11, 31);
                    break;
                case '2025':
                    startDate = new Date(2025, 0, 1);
                    endDate = new Date(2025, 11, 31);
                    break;
                default:
                    return problems;
            }
            
            return problems.filter(problem => {
                const problemDate = parseDate(problem.timestamp);
                return problemDate >= startDate.getTime() && problemDate <= endDate.getTime();
            });
        }
        
        function setDateRange(range) {
            currentDateFilter = range;
            customDateRange = null; // Clear custom range when using preset
            clearCustomDateInputs();
            updateDateRangeDisplay(range);
            updateDateButtonStyles(range);
            applyFilters();
        }
        
        function clearDateFilter() {
            currentDateFilter = null;
            customDateRange = null;
            clearCustomDateInputs();
            updateDateRangeDisplay('all');
            updateDateButtonStyles('all');
            applyFilters();
        }
        
        function applyCustomDateRange() {
            const startInput = document.getElementById('startDate');
            const endInput = document.getElementById('endDate');
            
            if (!startInput.value || !endInput.value) {
                alert('Please select both start and end dates');
                return;
            }
            
            const startDate = new Date(startInput.value);
            const endDate = new Date(endInput.value);
            endDate.setHours(23, 59, 59, 999); // Include the entire end date
            
            if (startDate > endDate) {
                alert('Start date must be before or equal to end date');
                return;
            }
            
            // Clear preset date filter and set custom range
            currentDateFilter = null;
            customDateRange = { start: startDate, end: endDate };
            
            // Update display
            updateDateRangeDisplay('custom');
            updateDateButtonStyles('custom');
            
            // Visual feedback for apply button
            const applyBtn = event.target;
            const originalText = applyBtn.textContent;
            applyBtn.textContent = '✅ Applied!';
            applyBtn.style.background = '#10b981';
            
            setTimeout(() => {
                applyBtn.textContent = originalText;
                applyBtn.style.background = '#3b82f6';
            }, 2000);
            
            applyFilters();
        }
        
        function clearCustomDateInputs() {
            const startInput = document.getElementById('startDate');
            const endInput = document.getElementById('endDate');
            if (startInput) startInput.value = '';
            if (endInput) endInput.value = '';
        }
        
        function updateDateRangeDisplay(range) {
            const display = document.getElementById('dateRangeDisplay');
            if (!display) return;
            
            const now = new Date();
            let text = 'All dates';
            
            if (range === 'custom' && customDateRange) {
                const startStr = customDateRange.start.toLocaleDateString('en-AU');
                const endStr = customDateRange.end.toLocaleDateString('en-AU');
                text = `Custom: ${startStr} to ${endStr}`;
            } else {
                switch (range) {
                    case '1M':
                        const oneMonth = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                        text = `Last month (from ${oneMonth.toLocaleDateString('en-AU')})`;
                        break;
                    case '3M':
                        const threeMonths = new Date(now.getFullYear(), now.getMonth() - 3, now.getDate());
                        text = `Last 3 months (from ${threeMonths.toLocaleDateString('en-AU')})`;
                        break;
                    case '6M':
                        const sixMonths = new Date(now.getFullYear(), now.getMonth() - 6, now.getDate());
                        text = `Last 6 months (from ${sixMonths.toLocaleDateString('en-AU')})`;
                        break;
                    case '1Y':
                        const oneYear = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
                        text = `Last year (from ${oneYear.toLocaleDateString('en-AU')})`;
                        break;
                    case '2023':
                        text = 'Year 2023 (1 Jan - 31 Dec)';
                        break;
                    case '2024':
                        text = 'Year 2024 (1 Jan - 31 Dec)';
                        break;
                    case '2025':
                        text = 'Year 2025 (1 Jan - 31 Dec)';
                        break;
                    default:
                        text = 'All dates';
                }
            }
            
            display.textContent = text;
        }
        
        function updateDateButtonStyles(activeRange) {
            // Reset all button styles
            document.querySelectorAll('.date-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Highlight active button
            if (activeRange && activeRange !== 'custom') {
                const btnSelector = activeRange === 'all' ? 
                    'button[onclick="clearDateFilter()"]' : 
                    `button[onclick="setDateRange('${activeRange}')"]`;
                const activeBtn = document.querySelector(btnSelector);
                if (activeBtn) {
                    activeBtn.classList.add('active');
                }
            }
        }
        
        function parseDate(dateString) {
            if (!dateString) return 0;
            
            try {
                if (dateString instanceof Date) {
                    return dateString.getTime();
                }
                
                if (typeof dateString === 'string' && dateString.includes('/')) {
                    const parts = dateString.trim().split('/');
                    if (parts.length === 3) {
                        const day = parseInt(parts[0]);
                        const month = parseInt(parts[1]) - 1;
                        const year = parseInt(parts[2]);
                        
                        if (day >= 1 && day <= 31 && month >= 0 && month <= 11 && year >= 1900) {
                            return new Date(year, month, day).getTime();
                        }
                    }
                }
                
                return new Date(dateString).getTime();
            } catch (error) {
                return 0;
            }
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'No Date';
            
            try {
                let date;
                
                if (dateString instanceof Date) {
                    date = dateString;
                } else if (typeof dateString === 'string' && dateString.includes('/')) {
                    const parts = dateString.trim().split('/');
                    if (parts.length === 3) {
                        const day = parseInt(parts[0]);
                        const month = parseInt(parts[1]) - 1;
                        const year = parseInt(parts[2]);
                        
                        if (day >= 1 && day <= 31 && month >= 0 && month <= 11 && year >= 1900) {
                            date = new Date(year, month, day);
                        } else {
                            return 'Invalid Date';
                        }
                    }
                } else {
                    date = new Date(dateString);
                }
                
                if (isNaN(date.getTime())) {
                    return 'Invalid Date';
                }
                
                return date.toLocaleDateString('en-AU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            } catch (error) {
                return 'Invalid Date';
            }
        }
        
        function updateStats() {
            const total = filteredProblems.length;
            const active = filteredProblems.filter(p => 
                p.problemStatus !== 'Completed' && p.problemStatus !== 'Cancelled'
            ).length;
            const urgent = filteredProblems.filter(p => p.problemPriority === 'Urgent').length;
            
            // Calculate average resolution time for completed problems
            const completedProblems = filteredProblems.filter(p => 
                p.problemStatus === 'Completed' && p.completionDate && p.timestamp
            );
            
            let avgDays = 'N/A';
            if (completedProblems.length > 0) {
                const totalDays = completedProblems.reduce((sum, problem) => {
                    const reportedDate = parseDate(problem.timestamp);
                    const completedDate = parseDate(problem.completionDate);
                    
                    if (reportedDate && completedDate && completedDate > reportedDate) {
                        const diffTime = completedDate - reportedDate;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        return sum + diffDays;
                    }
                    return sum;
                }, 0);
                
                if (totalDays > 0) {
                    avgDays = Math.round(totalDays / completedProblems.length);
                }
            }
            
            document.getElementById('totalProblems').textContent = total;
            document.getElementById('activeProblems').textContent = active;
            document.getElementById('urgentCount').textContent = urgent;
            document.getElementById('avgDays').textContent = avgDays;
        }
        
        function updateResults() {
            const container = document.getElementById('problemsList');
            const label = currentDataset === 'current' ? 'problems' : 'legacy problems';
            
            document.getElementById('resultsCount').textContent = `${filteredProblems.length} ${label}`;
            
            if (filteredProblems.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 3rem; margin-bottom: 16px;">📭</div>
                        <div style="font-weight: 600; margin-bottom: 8px;">No ${label} found</div>
                        <div>Try adjusting your filters or search terms</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredProblems.map(problem => createProblemCard(problem)).join('');
        }
        
        function createProblemCard(problem) {
            const friendlyPID = getFriendlyPID(problem.internalId);
            const reportedDate = formatDate(problem.timestamp);
            const priority = problem.problemPriority || 'Medium';
            const status = problem.problemStatus || 'Reported';
            const cardClass = currentDataset === 'legacy' ? 'problem-card legacy-card' : 'problem-card';
            const pidPrefix = currentDataset === 'legacy' ? '📚 ' : '';
            
            // Truncate description for mobile
            const description = problem.problemDescription || 'No description';
            const truncatedDescription = description.length > 100 ? description.substring(0, 100) + '...' : description;
            
            return `
                <div class="${cardClass}" onclick="openProblemDetails('${problem.internalId}')">
                    <div class="problem-header">
                        <div>
                            <div class="problem-id">${pidPrefix}${friendlyPID}</div>
                            <div class="problem-unit">${problem.unitNumber} • ${problem.zone || 'No Zone'}</div>
                        </div>
                    </div>
                    <div class="problem-badges">
                        <span class="badge priority-${priority.toLowerCase()}">${priority}</span>
                        <span class="badge status-${status.toLowerCase().replace(/\s+/g, '')}">${status}</span>
                    </div>
                    <div class="problem-description">${truncatedDescription}</div>
                    <div class="problem-footer">
                        <div>${reportedDate}</div>
                        <div>${problem.category || 'No Category'}</div>
                    </div>
                </div>
            `;
        }
        
        function openProblemDetails(internalId) {
            currentProblem = allProblems.find(p => p.internalId === internalId);
            if (!currentProblem) return;
            
            populateDetailView(currentProblem);
            showDetailView();
        }
        
        function populateDetailView(problem) {
            const friendlyPID = getFriendlyPID(problem.internalId);
            
            // Update header
            document.getElementById('detailTitle').textContent = friendlyPID;
            
            // Populate problem details
            document.getElementById('detailProblemId').textContent = friendlyPID;
            document.getElementById('detailUnitNumber').textContent = problem.unitNumber || 'Unknown';
            document.getElementById('detailReportedDate').textContent = formatDate(problem.timestamp);
            document.getElementById('detailZone').textContent = problem.zone || 'Unknown';
            document.getElementById('detailDescription').textContent = problem.problemDescription || 'No description available';
            
            // Populate management details
            document.getElementById('detailStatus').textContent = problem.problemStatus || 'Not assigned';
            document.getElementById('detailPriority').textContent = problem.problemPriority || 'Not assigned';
            document.getElementById('detailCategory').textContent = problem.category || 'Not assigned';
            document.getElementById('detailSubCategory').textContent = problem.subCategory || 'Not assigned';
            document.getElementById('detailAssignedTo').textContent = problem.assignedTo || 'Not assigned';
            document.getElementById('detailCompletionDate').textContent = 
                problem.completionDate ? formatDate(problem.completionDate) : 'Not completed';
            document.getElementById('detailComments').textContent = problem.comments || 'No comments';
            
            // Populate contact details
            populateContactDetails(problem);
        }
        
        function populateContactDetails(problem) {
            const container = document.getElementById('contactDetails');
            
            let contactHTML = `
                <div class="detail-field">
                    <div class="detail-label">Unit Primary Name</div>
                    <div class="detail-value">${problem.unitPrimaryName || 'Not available'}</div>
                </div>
                <div class="detail-field">
                    <div class="detail-label">Unit Primary Email</div>
                    <div class="detail-value">
                        ${problem.unitPrimaryEmail ? 
                            `<a href="mailto:${problem.unitPrimaryEmail}" class="contact-link">${problem.unitPrimaryEmail}</a>` : 
                            'Not available'
                        }
                    </div>
                </div>
                <div class="detail-field">
                    <div class="detail-label">Unit Primary Phone</div>
                    <div class="detail-value">
                        ${problem.unitPrimaryPhone ? 
                            `<a href="tel:${problem.unitPrimaryPhone.replace(/\s/g, '')}" class="contact-link">${problem.unitPrimaryPhone}</a>` : 
                            'Not available'
                        }
                    </div>
                </div>
                <div class="detail-field">
                    <div class="detail-label">Reported By</div>
                    <div class="detail-value">${problem.reportedBy || 'Unknown'}</div>
                </div>
                <div class="detail-field">
                    <div class="detail-label">Reporter Email</div>
                    <div class="detail-value">
                        ${problem.reporterEmail ? 
                            `<a href="mailto:${problem.reporterEmail}" class="contact-link">${problem.reporterEmail}</a>` : 
                            'Not available'
                        }
                    </div>
                </div>
                <div class="detail-field">
                    <div class="detail-label">Last Updated</div>
                    <div class="detail-value">${problem.lastUpdated ? formatDate(problem.lastUpdated) : 'Not available'}</div>
                </div>
            `;
            
            container.innerHTML = contactHTML;
        }
        
        function showDetailView() {
            document.getElementById('detailView').classList.add('show');
        }
        
        function hideDetailView() {
            document.getElementById('detailView').classList.remove('show');
        }
        
        function showFilterPanel() {
            document.getElementById('filterPanel').classList.add('show');
        }
        
        function hideFilterPanel() {
            document.getElementById('filterPanel').classList.remove('show');
        }
        
        function toggleSort() {
            sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
            const sortBtn = document.getElementById('sortBtn');
            sortBtn.textContent = sortDirection === 'desc' ? '📅 Date ↓' : '📅 Date ↑';
            
            applyFilters(); // Re-apply filters with new sort
        }
        
        function showReportModal() {
            if (!currentProblem) return;
            
            const report = generateProblemReport(currentProblem);
            document.getElementById('reportText').textContent = report;
            document.getElementById('reportModal').classList.remove('hidden');
        }
        
        function hideReportModal() {
            document.getElementById('reportModal').classList.add('hidden');
        }
        
        function copyCurrentReport() {
            if (!currentProblem) return;
            
            const report = generateProblemReport(currentProblem);
            copyToClipboard(report);
        }
        
        function copyFromModal() {
            const reportText = document.getElementById('reportText').textContent;
            copyToClipboard(reportText);
            hideReportModal();
        }
        
        function generateProblemReport(problem) {
            const friendlyPID = getFriendlyPID(problem.internalId);
            const reportedDate = formatDate(problem.timestamp);
            const completionDate = problem.completionDate ? formatDate(problem.completionDate) : 'Not completed';
            
            let report = 'MAINTENANCE PORTAL - PROBLEM REPORT\n';
            report += '='.repeat(60) + '\n';
            report += `Generated: ${new Date().toLocaleString('en-AU')}\n`;
            report += `Problem ID: ${friendlyPID}\n`;
            report += `Unit: ${problem.unitNumber || 'Unknown'}\n`;
            report += '='.repeat(60) + '\n\n';
            
            report += 'PROBLEM DETAILS:\n';
            report += '-'.repeat(30) + '\n';
            report += `Problem ID: ${friendlyPID}\n`;
            report += `Unit Number: ${problem.unitNumber || 'Unknown'}\n`;
            report += `Zone: ${problem.zone || 'Unknown'}\n`;
            report += `Reported Date: ${reportedDate}\n`;
            report += `Description: ${problem.problemDescription || 'No description'}\n\n`;
            
            report += 'MANAGEMENT DETAILS:\n';
            report += '-'.repeat(30) + '\n';
            report += `Status: ${problem.problemStatus || 'Unknown'}\n`;
            report += `Priority: ${problem.problemPriority || 'Unknown'}\n`;
            report += `Category: ${problem.category || 'Not assigned'}\n`;
            report += `Sub-Category: ${problem.subCategory || 'Not assigned'}\n`;
            report += `Assigned To: ${problem.assignedTo || 'Not assigned'}\n`;
            report += `Completion Date: ${completionDate}\n`;
            report += `Comments: ${problem.comments || 'No comments'}\n\n`;
            
            report += 'CONTACT DETAILS:\n';
            report += '-'.repeat(30) + '\n';
            report += `Unit Primary Name: ${problem.unitPrimaryName || 'Not available'}\n`;
            report += `Unit Primary Email: ${problem.unitPrimaryEmail || 'Not available'}\n`;
            report += `Unit Primary Phone: ${problem.unitPrimaryPhone || 'Not available'}\n`;
            report += `Reported By: ${problem.reportedBy || 'Unknown'}\n`;
            report += `Reporter Email: ${problem.reporterEmail || 'Not available'}\n`;
            report += `Reporter Phone: ${problem.reporterPhone || 'Not available'}\n\n`;
            
            report += '='.repeat(60) + '\n';
            report += 'Generated by Lake Illawong Maintenance Portal\n';
            
            return report;
        }
        
        function showLoading() {
            document.getElementById('problemsList').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div>Loading problems...</div>
                </div>
            `;
        }
        
        function showError(message) {
            document.getElementById('problemsList').innerHTML = `
                <div class="empty-state">
                    <div style="font-size: 3rem; margin-bottom: 16px;">⚠️</div>
                    <div style="font-weight: 600; margin-bottom: 8px;">Error</div>
                    <div>${message}</div>
                </div>
            `;
        }
        
        function getFriendlyPID(internalId) {
            if (!internalId) return 'PID Unknown';
            const parts = internalId.split('-');
            return parts.length === 2 ? `PID ${parts[1]}` : `PID ${internalId}`;
        }
        
        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                
                // Show success feedback
                const originalContent = event.target.innerHTML;
                event.target.innerHTML = '✅ Copied!';
                event.target.style.background = '#10b981';
                
                setTimeout(() => {
                    event.target.innerHTML = originalContent;
                    event.target.style.background = '';
                }, 2000);
            } catch (error) {
                console.error('Failed to copy to clipboard:', error);
                alert('Failed to copy to clipboard');
            }
        }
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        async function makeRequest(action, additionalData = {}) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                const script = document.createElement('script');
                const params = new URLSearchParams({
                    action: action,
                    callback: callbackName,
                    ...additionalData
                });
                
                script.src = `${WEB_APP_URL}?${params.toString()}`;
                
                window[callbackName] = function(response) {
                    document.head.removeChild(script);
                    delete window[callbackName];
                    resolve(response);
                };
                
                script.onerror = function() {
                    document.head.removeChild(script);
                    delete window[callbackName];
                    reject(new Error('Network request failed'));
                };
                
                setTimeout(() => {
                    if (window[callbackName]) {
                        document.head.removeChild(script);
                        delete window[callbackName];
                        reject(new Error('Request timeout'));
                    }
                }, 10000);
                
                document.head.appendChild(script);
            });
        }
        
        console.log('📱 Mobile Problem Data Explorer - Ready!');
    </script>
</body>
</html>