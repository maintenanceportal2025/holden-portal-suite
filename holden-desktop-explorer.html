<!DOCTYPE html>
<html lang="en">
<head> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holden Problem Data Explorer</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; line-height: 1.6; color: #334155; }
        .hidden { display: none !important; }
        .desktop-container { display: grid; grid-template-columns: 320px 1fr; grid-template-rows: auto 1fr; height: 100vh; }
        .header { grid-column: 1 / -1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px 24px; }
        .header h1 { font-size: 1.75rem; font-weight: 600; margin-bottom: 4px; }
        .header p { opacity: 0.9; font-size: 1rem; margin-bottom: 12px; }
        .header-actions { display: flex; justify-content: space-between; align-items: center; gap: 12px; }
        .dataset-toggle { background: rgba(255,255,255,0.2); border-radius: 8px; padding: 3px; display: flex; gap: 2px; }
        .dataset-btn { background: transparent; color: white; padding: 6px 12px; border: none; border-radius: 6px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; }
        .dataset-btn.active { background: rgba(255,255,255,0.3); font-weight: 600; }
        .access-badge { background: rgba(255,255,255,0.2); padding: 6px 16px; border-radius: 20px; font-size: 0.9rem; }
        .filters-sidebar { background: white; border-right: 1px solid #e2e8f0; padding: 20px; overflow-y: auto; }
        .sidebar-header { display: flex; align-items: center; gap: 8px; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #e2e8f0; }
        .sidebar-title { font-weight: 700; color: #1e293b; font-size: 1.1rem; }
        .filter-section { margin-bottom: 28px; }
        .filter-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .filter-label { font-weight: 600; color: #374151; font-size: 0.95rem; }
        .search-input { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.9rem; background: white; margin-bottom: 20px; }
        .checkbox-list { display: flex; flex-direction: column; gap: 8px; max-height: 200px; overflow-y: auto; padding: 4px; }
        .checkbox-item { display: flex; align-items: center; gap: 8px; padding: 6px 8px; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .checkbox-item:hover { background: #f1f5f9; }
        .checkbox-item input { margin: 0; cursor: pointer; }
        .checkbox-item label { cursor: pointer; font-size: 0.85rem; flex: 1; }
        .main-content { padding: 20px; overflow-y: auto; }
        .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 16px 20px; background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .results-info { font-size: 1.1rem; color: #1e293b; font-weight: 600; }
        .results-actions { display: flex; gap: 8px; align-items: center; }
        .sort-btn { background: #3b82f6; color: white; padding: 8px 16px; border: none; border-radius: 8px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; }
        .sort-btn:hover { background: #2563eb; }
        .sort-btn.active { background: #1d4ed8; }
        .export-btn { background: #059669; color: white; padding: 8px 16px; border: none; border-radius: 8px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; }
        .export-btn:hover { background: #047857; }
        .problems-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 16px; }
        .problem-card { background: white; border-radius: 12px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: all 0.2s; cursor: pointer; border-left: 4px solid #e5e7eb; }
        .problem-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translateY(-2px); }
        .problem-card.urgent { border-left-color: #ef4444; }
        .problem-card.high { border-left-color: #f97316; }
        .problem-card.medium { border-left-color: #eab308; }
        .problem-card.low { border-left-color: #22c55e; }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .card-top-line { display: flex; align-items: center; gap: 8px; }
        .card-pid { font-weight: 700; color: #1e293b; font-size: 1.1rem; }
        .card-unit { background: #f1f5f9; color: #475569; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; }
        .card-zone { background: #e0f2fe; color: #0369a1; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; }
        .card-body { margin-bottom: 12px; }
        .card-description { color: #64748b; font-size: 0.9rem; line-height: 1.4; margin-bottom: 8px; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .card-meta { display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: #64748b; margin-bottom: 12px; }
        .card-footer { display: flex; gap: 8px; align-items: center; }
        .status-badge { padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .status-reported { background: #dbeafe; color: #1d4ed8; }
        .status-in-progress { background: #fef3c7; color: #d97706; }
        .status-completed { background: #d1fae5; color: #047857; }
        .status-on-hold { background: #fde2e8; color: #be185d; }
        .priority-badge { padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; }
        .priority-urgent { background: #fecaca; color: #dc2626; }
        .priority-high { background: #fed7aa; color: #ea580c; }
        .priority-medium { background: #fef3c7; color: #d97706; }
        .priority-low { background: #bbf7d0; color: #16a34a; }
        .loading { text-align: center; padding: 60px 20px; color: #64748b; }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid #e2e8f0; border-top: 3px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; border-radius: 12px; width: 90%; max-width: 900px; max-height: 90%; overflow: hidden; display: flex; flex-direction: column; }
        .modal-header { padding: 20px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 1.25rem; font-weight: 600; color: #1e293b; }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b; }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        .detail-section { margin-bottom: 24px; }
        .detail-label { font-weight: 600; color: #374151; margin-bottom: 8px; }
        .detail-value { color: #64748b; line-height: 1.5; }
        .report-btn { background: #3b82f6; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; margin-right: 10px; }
        .report-btn.green { background: #059669; }
        .report-btn.secondary { background: #6b7280; }
        .date-range-display { font-size: 0.75rem; color: #64748b; text-align: center; padding: 4px; background: #f8fafc; border-radius: 4px; margin-bottom: 8px; }
        .filter-buttons { display: flex; gap: 4px; margin-bottom: 8px; }
        .filter-btn { background: #f8fafc; border: 1px solid #e2e8f0; padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer; }
        .filter-btn:hover { background: #f1f5f9; }
        .clear-all-btn { width: 100%; background: #ef4444; color: white; border: none; padding: 12px; border-radius: 8px; font-size: 0.9rem; cursor: pointer; font-weight: 600; margin-top: 20px; }
        .clear-all-btn:hover { background: #dc2626; }
        .items-per-page { margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0; }
        .items-per-page label { font-size: 0.8rem; color: #64748b; margin-bottom: 8px; font-weight: 500; display: block; }
        .items-per-page select { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.85rem; }
    </style>
</head>
<body>
    <div class="desktop-container">
        <div class="header">
            <h1>üîç Problem Data Explorer</h1>
            <p>Comprehensive maintenance problem analysis and reporting</p>
            <div class="header-actions">
                <div class="dataset-toggle">
                    <button class="dataset-btn active" id="currentBtn">üìä Current Data</button>
                    <button class="dataset-btn" id="legacyBtn">üìö Legacy Data</button>
                </div>
                <div class="access-badge">Live Data</div>
            </div>
        </div>
        <div class="filters-sidebar">
            <div class="sidebar-header">
                <span class="sidebar-title">üéõÔ∏è Data Slicers</span>
            </div>
            <input type="text" id="searchInput" class="search-input" placeholder="üîç Search PID, unit, description, zone...">
            
            <div class="filter-section">
                <div class="filter-header"><div class="filter-label">üìÖ Date Range</div></div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 12px;">
                    <button onclick="setDateRange('1M')" class="filter-btn">üìÖ 1M</button>
                    <button onclick="setDateRange('3M')" class="filter-btn">üìÖ 3M</button>
                    <button onclick="setDateRange('6M')" class="filter-btn">üìÖ 6M</button>
                    <button onclick="setDateRange('1Y')" class="filter-btn">üìÖ 1Y</button>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 12px;">
                    <button onclick="setDateRange('2023')" class="filter-btn">üìä 2023</button>
                    <button onclick="setDateRange('2024')" class="filter-btn">üìä 2024</button>
                    <button onclick="setDateRange('2025')" class="filter-btn">üìä 2025</button>
                    <button onclick="clearDateFilter()" style="background: #fef3c7; border-color: #f59e0b;" class="filter-btn">üóìÔ∏è All</button>
                </div>
                <div style="border-top: 1px solid #e2e8f0; margin: 12px 0; padding-top: 12px;">
                    <div style="font-size: 0.8rem; color: #64748b; margin-bottom: 8px; font-weight: 500;">üìÖ Custom Range:</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 8px;">
                        <input type="date" id="startDate" style="padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.75rem;">
                        <input type="date" id="endDate" style="padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.75rem;">
                    </div>
                    <button onclick="applyCustomDateRange()" style="width: 100%; background: #3b82f6; color: white; border: none; padding: 8px; border-radius: 6px; font-size: 0.75rem; cursor: pointer; font-weight: 500;">üéØ Apply Range</button>
                </div>
                <div id="dateRangeDisplay" class="date-range-display">All dates</div>
            </div>
            
            <div class="filter-section">
                <div class="filter-header"><div class="filter-label">üè† Units</div></div>
                <div class="filter-buttons">
                    <button onclick="selectAllUnits()" class="filter-btn">All</button>
                    <button onclick="clearUnits()" class="filter-btn">Clear</button>
                </div>
                <div class="checkbox-list" id="unitFilters"></div>
            </div>
            
            <div class="filter-section">
                <div class="filter-header"><div class="filter-label">üìã Status</div></div>
                <div class="filter-buttons">
                    <button onclick="selectAllStatuses()" class="filter-btn">All</button>
                    <button onclick="clearStatuses()" class="filter-btn">Clear</button>
                </div>
                <div class="checkbox-list" id="statusFilters"></div>
            </div>
            
            <div class="filter-section">
                <div class="filter-header"><div class="filter-label">‚ö° Priority</div></div>
                <div class="filter-buttons">
                    <button onclick="selectAllPriorities()" class="filter-btn">All</button>
                    <button onclick="clearPriorities()" class="filter-btn">Clear</button>
                </div>
                <div class="checkbox-list" id="priorityFilters"></div>
            </div>
            
            <div class="filter-section">
                <div class="filter-header"><div class="filter-label">üìÇ Category</div></div>
                <div class="filter-buttons">
                    <button onclick="selectAllCategories()" class="filter-btn">All</button>
                    <button onclick="clearCategories()" class="filter-btn">Clear</button>
                </div>
                <div class="checkbox-list" id="categoryFilters"></div>
            </div>
            
            <div class="filter-section">
                <div class="filter-header"><div class="filter-label">üèòÔ∏è Zone</div></div>
                <div class="filter-buttons">
                    <button onclick="selectAllZones()" class="filter-btn">All</button>
                    <button onclick="clearZones()" class="filter-btn">Clear</button>
                </div>
                <div class="checkbox-list" id="zoneFilters"></div>
            </div>
            
            <div class="filter-section">
                <div class="filter-header"><div class="filter-label">üë∑ Assigned To</div></div>
                <div class="filter-buttons">
                    <button onclick="selectAllAssigned()" class="filter-btn">All</button>
                    <button onclick="clearAssigned()" class="filter-btn">Clear</button>
                </div>
                <div class="checkbox-list" id="assignedToFilters"></div>
            </div>
            
            <button id="clearAllFiltersBtn" class="clear-all-btn">üóëÔ∏è Clear All Filters</button>
            
            <div class="items-per-page">
                <label for="itemsPerPageSelect">üìÑ Items Per Page:</label>
                <select id="itemsPerPageSelect">
                    <option value="10">10 per page</option>
                    <option value="20" selected>20 per page</option>
                    <option value="50">50 per page</option>
                    <option value="100">100 per page</option>
                    <option value="all">Show all</option>
                </select>
            </div>
        </div>
        
        <div class="main-content">
            <div class="results-header">
                <div class="results-info" id="resultsInfo">Loading...</div>
                <div class="results-actions">
                    <button class="sort-btn" id="sortToggleBtn" onclick="toggleSort()">üìÖ Newest First</button>
                    <button class="export-btn" onclick="exportToCSV()">üìä Export CSV</button>
                </div>
            </div>
            <div class="problems-grid" id="problemsGrid">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div>Loading problems...</div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal hidden" id="problemModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Problem Details</div>
                <button class="close-btn" id="closeProblemModal">√ó</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <div class="modal hidden" id="reportModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üìÑ Problem Report</div>
                <button class="close-btn" id="closeReportModal">√ó</button>
            </div>
            <pre id="reportText" style="white-space: pre-wrap; font-family: monospace; font-size: 12px; background: #f8f9fa; padding: 20px; border-radius: 6px; max-height: 60vh; overflow-y: auto;"></pre>
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button id="copyReportFromModal" class="report-btn green">üìã Copy to Clipboard</button>
            </div>
        </div>
    </div>

    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzEWNgrtuamJxLUEo_dWCm9-WxoD-zDejn6LKwV3Vt8yCHv0CArlBs9ouC5v8kD7k';
        let allProblems = [], filteredProblems = [], currentProblem = null, currentDataset = 'current';
        let currentDateFilter = null, customDateRange = null, sortDirection = 'desc';
        let dynamicDropdowns = {}, currentPage = 1, ITEMS_PER_PAGE = 20;
        
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('currentBtn').addEventListener('click', () => switchDataset('current'));
            document.getElementById('legacyBtn').addEventListener('click', () => switchDataset('legacy'));
            document.getElementById('searchInput').addEventListener('input', () => setTimeout(applyFilters, 300));
            document.getElementById('closeProblemModal').addEventListener('click', closeModal);
            document.getElementById('closeReportModal').addEventListener('click', closeModal);
            document.getElementById('copyReportFromModal').addEventListener('click', copyFromModal);
            document.getElementById('problemModal').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeModal(); });
            document.getElementById('reportModal').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeModal(); });
            document.getElementById('clearAllFiltersBtn').addEventListener('click', clearAllFilters);
            document.getElementById('itemsPerPageSelect').addEventListener('change', changeItemsPerPage);
            loadProblemsData();
            loadDynamicDropdowns();
        });

        async function loadDynamicDropdowns() {
            try {
                const response = await makeRequest('getDropdownOptions');
                if (response && response.success) {
                    dynamicDropdowns = response.data || {};
                } else {
                    dynamicDropdowns = {
                        categories: ['Aircon', 'Doors', 'Electrical', 'Plumbing'],
                        assignedTo: ['Ben', 'Jade', 'David', 'Gardening Club']
                    };
                }
            } catch (error) {
                dynamicDropdowns = {};
            }
        }

        function changeItemsPerPage() {
            const value = document.getElementById('itemsPerPageSelect').value;
            ITEMS_PER_PAGE = value === 'all' ? filteredProblems.length || 1000 : parseInt(value);
            currentPage = 1;
            updateResults();
        }
        
        async function switchDataset(dataset) {
            currentDataset = dataset;
            document.getElementById('currentBtn').classList.toggle('active', dataset === 'current');
            document.getElementById('legacyBtn').classList.toggle('active', dataset === 'legacy');
            document.querySelector('.access-badge').textContent = dataset === 'current' ? 'Live Data' : 'Legacy Data';
            currentPage = 1;
            if (dataset === 'current') { 
                await loadProblemsData(); 
            } else { 
                await loadLegacyData(); 
            }
        }
        
        async function loadLegacyData() {
            try {
                const response = await makeRequest('getLegacyLogData');
                if (response && response.success) {
                    allProblems = response.data || [];
                    currentDateFilter = null;
                    customDateRange = null;
                    clearCustomDateInputs();
                    updateDateRangeDisplay('all');
                    buildFilters(); 
                    applyFilters();
                } else { 
                    throw new Error('Failed to load legacy data'); 
                }
            } catch (error) {
                showError('Failed to load legacy data');
            }
        }
        
        async function loadProblemsData() {
            try {
                const response = await makeRequest('getFaultLogData');
                if (response && response.success) {
                    allProblems = response.data || [];
                    buildFilters(); 
                    applyFilters();
                } else { 
                    throw new Error('Failed to load data'); 
                }
            } catch (error) {
                showError('Failed to load data');
            }
        }
        
        function buildFilters() {
            const units = [...new Set(allProblems.map(p => String(p.unitNumber || '')).filter(Boolean))].sort((a, b) => {
                const numA = parseInt(a.replace(/\D/g, '') || '0') || 0;
                const numB = parseInt(b.replace(/\D/g, '') || '0') || 0;
                return numA - numB;
            });
            buildCheckboxSection('unitFilters', units);
            
            const statuses = [...new Set(allProblems.map(p => String(p.problemStatus || '')).filter(Boolean))].sort();
            buildCheckboxSection('statusFilters', statuses);
            
            const priorities = ['Urgent', 'High', 'Medium', 'Low'];
            buildCheckboxSection('priorityFilters', priorities);
            
            const categories = dynamicDropdowns.categories && dynamicDropdowns.categories.length > 0 
                ? dynamicDropdowns.categories 
                : [...new Set(allProblems.map(p => String(p.category || '')).filter(Boolean))].sort();
            buildCheckboxSection('categoryFilters', categories);
            
            const zones = [...new Set(allProblems.map(p => String(p.zone || '')).filter(Boolean))].sort();
            buildCheckboxSection('zoneFilters', zones);
            
            const assignedTo = dynamicDropdowns.assignedTo && dynamicDropdowns.assignedTo.length > 0
                ? dynamicDropdowns.assignedTo
                : [...new Set(allProblems.map(p => String(p.assignedTo || '')).filter(Boolean))].sort();
            buildCheckboxSection('assignedToFilters', assignedTo);
        }
        
        function buildCheckboxSection(containerId, items) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            items.forEach(item => {
                if (!item) return;
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.value = item;
                input.checked = true;
                input.addEventListener('change', applyFilters);
                const label = document.createElement('label');
                label.textContent = item;
                div.appendChild(input);
                div.appendChild(label);
                container.appendChild(div);
            });
        }

        function toggleSort() {
            sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
            document.getElementById('sortToggleBtn').textContent = sortDirection === 'desc' ? 'üìÖ Newest First' : 'üìÖ Oldest First';
            applyFilters();
        }
        
        function applyFilters() {
            let filtered = [...allProblems];
            
            if (currentDateFilter || customDateRange) {
                if (customDateRange) {
                    filtered = applyCustomDateFilter(filtered);
                } else if (currentDateFilter) {
                    filtered = applyDateFilter(filtered, currentDateFilter);
                }
            }
            
            ['unit', 'status', 'priority', 'category', 'zone', 'assignedTo'].forEach(filterType => {
                const checked = Array.from(document.querySelectorAll(`#${filterType}Filters input:checked`)).map(cb => cb.value);
                const all = Array.from(document.querySelectorAll(`#${filterType}Filters input`)).map(cb => cb.value);
                if (checked.length < all.length && checked.length > 0) {
                    filtered = filtered.filter(p => checked.includes(getFieldValue(p, filterType)));
                }
            });
            
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            if (searchTerm) {
                filtered = filtered.filter(problem => {
                    const searchText = [
                        getFriendlyPID(problem.internalId), 
                        problem.unitNumber, 
                        problem.problemDescription, 
                        problem.reportedBy,
                        problem.zone
                    ].filter(Boolean).join(' ').toLowerCase();
                    return searchText.includes(searchTerm);
                });
            }
            
            filtered.sort((a, b) => {
                const dateA = parseDate(a.timestamp);
                const dateB = parseDate(b.timestamp);
                
                if (sortDirection === 'desc') {
                    if (dateB !== dateA) return dateB - dateA;
                    return getFriendlyPID(b.internalId).localeCompare(getFriendlyPID(a.internalId));
                } else {
                    if (dateA !== dateB) return dateA - dateB;
                    return getFriendlyPID(a.internalId).localeCompare(getFriendlyPID(b.internalId));
                }
            });
            
            filteredProblems = filtered;
            currentPage = 1;
            updateResults();
        }
        
        function clearAllFilters() {
            currentDateFilter = null;
            customDateRange = null;
            clearCustomDateInputs();
            updateDateRangeDisplay('all');
            document.getElementById('searchInput').value = '';
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.style.background = '#f8fafc';
                btn.style.borderColor = '#e2e8f0';
            });
            currentPage = 1;
            applyFilters();
        }
        
        function applyCustomDateFilter(problems) {
            if (!customDateRange) return problems;
            const startTime = customDateRange.start.getTime();
            const endTime = customDateRange.end.getTime();
            return problems.filter(problem => {
                const problemDate = parseDate(problem.timestamp);
                return problemDate >= startTime && problemDate <= endTime;
            });
        }
        
        function applyDateFilter(problems, range) {
            const now = new Date();
            let startDate, endDate;
            
            switch (range) {
                case '1M': startDate = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate()); endDate = now; break;
                case '3M': startDate = new Date(now.getFullYear(), now.getMonth() - 3, now.getDate()); endDate = now; break;
                case '6M': startDate = new Date(now.getFullYear(), now.getMonth() - 6, now.getDate()); endDate = now; break;
                case '1Y': startDate = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate()); endDate = now; break;
                case '2023': startDate = new Date(2023, 0, 1); endDate = new Date(2023, 11, 31); break;
                case '2024': startDate = new Date(2024, 0, 1); endDate = new Date(2024, 11, 31); break;
                case '2025': startDate = new Date(2025, 0, 1); endDate = new Date(2025, 11, 31); break;
                default: return problems;
            }
            
            return problems.filter(problem => {
                const problemDate = parseDate(problem.timestamp);
                return problemDate >= startDate.getTime() && problemDate <= endDate.getTime();
            });
        }
        
        function setDateRange(range) {
            currentDateFilter = range;
            customDateRange = null;
            clearCustomDateInputs();
            updateDateRangeDisplay(range);
            applyFilters();
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.style.background = '#f8fafc';
                btn.style.borderColor = '#e2e8f0';
            });
            
            event.target.style.background = '#dbeafe';
            event.target.style.borderColor = '#3b82f6';
        }
        
        function clearDateFilter() {
            currentDateFilter = null;
            customDateRange = null;
            clearCustomDateInputs();
            updateDateRangeDisplay('all');
            applyFilters();
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.style.background = '#f8fafc';
                btn.style.borderColor = '#e2e8f0';
            });
        }
        
        function applyCustomDateRange() {
            const startInput = document.getElementById('startDate');
            const endInput = document.getElementById('endDate');
            
            if (!startInput.value || !endInput.value) {
                alert('Please select both start and end dates');
                return;
            }
            
            const startDate = new Date(startInput.value);
            const endDate = new Date(endInput.value);
            
            if (startDate > endDate) {
                alert('Start date must be before end date');
                return;
            }
            
            customDateRange = { start: startDate, end: endDate };
            currentDateFilter = null;
            updateDateRangeDisplay('custom');
            applyFilters();
        }
        
        function clearCustomDateInputs() {
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
        }
        
        function updateDateRangeDisplay(range) {
            const display = document.getElementById('dateRangeDisplay');
            let text;
            
            if (customDateRange) {
                const start = customDateRange.start.toLocaleDateString('en-AU');
                const end = customDateRange.end.toLocaleDateString('en-AU');
                text = `Custom: ${start} - ${end}`;
            } else {
                switch (range) {
                    case '1M': text = 'Last 1 month'; break;
                    case '3M': text = 'Last 3 months'; break;
                    case '6M': text = 'Last 6 months'; break;
                    case '1Y': text = 'Last 1 year'; break;
                    case '2023': text = 'Year 2023 (1 Jan - 31 Dec)'; break;
                    case '2024': text = 'Year 2024 (1 Jan - 31 Dec)'; break;
                    case '2025': text = 'Year 2025 (1 Jan - 31 Dec)'; break;
                    default: text = 'All dates';
                }
            }
            
            display.textContent = text;
        }
        
        function parseDate(dateString) {
            if (!dateString) return 0;
            try {
                if (dateString instanceof Date) return dateString.getTime();
                if (typeof dateString === 'string' && dateString.includes('/')) {
                    const parts = dateString.trim().split('/');
                    if (parts.length === 3) {
                        const month = parseInt(parts[0]) - 1;
                        const day = parseInt(parts[1]);
                        const year = parseInt(parts[2]);
                        if (day >= 1 && day <= 31 && month >= 0 && month <= 11 && year >= 1900) {
                            return new Date(year, month, day).getTime();
                        }
                    }
                }
                return new Date(dateString).getTime();
            } catch (error) { 
                return 0; 
            }
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'No Date';
            try {
                let date;
                if (dateString instanceof Date) {
                    date = dateString;
                } else if (typeof dateString === 'string' && dateString.includes('/')) {
                    const parts = dateString.trim().split('/');
                    if (parts.length === 3) {
                        const month = parseInt(parts[0]) - 1;
                        const day = parseInt(parts[1]);
                        const year = parseInt(parts[2]);
                        if (day >= 1 && day <= 31 && month >= 0 && month <= 11 && year >= 1900) {
                            date = new Date(year, month, day);
                        } else { 
                            return 'Invalid Date'; 
                        }
                    }
                } else { 
                    date = new Date(dateString); 
                }
                
                return isNaN(date.getTime()) ? 'Invalid Date' : date.toLocaleDateString('en-AU', {
                    day: '2-digit',
                    month: '2-digit', 
                    year: 'numeric'
                });
            } catch (error) {
                return 'Invalid Date';
            }
        }
        
        function getFriendlyPID(internalId) {
            if (!internalId) return 'Unknown';
            if (typeof internalId === 'string' && internalId.includes('-')) {
                const parts = internalId.split('-');
                return parts.length > 1 ? `PID ${parts[parts.length - 1]}` : `PID ${internalId}`;
            }
            return `PID ${internalId}`;
        }
        
        function getFieldValue(problem, fieldType) {
            switch (fieldType) {
                case 'unit': return problem.unitNumber;
                case 'status': return problem.problemStatus;
                case 'priority': return problem.problemPriority;
                case 'category': return problem.category;
                case 'zone': return problem.zone;
                case 'assignedTo': return problem.assignedTo;
                default: return '';
            }
        }
        
        function updateResults() {
            const resultsInfo = document.getElementById('resultsInfo');
            const problemsGrid = document.getElementById('problemsGrid');
            
            const totalItems = filteredProblems.length;
            const itemsPerPage = document.getElementById('itemsPerPageSelect').value === 'all' ? totalItems : ITEMS_PER_PAGE;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
            const paginatedProblems = filteredProblems.slice(startIndex, endIndex);
            
            resultsInfo.innerHTML = `<div>${totalItems} problems found${totalPages > 1 ? ` <span style="color: #64748b; font-weight: normal;">(Page ${currentPage} of ${totalPages})</span>` : ''}</div>`;
            
            if (filteredProblems.length === 0) {
                problemsGrid.innerHTML = '<div class="loading">No problems found matching current filters</div>';
                return;
            }
            
            problemsGrid.innerHTML = '';
            
            if (totalPages > 1) {
                const paginationContainer = document.createElement('div');
                paginationContainer.style.cssText = 'display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 20px; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);';
                
                const prevBtn = document.createElement('button');
                prevBtn.textContent = '‚Üê Previous';
                prevBtn.disabled = currentPage === 1;
                prevBtn.style.cssText = `padding: 8px 16px; border: 1px solid #e2e8f0; border-radius: 6px; background: ${currentPage === 1 ? '#f8fafc' : '#3b82f6'}; color: ${currentPage === 1 ? '#9ca3af' : 'white'}; cursor: ${currentPage === 1 ? 'not-allowed' : 'pointer'};`;
                prevBtn.onclick = () => {
                    if (currentPage > 1) {
                        currentPage--;
                        updateResults();
                    }
                };
                
                const pageInfo = document.createElement('span');
                pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
                pageInfo.style.cssText = 'font-weight: 600; color: #374151;';
                
                const nextBtn = document.createElement('button');
                nextBtn.textContent = 'Next ‚Üí';
                nextBtn.disabled = currentPage === totalPages;
                nextBtn.style.cssText = `padding: 8px 16px; border: 1px solid #e2e8f0; border-radius: 6px; background: ${currentPage === totalPages ? '#f8fafc' : '#3b82f6'}; color: ${currentPage === totalPages ? '#9ca3af' : 'white'}; cursor: ${currentPage === totalPages ? 'not-allowed' : 'pointer'};`;
                nextBtn.onclick = () => {
                    if (currentPage < totalPages) {
                        currentPage++;
                        updateResults();
                    }
                };
                
                paginationContainer.appendChild(prevBtn);
                paginationContainer.appendChild(pageInfo);
                paginationContainer.appendChild(nextBtn);
                problemsGrid.appendChild(paginationContainer);
            }
            
            paginatedProblems.forEach(problem => {
                const card = createProblemCard(problem);
                problemsGrid.appendChild(card);
            });
            
            if (totalPages > 1) {
                const bottomPagination = problemsGrid.firstChild.cloneNode(true);
                problemsGrid.appendChild(bottomPagination);
            }
        }
        
        function createProblemCard(problem) {
            const card = document.createElement('div');
            card.className = `problem-card ${(problem.problemPriority || 'medium').toLowerCase()}`;
            card.onclick = () => showProblemDetail(problem);
            
            const priorityClass = `priority-${(problem.problemPriority || 'medium').toLowerCase()}`;
            const statusClass = `status-${(problem.problemStatus || 'reported').toLowerCase().replace(/\s+/g, '-')}`;
            
            card.innerHTML = `
                <div class="card-header">
                    <div class="card-top-line">
                        <div class="card-pid">${getFriendlyPID(problem.internalId)}</div>
                        <div class="card-unit">${problem.unitNumber || 'No Unit'}</div>
                        ${problem.zone ? `<div class="card-zone">${problem.zone}</div>` : ''}
                    </div>
                </div>
                <div class="card-body">
                    <div class="card-description">${problem.problemDescription || 'No description'}</div>
                    <div class="card-meta">
                        <span>üìÖ ${formatDate(problem.timestamp)}</span>
                        <span>üë§ ${problem.reportedBy || 'Unknown'}</span>
                    </div>
                </div>
                <div class="card-footer">
                    <span class="status-badge ${statusClass}">${problem.problemStatus || 'Reported'}</span>
                    <span class="priority-badge ${priorityClass}">${problem.problemPriority || 'Medium'}</span>
                </div>
            `;
            
            return card;
        }
        
        function showProblemDetail(problem) {
            currentProblem = problem;
            const modal = document.getElementById('problemModal');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');
            
            title.textContent = getFriendlyPID(problem.internalId) + ' - ' + (problem.unitNumber || 'No Unit');
            
            let modalContent = '';
            modalContent += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">';
            modalContent += '<div class="detail-section"><div class="detail-label">üìã Problem Information</div><div class="detail-value">';
            modalContent += '<strong>Problem ID:</strong> ' + getFriendlyPID(problem.internalId) + '<br>';
            modalContent += '<strong>Unit:</strong> ' + (problem.unitNumber || 'Not specified') + '<br>';
            modalContent += '<strong>Zone:</strong> ' + (problem.zone || 'Not specified') + '<br>';
            modalContent += '<strong>Reported Date:</strong> ' + formatDate(problem.timestamp);
            modalContent += '</div></div>';
            modalContent += '<div class="detail-section"><div class="detail-label">üë§ Reporter Information</div><div class="detail-value">';
            modalContent += '<strong>Reported By:</strong> ' + (problem.reportedBy || 'Unknown') + '<br>';
            modalContent += '<strong>Reporter Email:</strong> ' + (problem.reporterEmail || 'Not provided') + '<br>';
            modalContent += '<strong>Unit Owner:</strong> ' + (problem.residentName || 'Not specified') + '<br>';
            modalContent += '<strong>Unit Contact:</strong> ' + (problem.residentMobile || 'Not provided');
            modalContent += '</div></div></div>';
            
            modalContent += '<div class="detail-section"><div class="detail-label">üìù Problem Description</div>';
            modalContent += '<div class="detail-value" style="background: #f8fafc; padding: 12px; border-radius: 6px; border-left: 3px solid #3b82f6;">';
            modalContent += (problem.problemDescription || 'No description provided');
            modalContent += '</div></div>';
            
            modalContent += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">';
            modalContent += '<div class="detail-section"><div class="detail-label">‚öôÔ∏è Management Status</div><div class="detail-value">';
            
            const statusClass = 'status-' + (problem.problemStatus || 'reported').toLowerCase().replace(/\s+/g, '-');
            const priorityClass = 'priority-' + (problem.problemPriority || 'medium').toLowerCase();
            
            modalContent += '<strong>Status:</strong> <span class="status-badge ' + statusClass + '">' + (problem.problemStatus || 'Reported') + '</span><br><br>';
            modalContent += '<strong>Priority:</strong> <span class="priority-badge ' + priorityClass + '">' + (problem.problemPriority || 'Medium') + '</span><br><br>';
            modalContent += '<strong>Category:</strong> ' + (problem.category || 'Not categorized') + '<br>';
            modalContent += '<strong>Sub-Category:</strong> ' + (problem.subCategory || 'Not specified');
            modalContent += '</div></div>';
            modalContent += '<div class="detail-section"><div class="detail-label">üë∑ Assignment & Completion</div><div class="detail-value">';
            modalContent += '<strong>Assigned To:</strong> ' + (problem.assignedTo || 'Unassigned') + '<br><br>';
            modalContent += '<strong>Completion Date:</strong> ' + (problem.completionDate ? formatDate(problem.completionDate) : 'Not completed') + '<br><br>';
            modalContent += '<strong>Last Updated:</strong> ' + (problem.lastUpdated ? formatDate(problem.lastUpdated) : 'Not updated');
            modalContent += '</div></div></div>';
            
            if (problem.comments) {
                modalContent += '<div class="detail-section"><div class="detail-label">üí¨ Comments & Notes</div>';
                modalContent += '<div class="detail-value" style="background: #fffbeb; padding: 12px; border-radius: 6px; border-left: 3px solid #f59e0b; white-space: pre-wrap; max-height: 200px; overflow-y: auto;">';
                modalContent += problem.comments;
                modalContent += '</div></div>';
            }
            
            modalContent += '<div style="margin-top: 30px; display: flex; gap: 10px; justify-content: center; padding-top: 20px; border-top: 1px solid #e2e8f0;">';
            modalContent += '<button class="report-btn" onclick="showReport()">üìÑ Generate Report</button>';
            modalContent += '<button class="report-btn green" onclick="exportSingleProblemCSV()">üìä Export CSV</button>';
            modalContent += '<button class="report-btn secondary" onclick="closeModal()">‚úñÔ∏è Close</button>';
            modalContent += '</div>';
            
            body.innerHTML = modalContent;
            modal.classList.remove('hidden');
        }
        
        function showReport() {
            if (!currentProblem) return;
            const report = generateSingleProblemReport(currentProblem);
            document.getElementById('reportText').textContent = report;
            document.getElementById('reportModal').classList.remove('hidden');
        }
        
        function generateSingleProblemReport(problem) {
            const now = new Date();
            return `MAINTENANCE PROBLEM REPORT
${'='.repeat(50)}

Generated: ${now.toLocaleDateString('en-AU')} at ${now.toLocaleTimeString('en-AU')}
Report Type: Individual Problem Analysis

PROBLEM IDENTIFICATION:
${'-'.repeat(25)}
Problem ID: ${getFriendlyPID(problem.internalId)}
Unit Number: ${problem.unitNumber || 'Not specified'}
Zone: ${problem.zone || 'Not specified'}

REPORTING INFORMATION:
${'-'.repeat(25)}
Reported Date: ${formatDate(problem.timestamp)}
Reported By: ${problem.reportedBy || 'Unknown'}
Reporter Email: ${problem.reporterEmail || 'Not provided'}

PROBLEM DETAILS:
${'-'.repeat(25)}
Description: ${problem.problemDescription || 'No description provided'}

MANAGEMENT STATUS:
${'-'.repeat(25)}
Current Status: ${problem.problemStatus || 'Reported'}
Priority Level: ${problem.problemPriority || 'Medium'}
Category: ${problem.category || 'Not categorized'}
Sub-Category: ${problem.subCategory || 'Not specified'}
Assigned To: ${problem.assignedTo || 'Unassigned'}
${problem.completionDate ? `Completion Date: ${formatDate(problem.completionDate)}` : 'Not completed'}

${problem.comments ? `COMMENTS:
${'-'.repeat(25)}
${problem.comments}` : ''}

END OF REPORT`;
        }
        
        function exportSingleProblemCSV() {
            if (!currentProblem) return;
            const headers = ['PID', 'Unit', 'Zone', 'Reported Date', 'Reported By', 'Reporter Email', 'Description', 'Status', 'Priority', 'Category', 'Sub-Category', 'Assigned To', 'Completion Date', 'Comments'];
            const problem = currentProblem;
            const csvData = [[getFriendlyPID(problem.internalId), problem.unitNumber || '', problem.zone || '', formatDate(problem.timestamp), problem.reportedBy || '', problem.reporterEmail || '', (problem.problemDescription || '').replace(/"/g, '""'), problem.problemStatus || '', problem.problemPriority || '', problem.category || '', problem.subCategory || '', problem.assignedTo || '', problem.completionDate ? formatDate(problem.completionDate) : '', (problem.comments || '').replace(/"/g, '""')]];
            const csv = [headers, ...csvData].map(row => row.map(field => `"${field}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `problem_${getFriendlyPID(problem.internalId).replace(' ', '_')}_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }
        
        function closeModal() {
            document.getElementById('problemModal').classList.add('hidden');
            document.getElementById('reportModal').classList.add('hidden');
        }
        
        function copyFromModal() {
            const text = document.getElementById('reportText').textContent;
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.getElementById('copyReportFromModal');
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ Copied!';
                setTimeout(() => { btn.textContent = originalText; }, 2000);
            });
        }
        
        function exportToCSV() {
            if (filteredProblems.length === 0) { alert('No problems to export'); return; }
            const headers = ['PID', 'Unit', 'Zone', 'Reported Date', 'Reported By', 'Description', 'Status', 'Priority', 'Category', 'Sub-Category', 'Assigned To', 'Comments'];
            const csvData = filteredProblems.map(problem => [getFriendlyPID(problem.internalId), problem.unitNumber || '', problem.zone || '', formatDate(problem.timestamp), problem.reportedBy || '', (problem.problemDescription || '').replace(/"/g, '""'), problem.problemStatus || '', problem.problemPriority || '', problem.category || '', problem.subCategory || '', problem.assignedTo || '', (problem.comments || '').replace(/"/g, '""')]);
            const csv = [headers, ...csvData].map(row => row.map(field => `"${field}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `problems_export_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }
        
        function selectAllUnits() { document.querySelectorAll('#unitFilters input').forEach(cb => cb.checked = true); applyFilters(); }
        function clearUnits() { document.querySelectorAll('#unitFilters input').forEach(cb => cb.checked = false); applyFilters(); }
        function selectAllStatuses() { document.querySelectorAll('#statusFilters input').forEach(cb => cb.checked = true); applyFilters(); }
        function clearStatuses() { document.querySelectorAll('#statusFilters input').forEach(cb => cb.checked = false); applyFilters(); }
        function selectAllPriorities() { document.querySelectorAll('#priorityFilters input').forEach(cb => cb.checked = true); applyFilters(); }
        function clearPriorities() { document.querySelectorAll('#priorityFilters input').forEach(cb => cb.checked = false); applyFilters(); }
        function selectAllCategories() { document.querySelectorAll('#categoryFilters input').forEach(cb => cb.checked = true); applyFilters(); }
        function clearCategories() { document.querySelectorAll('#categoryFilters input').forEach(cb => cb.checked = false); applyFilters(); }
        function selectAllZones() { document.querySelectorAll('#zoneFilters input').forEach(cb => cb.checked = true); applyFilters(); }
        function clearZones() { document.querySelectorAll('#zoneFilters input').forEach(cb => cb.checked = false); applyFilters(); }
        function selectAllAssigned() { document.querySelectorAll('#assignedToFilters input').forEach(cb => cb.checked = true); applyFilters(); }
        function clearAssigned() { document.querySelectorAll('#assignedToFilters input').forEach(cb => cb.checked = false); applyFilters(); }
        
        function showError(message) {
            document.getElementById('problemsGrid').innerHTML = `<div class="loading">‚ùå Error: ${message}</div>`;
        }
        
        async function makeRequest(action, params = {}) {
            return new Promise((resolve, reject) => {
                const callbackName = 'callback_' + Math.random().toString(36).substr(2, 9);
                const script = document.createElement('script');
                const queryParams = new URLSearchParams({ action, callback: callbackName, ...params });
                
                window[callbackName] = function(data) {
                    document.body.removeChild(script);
                    delete window[callbackName];
                    resolve(data);
                };
                
                script.onerror = () => {
                    document.body.removeChild(script);
                    delete window[callbackName];
                    reject(new Error('Network error'));
                };
                
                script.src = `${WEB_APP_URL}?${queryParams}`;
                document.body.appendChild(script);
                
                setTimeout(() => {
                    if (window[callbackName]) {
                        document.body.removeChild(script);
                        delete window[callbackName];
                        reject(new Error('Request timeout'));
                    }
                }, 10000);
            });
        }
    </script>
</body>
</html>
