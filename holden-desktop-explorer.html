<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holden Problem Data Explorer</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; line-height: 1.6; color: #334155; }
        .hidden { display: none !important; }
        .desktop-container { display: grid; grid-template-columns: 320px 1fr; grid-template-rows: auto 1fr; height: 100vh; }
        .header { grid-column: 1 / -1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px 24px; }
        .header h1 { font-size: 1.75rem; font-weight: 600; margin-bottom: 4px; }
        .header p { opacity: 0.9; font-size: 1rem; margin-bottom: 12px; }
        .header-actions { display: flex; justify-content: space-between; align-items: center; gap: 12px; }
        .dataset-toggle { background: rgba(255,255,255,0.2); border-radius: 8px; padding: 3px; display: flex; gap: 2px; }
        .dataset-btn { background: transparent; color: white; padding: 6px 12px; border: none; border-radius: 6px; font-size: 0.85rem; cursor: pointer; }
        .dataset-btn.active { background: rgba(255,255,255,0.3); font-weight: 600; }
        .access-badge { background: rgba(255,255,255,0.2); padding: 6px 16px; border-radius: 20px; font-size: 0.9rem; }
        .filters-sidebar { background: white; border-right: 1px solid #e2e8f0; padding: 20px; overflow-y: auto; }
        .sidebar-header { display: flex; align-items: center; gap: 8px; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #e2e8f0; }
        .sidebar-title { font-weight: 700; color: #1e293b; font-size: 1.1rem; }
        .filter-section { margin-bottom: 28px; }
        .filter-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .filter-label { font-weight: 600; color: #374151; font-size: 0.95rem; }
        .search-input { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.9rem; background: white; margin-bottom: 20px; }
        .checkbox-list { display: flex; flex-direction: column; gap: 8px; max-height: 200px; overflow-y: auto; padding: 4px; }
        .checkbox-item { display: flex; align-items: center; gap: 8px; padding: 6px 8px; border-radius: 6px; cursor: pointer; }
        .checkbox-item input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; }
        .checkbox-item label { flex: 1; cursor: pointer; font-size: 0.9rem; color: #374151; }
        .main-content { display: flex; flex-direction: column; overflow: hidden; }
        .stats-dashboard { padding: 20px 24px; background: white; border-bottom: 1px solid #e2e8f0; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .stat-card { background: #fafbfc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; text-align: center; }
        .stat-number { font-size: 2rem; font-weight: bold; color: #1e293b; margin-bottom: 4px; }
        .stat-label { color: #64748b; font-size: 0.9rem; font-weight: 500; margin-bottom: 4px; }
        .results-section { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .results-header { background: #f8fafc; padding: 16px 24px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .problems-container { flex: 1; overflow-y: auto; padding: 16px 24px; }
        .problem-card { background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; margin-bottom: 12px; cursor: pointer; transition: all 0.3s ease; }
        .problem-card:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
        .problem-card.legacy-card { border-left: 4px solid #8b5cf6; background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); }
        .problem-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .problem-id { font-weight: 600; color: #667eea; font-size: 1rem; }
        .problem-unit { color: #64748b; font-size: 0.9rem; }
        .badge { padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; margin-right: 6px; }
        .priority-urgent { background: #fecaca; color: #991b1b; }
        .priority-high { background: #fed7aa; color: #9a3412; }
        .priority-medium { background: #fde68a; color: #92400e; }
        .priority-low { background: #d1fae5; color: #065f46; }
        .status-completed { background: #d1fae5; color: #065f46; }
        .problem-description { color: #374151; font-size: 0.9rem; margin-bottom: 8px; }
        .problem-footer { display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: #64748b; }
        .detail-section { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; overflow: hidden; }
        .section-title-bar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; font-weight: 600; font-size: 16px; }
        .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 20px; }
        .detail-field { display: flex; flex-direction: column; gap: 6px; }
        .detail-field.full-width { grid-column: 1 / -1; }
        .detail-field label { font-weight: 600; color: #374151; font-size: 14px; }
        .detail-field span { padding: 10px 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 6px; color: #6b7280; font-size: 14px; min-height: 38px; display: flex; align-items: center; }
        .contact-group { background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 15px; }
        .contact-group h4 { margin-bottom: 15px; color: #1f2937; font-size: 16px; font-weight: 600; }
        .contact-group .detail-grid { padding: 0; grid-template-columns: 1fr; gap: 12px; }
        .contact-link { color: #2563eb; text-decoration: none; }
        .contact-link:hover { color: #1d4ed8; text-decoration: underline; }
        .back-btn { background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; transition: background-color 0.3s ease; }
        .back-btn:hover { background: #4b5563; }
        .report-btn { background: #2563eb; color: white; padding: 8px 16px; border: none; border-radius: 6px; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 6px; }
        .report-btn.green { background: #10b981; }
        .loading { display: flex; align-items: center; justify-content: center; padding: 60px; color: #64748b; }
        .empty-state { text-align: center; padding: 60px 20px; color: #64748b; }
    </style>
</head>
<body>
    <div class="desktop-container" id="desktopContainer">
        <div class="header">
            <h1>üìä Problem Data Explorer</h1>
            <p>Desktop Analytics & Multi-Field Filtering</p>
            <div class="header-actions">
                <div class="dataset-toggle">
                    <button class="dataset-btn active" id="currentBtn">üìä Current Data</button>
                    <button class="dataset-btn" id="legacyBtn">üìö Legacy Data</button>
                </div>
                <div class="access-badge">Live Data</div>
            </div>
        </div>
        <div class="filters-sidebar">
            <div class="sidebar-header">
                <span class="sidebar-title">üéõÔ∏è Data Slicers</span>
            </div>
            <input type="text" id="searchInput" class="search-input" placeholder="üîç Search PID, unit, description...">
            <div class="filter-section">
                <div class="filter-header"><div class="filter-label">üè† Units</div></div>
                <div style="display: flex; gap: 4px; margin-bottom: 8px;">
                    <button onclick="selectAllUnits()" style="background: #f8fafc; border: 1px solid #e2e8f0; padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">All</button>
                    <button onclick="clearUnits()" style="background: #f8fafc; border: 1px solid #e2e8f0; padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">Clear</button>
                </div>
                <div class="checkbox-list" id="unitFilters"></div>
            </div>
            <div class="filter-section">
                <div class="filter-header"><div class="filter-label">üìã Status</div></div>
                <div style="display: flex; gap: 4px; margin-bottom: 8px;">
                    <button onclick="selectAllStatuses()" style="background: #f8fafc; border: 1px solid #e2e8f0; padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">All</button>
                    <button onclick="clearStatuses()" style="background: #f8fafc; border: 1px solid #e2e8f0; padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">Clear</button>
                </div>
                <div class="checkbox-list" id="statusFilters"></div>
            </div>
            <div class="filter-section">
                <div class="filter-header"><div class="filter-label">‚ö° Priority</div></div>
                <div style="display: flex; gap: 4px; margin-bottom: 8px;">
                    <button onclick="selectAllPriorities()" style="background: #f8fafc; border: 1px solid #e2e8f0; padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">All</button>
                    <button onclick="clearPriorities()" style="background: #f8fafc; border: 1px solid #e2e8f0; padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">Clear</button>
                </div>
                <div class="checkbox-list" id="priorityFilters"></div>
            </div>
            <div class="filter-section">
                <div class="filter-header"><div class="filter-label">üè∑Ô∏è Categories</div></div>
                <div style="display: flex; gap: 4px; margin-bottom: 8px;">
                    <button onclick="selectAllCategories()" style="background: #f8fafc; border: 1px solid #e2e8f0; padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">All</button>
                    <button onclick="clearCategories()" style="background: #f8fafc; border: 1px solid #e2e8f0; padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">Clear</button>
                </div>
                <div class="checkbox-list" id="categoryFilters"></div>
            </div>
            <div class="filter-section">
                <div class="filter-header"><div class="filter-label">üè™ Sub-Categories</div></div>
                <div style="display: flex; gap: 4px; margin-bottom: 8px;">
                    <button onclick="selectAllSubCategories()" style="background: #f8fafc; border: 1px solid #e2e8f0; padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">All</button>
                    <button onclick="clearSubCategories()" style="background: #f8fafc; border: 1px solid #e2e8f0; padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">Clear</button>
                </div>
                <div class="checkbox-list" id="subCategoryFilters"></div>
            </div>
            <div class="filter-section">
                <div class="filter-header"><div class="filter-label">üèòÔ∏è Zones</div></div>
                <div style="display: flex; gap: 4px; margin-bottom: 8px;">
                    <button onclick="selectAllZones()" style="background: #f8fafc; border: 1px solid #e2e8f0; padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">All</button>
                    <button onclick="clearZones()" style="background: #f8fafc; border: 1px solid #e2e8f0; padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">Clear</button>
                </div>
                <div class="checkbox-list" id="zoneFilters"></div>
            </div>
            <div class="filter-section">
                <div class="filter-header"><div class="filter-label">üë§ Assigned To</div></div>
                <div style="display: flex; gap: 4px; margin-bottom: 8px;">
                    <button onclick="selectAllAssigned()" style="background: #f8fafc; border: 1px solid #e2e8f0; padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">All</button>
                    <button onclick="clearAssigned()" style="background: #f8fafc; border: 1px solid #e2e8f0; padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">Clear</button>
                </div>
                <div class="checkbox-list" id="assignedFilters"></div>
            </div>
            <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid #e2e8f0; display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <button onclick="showAllProblems()" style="background: #10b981; color: white; border: none; padding: 10px; border-radius: 8px; font-weight: 600; font-size: 0.85rem; cursor: pointer;">‚úÖ Show All</button>
                <button onclick="clearAllFilters()" style="background: #dc2626; color: white; border: none; padding: 10px; border-radius: 8px; font-weight: 600; font-size: 0.85rem; cursor: pointer;">üóëÔ∏è Clear All</button>
            </div>
        </div>
        <div class="main-content">
            <div class="stats-dashboard">
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-number" id="totalProblems">-</div><div class="stat-label">Total Problems</div></div>
                    <div class="stat-card"><div class="stat-number" id="activeProblems">-</div><div class="stat-label">Active</div></div>
                    <div class="stat-card"><div class="stat-number" id="urgentCount">-</div><div class="stat-label">Urgent</div></div>
                    <div class="stat-card"><div class="stat-number" id="avgResolution">-</div><div class="stat-label">Avg Days</div></div>
                </div>
            </div>
            <div class="results-section">
                <div class="results-header">
                    <div class="results-title">Problem Details</div>
                    <div class="results-count" id="resultsCount">Loading...</div>
                </div>
                <div class="problems-container" id="problemsContainer">
                    <div class="loading">Loading problem data...</div>
                </div>
            </div>
        </div>
    </div>
    <div id="problemDetailsView" class="hidden" style="background: #f8fafc; min-height: 100vh;">
        <div class="header">
            <h1>üìã Problem Details</h1>
            <p>Complete Problem Information</p>
            <div class="header-actions">
                <button id="backToList" class="back-btn">‚Üê Back to List</button>
            </div>
        </div>
        <div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
            <div style="background: white; border-radius: 12px; margin-bottom: 20px; padding: 15px 20px; display: flex; gap: 10px;">
                <button id="viewProblemReport" class="report-btn">üìÑ View Report</button>
                <button id="copyProblemReport" class="report-btn green">üìã Copy Report</button>
            </div>
            <div class="detail-section">
                <div class="section-title-bar">üìã Problem Details</div>
                <div class="detail-grid">
                    <div class="detail-field"><label>Problem ID</label><span id="detailProblemId">-</span></div>
                    <div class="detail-field"><label>Unit Number</label><span id="detailUnitNumber">-</span></div>
                    <div class="detail-field"><label>Reported Date</label><span id="detailReportedDate">-</span></div>
                    <div class="detail-field"><label>Zone</label><span id="detailZone">-</span></div>
                    <div class="detail-field full-width"><label>Problem Description</label><span id="detailDescription">-</span></div>
                </div>
            </div>
            <div class="detail-section">
                <div class="section-title-bar">üîß Management Details</div>
                <div class="detail-grid">
                    <div class="detail-field"><label>Status</label><span id="detailStatus">-</span></div>
                    <div class="detail-field"><label>Priority</label><span id="detailPriority">-</span></div>
                    <div class="detail-field"><label>Category</label><span id="detailCategory">-</span></div>
                    <div class="detail-field"><label>Sub-Category</label><span id="detailSubCategory">-</span></div>
                    <div class="detail-field"><label>Assigned To</label><span id="detailAssignedTo">-</span></div>
                    <div class="detail-field"><label>Completion Date</label><span id="detailCompletionDate">-</span></div>
                    <div class="detail-field full-width"><label>Comments</label><span id="detailComments">-</span></div>
                </div>
            </div>
            <div class="detail-section">
                <div class="section-title-bar">üë• Contact Details</div>
                <div id="contactDetailsContent" class="detail-grid"></div>
            </div>
        </div>
    </div>
    <div id="reportModal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
        <div style="background: white; border-radius: 12px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div style="padding: 25px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="font-size: 20px; font-weight: 600; color: #1f2937;">üìÑ Problem Report</h3>
                <button id="closeReportModal" style="background: none; border: none; font-size: 24px; cursor: pointer;">√ó</button>
            </div>
            <div style="padding: 25px;">
                <pre id="reportText" style="white-space: pre-wrap; font-family: monospace; font-size: 12px; background: #f8f9fa; padding: 20px; border-radius: 6px; max-height: 60vh; overflow-y: auto;"></pre>
                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button id="copyReportFromModal" class="report-btn green">üìã Copy to Clipboard</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzEWNgrtuamJxLUEo_dWCm9-WxoD-zDejn6LKwV3Vt8yCHv0CArlBVtzj1ad_JM0A6N/exec';
        let allProblems = [], filteredProblems = [], currentProblem = null, currentDataset = 'current';
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üñ•Ô∏è Problem Data Explorer - Starting...');
            document.getElementById('currentBtn').addEventListener('click', () => switchDataset('current'));
            document.getElementById('legacyBtn').addEventListener('click', () => switchDataset('legacy'));
            document.getElementById('searchInput').addEventListener('input', () => setTimeout(applyFilters, 300));
            document.getElementById('backToList').addEventListener('click', showMainView);
            document.getElementById('viewProblemReport').addEventListener('click', showReport);
            document.getElementById('copyProblemReport').addEventListener('click', copyReport);
            document.getElementById('closeReportModal').addEventListener('click', closeModal);
            document.getElementById('copyReportFromModal').addEventListener('click', copyFromModal);
            document.getElementById('reportModal').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeModal(); });
            loadProblemsData();
        });
        
        async function switchDataset(dataset) {
            console.log(\`üîÑ Switching to \${dataset} dataset...\`);
            currentDataset = dataset;
            document.getElementById('currentBtn').classList.toggle('active', dataset === 'current');
            document.getElementById('legacyBtn').classList.toggle('active', dataset === 'legacy');
            document.querySelector('.access-badge').textContent = dataset === 'current' ? 'Live Data' : 'Legacy Data';
            if (dataset === 'current') { await loadProblemsData(); } else { await loadLegacyData(); }
        }
        
        async function loadLegacyData() {
            try {
                console.log('üìö Loading legacy data...');
                const response = await makeRequest('getLegacyLogData');
                if (response && response.success) {
                    allProblems = response.data || [];
                    console.log('Loaded', allProblems.length, 'legacy problems');
                    buildFilters(); applyFilters();
                } else { throw new Error('Failed to load legacy data'); }
            } catch (error) {
                console.error('Error loading legacy data:', error);
                showError('Failed to load legacy data');
            }
        }
        
        async function loadProblemsData() {
            try {
                console.log('Loading current data...');
                const response = await makeRequest('getFaultLogData');
                if (response && response.success) {
                    allProblems = response.data || [];
                    console.log('Loaded', allProblems.length, 'problems');
                    buildFilters(); applyFilters();
                } else { throw new Error('Failed to load data'); }
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Failed to load data');
            }
        }
        
        function buildFilters() {
            const units = [...new Set(allProblems.map(p => String(p.unitNumber || '')).filter(Boolean))].sort((a, b) => {
                const numA = parseInt(a.replace(/\\D/g, '') || '0') || 0, numB = parseInt(b.replace(/\\D/g, '') || '0') || 0;
                return numA - numB;
            });
            buildCheckboxSection('unitFilters', units, 'unit');
            const statuses = [...new Set(allProblems.map(p => String(p.problemStatus || '')).filter(Boolean))].sort();
            buildCheckboxSection('statusFilters', statuses, 'status');
            const priorities = ['Urgent', 'High', 'Medium', 'Low'];
            buildCheckboxSection('priorityFilters', priorities, 'priority');
            const categories = [...new Set(allProblems.map(p => String(p.category || '')).filter(Boolean))].sort();
            buildCheckboxSection('categoryFilters', categories, 'category');
            const subCategories = [...new Set(allProblems.map(p => String(p.subCategory || '')).filter(Boolean))].sort();
            buildCheckboxSection('subCategoryFilters', subCategories, 'subCategory');
            const zones = [...new Set(allProblems.map(p => String(p.zone || '')).filter(Boolean))].sort();
            buildCheckboxSection('zoneFilters', zones, 'zone');
            const assignedTo = [...new Set(allProblems.map(p => String(p.assignedTo || '')).filter(Boolean))].sort();
            buildCheckboxSection('assignedFilters', assignedTo, 'assignedTo');
        }
        
        function buildCheckboxSection(containerId, options, fieldName) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = options.map(option => {
                const count = allProblems.filter(p => getFieldValue(p, fieldName) === option).length;
                return \`<div class="checkbox-item"><input type="checkbox" id="\${fieldName}_\${option}" value="\${option}" checked onchange="applyFilters();"><label for="\${fieldName}_\${option}">\${option}</label><span style="font-size: 0.7rem; color: #64748b;">\${count}</span></div>\`;
            }).join('');
        }
        
        function getFieldValue(problem, fieldName) {
            switch (fieldName) {
                case 'unit': return String(problem.unitNumber || '');
                case 'status': return String(problem.problemStatus || '');
                case 'priority': return String(problem.problemPriority || '');
                case 'category': return String(problem.category || '');
                case 'subCategory': return String(problem.subCategory || '');
                case 'zone': return String(problem.zone || '');
                case 'assignedTo': return String(problem.assignedTo || '');
                default: return '';
            }
        }
        
        function applyFilters() {
            let filtered = [...allProblems];
            ['unit', 'status', 'priority', 'category', 'subCategory', 'zone', 'assignedTo'].forEach(filterType => {
                const checked = Array.from(document.querySelectorAll(\`#\${filterType}Filters input:checked\`)).map(cb => cb.value);
                const all = Array.from(document.querySelectorAll(\`#\${filterType}Filters input\`)).map(cb => cb.value);
                if (checked.length < all.length && checked.length > 0) {
                    filtered = filtered.filter(p => checked.includes(getFieldValue(p, filterType)));
                }
            });
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            if (searchTerm) {
                filtered = filtered.filter(problem => {
                    const searchText = [getFriendlyPID(problem.internalId), problem.unitNumber, problem.problemDescription, problem.reportedBy].filter(Boolean).join(' ').toLowerCase();
                    return searchText.includes(searchTerm);
                });
            }
            filtered.sort((a, b) => parseDate(b.timestamp) - parseDate(a.timestamp));
            filteredProblems = filtered;
            updateStats();
            updateResults();
        }
        
        function parseDate(dateString) {
            if (!dateString) return 0;
            try {
                if (dateString instanceof Date) return dateString.getTime();
                if (typeof dateString === 'string' && dateString.includes('/')) {
                    const parts = dateString.trim().split('/');
                    if (parts.length === 3) {
                        const day = parseInt(parts[0]), month = parseInt(parts[1]) - 1, year = parseInt(parts[2]);
                        if (day >= 1 && day <= 31 && month >= 0 && month <= 11 && year >= 1900) {
                            return new Date(year, month, day).getTime();
                        }
                    }
                }
                return new Date(dateString).getTime();
            } catch (error) { return 0; }
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'No Date';
            try {
                let date;
                if (dateString instanceof Date) {
                    date = dateString;
                } else if (typeof dateString === 'string' && dateString.includes('/')) {
                    const parts = dateString.trim().split('/');
                    if (parts.length === 3) {
                        const day = parseInt(parts[0]), month = parseInt(parts[1]) - 1, year = parseInt(parts[2]);
                        if (day >= 1 && day <= 31 && month >= 0 && month <= 11 && year >= 1900) {
                            date = new Date(year, month, day);
                        } else { return 'Invalid Date'; }
                    }
                } else { date = new Date(dateString); }
                return isNaN(date.getTime()) ? 'Invalid Date' : date.toLocaleDateString('en-AU', { day: '2-digit', month: '2-digit', year: 'numeric' });
            } catch (error) { return 'Invalid Date'; }
        }
        
        function updateStats() {
            const total = filteredProblems.length;
            const active = filteredProblems.filter(p => p.problemStatus !== 'Completed' && p.problemStatus !== 'Cancelled').length;
            const urgent = filteredProblems.filter(p => p.problemPriority === 'Urgent').length;
            document.getElementById('totalProblems').textContent = total;
            document.getElementById('activeProblems').textContent = active;
            document.getElementById('urgentCount').textContent = urgent;
            document.getElementById('avgResolution').textContent = 'N/A';
        }
        
        function updateResults() {
            const label = currentDataset === 'current' ? 'problems' : 'legacy problems';
            document.getElementById('resultsCount').textContent = \`\${filteredProblems.length} \${label}\`;
            const container = document.getElementById('problemsContainer');
            if (filteredProblems.length === 0) {
                container.innerHTML = \`<div class="empty-state">No \${label} match your filters</div>\`;
                return;
            }
            container.innerHTML = filteredProblems.map(problem => {
                const friendlyPID = getFriendlyPID(problem.internalId);
                const reportedDate = formatDate(problem.timestamp);
                const priority = problem.problemPriority || 'Medium';
                const status = problem.problemStatus || 'Reported';
                const cardClass = currentDataset === 'legacy' ? 'problem-card legacy-card' : 'problem-card';
                const pidPrefix = currentDataset === 'legacy' ? 'üìö ' : '';
                return \`<div class="\${cardClass}" onclick="openProblemDetails('\${problem.internalId}')">
                    <div class="problem-header">
                        <div><div class="problem-id">\${pidPrefix}\${friendlyPID}</div><div class="problem-unit">\${problem.unitNumber} ‚Ä¢ \${problem.zone || 'No Zone'}</div></div>
                        <div><span class="badge priority-\${priority.toLowerCase()}">\${priority}</span><span class="badge status-\${status.toLowerCase().replace(/\\s+/g, '')}">\${status}</span></div>
                    </div>
                    <div class="problem-description">\${(problem.problemDescription || 'No description').substring(0, 120)}\${(problem.problemDescription || '').length > 120 ? '...' : ''}</div>
                    <div class="problem-footer"><div>\${reportedDate}</div><div>\${problem.category || 'No Category'}</div></div>
                </div>\`;
            }).join('');
        }
        
        function openProblemDetails(internalId) {
            currentProblem = allProblems.find(p => p.internalId === internalId);
            if (!currentProblem) return;
            const friendlyPID = getFriendlyPID(currentProblem.internalId);
            document.getElementById('detailProblemId').textContent = friendlyPID;
            document.getElementById('detailUnitNumber').textContent = currentProblem.unitNumber || 'Unknown';
            document.getElementById('detailReportedDate').textContent = formatDate(currentProblem.timestamp);
            document.getElementById('detailZone').textContent = currentProblem.zone || 'Unknown';
            document.getElementById('detailDescription').textContent = currentProblem.problemDescription || 'No description available';
            document.getElementById('detailStatus').textContent = currentProblem.problemStatus || 'Not assigned';
            document.getElementById('detailPriority').textContent = currentProblem.problemPriority || 'Not assigned';
            document.getElementById('detailCategory').textContent = currentProblem.category || 'Not assigned';
            document.getElementById('detailSubCategory').textContent = currentProblem.subCategory || 'Not assigned';
            document.getElementById('detailAssignedTo').textContent = currentProblem.assignedTo || 'Not assigned';
            document.getElementById('detailCompletionDate').textContent = currentProblem.completionDate ? formatDate(currentProblem.completionDate) : 'Not completed';
            document.getElementById('detailComments').textContent = currentProblem.comments || 'No comments';
            populateContactDetails(currentProblem);
            document.getElementById('desktopContainer').style.display = 'none';
            document.getElementById('problemDetailsView').style.display = 'block';
            document.getElementById('problemDetailsView').classList.remove('hidden');
        }
        
        function populateContactDetails(problem) {
            const container = document.getElementById('contactDetailsContent');
            let contactHTML = \`<div class="contact-group"><h4>üè† Unit Primary Contact</h4><div class="detail-grid">
                <div class="detail-field"><label>Name</label><span>\${problem.unitPrimaryName || 'Not available'}</span></div>
                <div class="detail-field"><label>Email</label><span>\${problem.unitPrimaryEmail ? \`<a href="mailto:\${problem.unitPrimaryEmail}" class="contact-link">\${problem.unitPrimaryEmail}</a>\` : 'Not available'}</span></div>
                <div class="detail-field"><label>Phone</label><span>\${problem.unitPrimaryPhone ? \`<a href="tel:\${problem.unitPrimaryPhone.replace(/\\s/g, '')}" class="contact-link">\${problem.unitPrimaryPhone}</a>\` : 'Not available'}</span></div>
            </div></div>\`;
            const reporterName = problem.reportedBy || '', unitPrimaryName = problem.unitPrimaryName || '';
            const reporterEmail = problem.reporterEmail || '', unitPrimaryEmail = problem.unitPrimaryEmail || '';
            const reporterIsDifferent = (reporterName && unitPrimaryName && reporterName.toLowerCase() !== unitPrimaryName.toLowerCase()) || (reporterEmail && unitPrimaryEmail && reporterEmail.toLowerCase() !== unitPrimaryEmail.toLowerCase());
            if (reporterIsDifferent) {
                contactHTML += \`<div class="contact-group"><h4>üìù Reporter Contact</h4><div class="detail-grid">
                    <div class="detail-field"><label>Reported By</label><span>\${problem.reportedBy || 'Unknown'}</span></div>
                    <div class="detail-field"><label>Reporter Email</label><span>\${problem.reporterEmail ? \`<a href="mailto:\${problem.reporterEmail}" class="contact-link">\${problem.reporterEmail}</a>\` : 'Not available'}</span></div>
                    <div class="detail-field"><label>Reporter Phone</label><span>\${problem.reporterPhone ? \`<a href="tel:\${problem.reporterPhone.replace(/\\s/g, '')}" class="contact-link">\${problem.reporterPhone}</a>\` : 'Not available'}</span></div>
                </div></div>\`;
            }
            contactHTML += \`<div class="contact-group"><h4>‚ÑπÔ∏è Additional Information</h4><div class="detail-grid">
                <div class="detail-field"><label>Last Updated</label><span>\${problem.lastUpdated ? formatDate(problem.lastUpdated) : 'Not available'}</span></div>
                <div class="detail-field"><label>Reported By</label><span>\${problem.reportedBy || 'Unknown'}</span></div>
            </div></div>\`;
            container.innerHTML = contactHTML;
        }
        
        function showMainView() {
            document.getElementById('problemDetailsView').style.display = 'none';
            document.getElementById('problemDetailsView').classList.add('hidden');
            document.getElementById('desktopContainer').style.display = 'grid';
        }
        
        function showReport() {
            if (currentProblem) {
                const report = generateProblemReport(currentProblem);
                document.getElementById('reportText').textContent = report;
                document.getElementById('reportModal').classList.remove('hidden');
            }
        }
        
        function copyReport() {
            if (currentProblem) {
                const report = generateProblemReport(currentProblem);
                navigator.clipboard.writeText(report).then(() => alert('Report copied to clipboard!'));
            }
        }
        
        function closeModal() { document.getElementById('reportModal').classList.add('hidden'); }
        
        function copyFromModal() {
            if (currentProblem) {
                const report = generateProblemReport(currentProblem);
                navigator.clipboard.writeText(report).then(() => { alert('Report copied to clipboard!'); closeModal(); });
            }
        }
        
        function generateProblemReport(problem) {
            const friendlyPID = getFriendlyPID(problem.internalId);
            const reportedDate = formatDate(problem.timestamp);
            const completionDate = problem.completionDate ? formatDate(problem.completionDate) : 'Not completed';
            let report = 'MAINTENANCE PORTAL - PROBLEM REPORT\\n' + '='.repeat(60) + '\\n';
            report += \`Generated: \${new Date().toLocaleString('en-AU')}\\nProblem ID: \${friendlyPID}\\nUnit: \${problem.unitNumber || 'Unknown'}\\n\` + '='.repeat(60) + '\\n\\n';
            report += 'PROBLEM DETAILS:\\n' + '-'.repeat(30) + '\\n';
            report += \`Problem ID: \${friendlyPID}\\nUnit Number: \${problem.unitNumber || 'Unknown'}\\nZone: \${problem.zone || 'Unknown'}\\nReported Date: \${reportedDate}\\nDescription: \${problem.problemDescription || 'No description'}\\n\\n\`;
            report += 'MANAGEMENT DETAILS:\\n' + '-'.repeat(30) + '\\n';
            report += \`Status: \${problem.problemStatus || 'Unknown'}\\nPriority: \${problem.problemPriority || 'Unknown'}\\nCategory: \${problem.category || 'Not assigned'}\\nSub-Category: \${problem.subCategory || 'Not assigned'}\\nAssigned To: \${problem.assignedTo || 'Not assigned'}\\nCompletion Date: \${completionDate}\\nComments: \${problem.comments || 'No comments'}\\n\\n\`;
            report += 'CONTACT DETAILS:\\n' + '-'.repeat(30) + '\\n';
            report += \`Unit Primary Name: \${problem.unitPrimaryName || 'Not available'}\\nUnit Primary Email: \${problem.unitPrimaryEmail || 'Not available'}\\nUnit Primary Phone: \${problem.unitPrimaryPhone || 'Not available'}\\nReported By: \${problem.reportedBy || 'Unknown'}\\nReporter Email: \${problem.reporterEmail || 'Not available'}\\nReporter Phone: \${problem.reporterPhone || 'Not available'}\\n\\n\`;
            report += '='.repeat(60) + '\\nGenerated by Lake Illawong Maintenance Portal\\n';
            return report;
        }
        
        function selectAllUnits() { document.querySelectorAll('#unitFilters input[type="checkbox"]').forEach(cb => cb.checked = true); applyFilters(); }
        function clearUnits() { document.querySelectorAll('#unitFilters input[type="checkbox"]').forEach(cb => cb.checked = false); applyFilters(); }
        function selectAllStatuses() { document.querySelectorAll('#statusFilters input[type="checkbox"]').forEach(cb => cb.checked = true); applyFilters(); }
        function clearStatuses() { document.querySelectorAll('#statusFilters input[type="checkbox"]').forEach(cb => cb.checked = false); applyFilters(); }
        function selectAllPriorities() { document.querySelectorAll('#priorityFilters input[type="checkbox"]').forEach(cb => cb.checked = true); applyFilters(); }
        function clearPriorities() { document.querySelectorAll('#priorityFilters input[type="checkbox"]').forEach(cb => cb.checked = false); applyFilters(); }
        function selectAllCategories() { document.querySelectorAll('#categoryFilters input[type="checkbox"]').forEach(cb => cb.checked = true); applyFilters(); }
        function clearCategories() { document.querySelectorAll('#categoryFilters input[type="checkbox"]').forEach(cb => cb.checked = false); applyFilters(); }
        function selectAllSubCategories() { document.querySelectorAll('#subCategoryFilters input[type="checkbox"]').forEach(cb => cb.checked = true); applyFilters(); }
        function clearSubCategories() { document.querySelectorAll('#subCategoryFilters input[type="checkbox"]').forEach(cb => cb.checked = false); applyFilters(); }
        function selectAllZones() { document.querySelectorAll('#zoneFilters input[type="checkbox"]').forEach(cb => cb.checked = true); applyFilters(); }
        function clearZones() { document.querySelectorAll('#zoneFilters input[type="checkbox"]').forEach(cb => cb.checked = false); applyFilters(); }
        function selectAllAssigned() { document.querySelectorAll('#assignedFilters input[type="checkbox"]').forEach(cb => cb.checked = true); applyFilters(); }
        function clearAssigned() { document.querySelectorAll('#assignedFilters input[type="checkbox"]').forEach(cb => cb.checked = false); applyFilters(); }
        function clearAllFilters() { document.getElementById('searchInput').value = ''; document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false); applyFilters(); }
        function showAllProblems() { document.getElementById('searchInput').value = ''; document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true); applyFilters(); }
        
        function showError(message) { document.getElementById('problemsContainer').innerHTML = \`<div class="empty-state">‚ùå \${message}</div>\`; }
        function getFriendlyPID(internalId) { if (!internalId) return 'PID Unknown'; const parts = internalId.split('-'); return parts.length === 2 ? \`PID \${parts[1]}\` : \`PID \${internalId}\`; }
        
        async function makeRequest(action, additionalData = {}) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                const script = document.createElement('script');
                const params = new URLSearchParams({ action: action, callback: callbackName, ...additionalData });
                script.src = \`\${WEB_APP_URL}?\${params.toString()}\`;
                window[callbackName] = function(response) { document.head.removeChild(script); delete window[callbackName]; resolve(response); };
                script.onerror = function() { document.head.removeChild(script); delete window[callbackName]; reject(new Error('Network request failed')); };
                setTimeout(() => { if (window[callbackName]) { document.head.removeChild(script); delete window[callbackName]; reject(new Error('Request timeout')); } }, 10000);
                document.head.appendChild(script);
            });
        }
        
        console.log('üñ•Ô∏è Problem Data Explorer - Ready!');
    </script>
</body>
</html>
