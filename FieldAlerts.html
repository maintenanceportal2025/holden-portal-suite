<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Field Alerts - Lake Illawong</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f7fa;
            padding: 10px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #dc2626, #991b1b);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 15px;
        }

        .template-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .template-card {
            background: #f8fafc;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .template-card:hover {
            border-color: #059669;
            transform: translateY(-2px);
        }

        .template-card.selected {
            border-color: #059669;
            background: #ecfdf5;
        }

        .template-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 5px;
            font-size: 1.1rem;
        }

        .template-category {
            background: #fee2e2;
            color: #dc2626;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-bottom: 8px;
            display: inline-block;
        }

        .template-category.restoration {
            background: #dcfce7;
            color: #059669;
        }

        .template-category.maintenance {
            background: #fef3c7;
            color: #d97706;
        }

        .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 10px;
        }

        .btn-primary {
            background: #059669;
            color: white;
        }

        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .preview-panel {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }

        .preview-content {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }

        .preview-subject {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e5e7eb;
        }

        .preview-body {
            color: #374151;
            line-height: 1.6;
            white-space: pre-line;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            left: 20px;
            padding: 15px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateY(-100px);
            transition: transform 0.3s;
        }

        .notification.show {
            transform: translateY(0);
        }

        .notification.success {
            background: #059669;
        }

        .notification.error {
            background: #dc2626;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>🚨 Mobile Field Alerts</h1>
            <p>Emergency communications for maintenance team</p>
        </div>

        <!-- Template Selection -->
        <div class="card">
            <h2 class="card-title">Select Emergency Alert</h2>
            
            <div class="template-grid" id="templateGrid">
                <div class="template-card" onclick="selectTemplate('WATER02')">
                    <div class="template-category">Emergency</div>
                    <div class="template-title">🚰 Water Emergency</div>
                    <div>Immediate water service shutdown</div>
                </div>
                
                <div class="template-card" onclick="selectTemplate('WATER03')">
                    <div class="template-category restoration">Restoration</div>
                    <div class="template-title">✅ Water Restored</div>
                    <div>Water service back to normal</div>
                </div>
                
                <div class="template-card" onclick="selectTemplate('POWER02')">
                    <div class="template-category">Emergency</div>
                    <div class="template-title">⚡ Power Emergency</div>
                    <div>Immediate power outage alert</div>
                </div>
                
                <div class="template-card" onclick="selectTemplate('POWER03')">
                    <div class="template-category restoration">Restoration</div>
                    <div class="template-title">✅ Power Restored</div>
                    <div>Power service back to normal</div>
                </div>
                
                <div class="template-card" onclick="selectTemplate('MAINT01')">
                    <div class="template-category maintenance">Maintenance</div>
                    <div class="template-title">🔧 Maintenance Work</div>
                    <div>Active work affecting access</div>
                </div>
                
                <div class="template-card" onclick="selectTemplate('COMM01')">
                    <div class="template-category maintenance">Notice</div>
                    <div class="template-title">📢 Urgent Notice</div>
                    <div>Important community alert</div>
                </div>
            </div>

            <select class="form-select" id="recipientFilter">
                <option value="all_units">All Units (44 units)</option>
                <option value="zone_1">Zone 1 Only</option>
                <option value="zone_2">Zone 2 Only</option>
                <option value="zone_3">Zone 3 Only</option>
                <option value="zone_4">Zone 4 Only</option>
                <option value="zone_5">Zone 5 Only</option>
            </select>
        </div>

        <!-- Preview -->
        <div class="card">
            <h2 class="card-title">Preview & Send</h2>
            
            <div class="preview-panel" id="previewPanel">
                <div class="preview-content">
                    <div class="preview-subject" id="previewSubject"></div>
                    <div class="preview-body" id="previewBody"></div>
                </div>
            </div>

            <button class="btn btn-primary" id="sendEmailBtn" onclick="sendMassNotification()" disabled>
                <span id="sendButtonText">📧 Send Alert</span>
            </button>
        </div>
    </div>

    <script>
        // EXACT SAME EMAIL SERVICE AS DESKTOP
        const EMAIL_SERVICE_URL = 'https://script.google.com/macros/s/AKfycbwwSy44WvoHQIKiUn9Ctf0rHyYCuLPNFBrlSVSexks7rVnRvdVQeZC9F3Zwu2RruX3v/exec';
        
        // Mobile templates (subset of desktop templates)
        const mobileTemplates = {
            'WATER02': {
                templateId: 'WATER02',
                subject: 'URGENT: Water Service Emergency',
                body: 'Emergency water service shutdown in progress. Water supply will be interrupted immediately. We will update you as soon as service is restored. Apologize for any inconvenience.',
                category: 'Emergency'
            },
            'WATER03': {
                templateId: 'WATER03', 
                subject: 'Water Service Restored',
                body: 'Water service has been restored to normal operation. Thank you for your patience during the emergency maintenance.',
                category: 'Restoration'
            },
            'POWER02': {
                templateId: 'POWER02',
                subject: 'URGENT: Power Outage Alert', 
                body: 'Emergency power outage affecting the complex. Electrical supply has been interrupted. We are working to restore power as quickly as possible.',
                category: 'Emergency'
            },
            'POWER03': {
                templateId: 'POWER03',
                subject: 'Power Service Restored',
                body: 'Electrical power has been restored to normal operation. Thank you for your patience during the outage.',
                category: 'Restoration'
            },
            'MAINT01': {
                templateId: 'MAINT01',
                subject: 'Maintenance Work in Progress',
                body: 'Active maintenance work is currently affecting property access. Please use alternate routes and exercise caution in work areas.',
                category: 'Maintenance'
            },
            'COMM01': {
                templateId: 'COMM01',
                subject: 'Urgent Community Notice',
                body: 'Important community alert requiring immediate attention. Please take note of the following information and act accordingly.',
                category: 'Notice'
            }
        };

        let selectedTemplate = null;

        // EXACT SAME FUNCTIONS AS DESKTOP (simplified)
        function selectTemplate(templateId) {
            // Remove previous selection
            document.querySelectorAll('.template-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Select new template
            selectedTemplate = mobileTemplates[templateId];
            
            if (selectedTemplate) {
                // Visual selection
                event.target.closest('.template-card').classList.add('selected');
                
                // Update preview
                updatePreview();
                
                // Enable send button
                document.getElementById('sendEmailBtn').disabled = false;
            }
        }

        function updatePreview() {
            if (!selectedTemplate) {
                document.getElementById('previewPanel').style.display = 'none';
                return;
            }
            
            // Generate preview content (same as desktop)
            let subject = selectedTemplate.subject;
            let body = selectedTemplate.body;
            
            // Replace common variables
            const today = new Date().toLocaleDateString('en-AU');
            const time = new Date().toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' });
            
            subject = subject.replace(/{DATE}/g, today);
            body = body.replace(/{DATE}/g, today);
            body = body.replace(/{TIME}/g, time);
            
            // Update preview
            document.getElementById('previewSubject').textContent = subject;
            document.getElementById('previewBody').textContent = body;
            document.getElementById('previewPanel').style.display = 'block';
        }

        // EXACT SAME SEND FUNCTION AS DESKTOP
        async function sendMassNotification() {
            if (!selectedTemplate) {
                showError('Please select a template first');
                return;
            }
            
            try {
                // Show loading state
                showSendingState(true);
                
                const recipientFilter = document.getElementById('recipientFilter').value;
                
                // EXACT SAME CALL AS DESKTOP
                const response = await makeServiceRequest('sendMassNotification', {
                    templateId: selectedTemplate.templateId,
                    recipientFilter: recipientFilter,
                    customData: JSON.stringify({}),
                    adminUser: 'MobileFieldAlerts'
                });
                
                if (response.success) {
                    showSuccess(`✅ Alert sent successfully to ${getZoneName(recipientFilter)}!`);
                    
                    // Reset form
                    setTimeout(() => {
                        resetForm();
                    }, 3000);
                } else {
                    throw new Error(response.error || 'Failed to send alert');
                }
                
            } catch (error) {
                console.error('❌ Error sending alert:', error);
                showError('Failed to send alert: ' + error.message);
            } finally {
                showSendingState(false);
            }
        }

        function getZoneName(filter) {
            const names = {
                'all_units': 'all units',
                'zone_1': 'Zone 1',
                'zone_2': 'Zone 2',
                'zone_3': 'Zone 3', 
                'zone_4': 'Zone 4',
                'zone_5': 'Zone 5'
            };
            return names[filter] || filter;
        }

        // EXACT SAME SERVICE REQUEST AS DESKTOP
        async function makeServiceRequest(action, params = {}) {
            const requestParams = {
                action: action,
                ...params
            };
            
            const url = EMAIL_SERVICE_URL + '?' + new URLSearchParams(requestParams).toString();
            
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                const callbackName = 'emailServiceCallback_' + Date.now();
                
                window[callbackName] = function(data) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    resolve(data);
                };
                
                script.src = url + '&callback=' + callbackName;
                script.onerror = () => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    reject(new Error('Failed to connect to email service'));
                };
                
                document.body.appendChild(script);
                
                setTimeout(() => {
                    if (window[callbackName]) {
                        delete window[callbackName];
                        document.body.removeChild(script);
                        reject(new Error('Email service request timeout'));
                    }
                }, 10000);
            });
        }

        function showSendingState(sending) {
            const button = document.getElementById('sendEmailBtn');
            const buttonText = document.getElementById('sendButtonText');
            
            if (sending) {
                button.disabled = true;
                buttonText.textContent = '🔄 Sending...';
                document.body.classList.add('loading');
            } else {
                button.disabled = false;
                buttonText.textContent = '📧 Send Alert';
                document.body.classList.remove('loading');
            }
        }

        function resetForm() {
            selectedTemplate = null;
            document.querySelectorAll('.template-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById('previewPanel').style.display = 'none';
            document.getElementById('sendEmailBtn').disabled = true;
        }

        function showSuccess(message) {
            showNotification(message, 'success');
        }

        function showError(message) {
            showNotification(message, 'error');
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 4000);
        }

        console.log('🚨 Mobile Field Alerts - Using proven desktop email service');
    </script>
</body>
</html>
